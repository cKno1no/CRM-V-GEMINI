{% extends "base.html" %}

{% block title %}Duyệt Đơn Hàng Bán (DHB) | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* --- CUSTOM LAYOUT --- */
    .table-approval { width: 100%; border-collapse: separate; border-spacing: 0; }
    
    .table-approval th { 
        position: sticky; top: 0; z-index: 10; 
        background-color: var(--input-bg) !important; 
        color: var(--secondary) !important; 
        font-weight: 700; font-size: 0.8rem; text-transform: uppercase;
        border-bottom: 2px solid var(--border-color); text-align: center;
        padding: 12px 8px; white-space: nowrap;
    }
    
    .table-approval td { 
        vertical-align: middle; font-size: 0.9rem; 
        border-bottom: 1px solid var(--border-color);
        padding: 10px 8px; color: var(--text-dark);
    }
    
    /* Hover & Selection */
    .quote-row { transition: background-color 0.1s; cursor: pointer; }
    .quote-row:hover td { background-color: var(--input-bg) !important; }
    .row-selected td { 
        background-color: var(--input-bg) !important; font-weight: 700; color: var(--primary);
    }
    
    /* Status Colors */
    .status-fail { border-left: 5px solid var(--danger) !important; } 
    .status-pass { border-left: 5px solid var(--success) !important; } 
    .status-pending { border-left: 5px solid var(--warning) !important; }
    .ratio-alert { color: var(--danger) !important; font-weight: 800; }

    /* Layout Scrolling */
    .master-table-scroll { overflow-y: auto; max-height: 75vh; border: 1px solid var(--border-color); border-radius: 12px; }

    /* Modal Detail Table */
    .table-detail th {
        background-color: var(--primary) !important; color: white !important;
        font-size: 0.8rem; text-align: center; border: 1px solid var(--primary); white-space: nowrap;
        padding: 8px;
    }
    .table-detail td { 
        border: 1px solid var(--border-color); vertical-align: middle; padding: 8px; 
    }
    
    /* Filter Inputs */
    .form-control { border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--text-dark); border-radius: 12px; }
    .form-control:focus { background-color: var(--card-bg); border-color: var(--primary); box-shadow: none; }
    
    /* Modal Styling */
    .modal-content { border-radius: 20px; border: none; overflow: hidden; }
    .modal-header { background-color: var(--input-bg); border-bottom: 1px solid var(--border-color); padding: 15px 20px; }
    .modal-title { font-weight: 700; color: var(--text-dark); }
    .modal-body { padding: 0; background-color: var(--card-bg); }
    .modal-footer { padding: 10px 20px; background-color: var(--card-bg); border-top: 1px solid var(--border-color); }
</style>
{% endblock %}

{% block page_title %}<i class="fas fa-shipping-fast me-2"></i> PHÊ DUYỆT ĐƠN HÀNG BÁN{% endblock %}
{% block page_sub %}Các đơn hàng chờ duyệt để chuyển sang ERP{% endblock %}

{% block header_actions %}
<a href="{{ url_for('index') }}" class="btn btn-back"><i class="fas fa-home me-2"></i>Portal</a>
<a href="{{ url_for('approval_bp.quote_approval_dashboard') }}" target="_blank" class="btn btn-primary text-white shadow-sm">
    <i class="fas fa-file-signature me-2"></i>Duyệt Chào Giá
</a>
{% endblock %}

{% block content %}
    <div class="main-card mb-4">
        <div class="card-body-custom" style="padding: 20px;">
            <form method="POST" action="{{ url_for('approval_bp.sales_order_approval_dashboard') }}" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-muted text-uppercase">Từ Ngày</label>
                    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted text-uppercase">Đến Ngày</label>
                    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100 fw-bold"><i class="fas fa-filter me-2"></i> Lọc</button>
                </div>
                <div class="col-md-4 text-end">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0 border-secondary"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="customSearchInput" class="form-control border-start-0 ps-0" placeholder="Tìm Mã DHB, Khách hàng...">
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="main-card">
        <div class="card-header-custom d-flex justify-content-between align-items-center">
            <span><i class="fas fa-list-ul me-2 text-success"></i> DANH SÁCH ĐƠN HÀNG</span>
            <span class="badge bg-light text-dark border">{{ orders|length }} đơn hàng</span>
        </div>
        <div class="card-body-custom p-0">
            <div class="master-table-scroll">
                <table id="approval-dhb-table" class="table table-hover mb-0 table-approval">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Hệ số</th>           
                            <th>Mã DHB</th>
                            <th>Loại</th>
                            <th>Ngày</th>                           
                            <th class="text-start">Khách hàng</th>
                            <th>NVKD</th>            
                            <th class="text-end">Tổng GT</th>     
                            <th class="text-start">KẾT QUẢ KIỂM TRA</th>
                            <th style="width: 100px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        {% set result = order.ApprovalResult %}
                        {% set status = result.Passed %}
                        {% set approver_id = result.ApproverRequired %}
                        {% set row_class = 'status-pass' if status else ('status-pending' if 'PENDING' in result.Reason else 'status-fail') %}
                        
                        <tr id="master-{{ order.OrderID }}" 
                            class="quote-row {% if not status %} {{ row_class }} {% endif %}"
                            onclick="showDetails('{{ order.SOrderID }}', '{{ order.OrderID }}', this)"
                            data-orderid="{{ order.OrderID }}"
                            data-sorderid="{{ order.SOrderID }}"
                            data-clientid="{{ order.ClientID }}"
                            data-salesmanid="{{ order.SalesManID }}"
                            data-ratio="{{ result.ApprovalRatio | safe }}"> 
                            
                            <td class="text-end">
                                <span class="fw-bold {% if result.ApprovalRatio < 138 %} ratio-alert {% endif %}">
                                    {{ result.ApprovalRatio }}
                                </span>
                            </td>
                            
                            <td class="fw-bold text-primary">{{ order.OrderID }}</td>
                            <td class="text-center small">{{ order.VoucherTypeID }}</td>
                            <td class="text-center small">{{ order.OrderDate | format_date }}</td>
                            <td class="text-start text-truncate" style="max-width: 250px;" title="{{ order.ClientName }}">{{ order.ClientName | default('N/A') }}</td>
                            <td class="text-center small">{{ order.NVKDName | default(order.SalesManID) }}</td>
                            
                            <td class="text-end fw-bold text-dark">{{ order.SaleAmount | format_tr }}</td>
                            
                            <td class="text-start small text-truncate" style="max-width: 300px;" title="{{ result.Reason }}">{{ result.Reason }}</td>
                            
                            <td class="text-center">
                                {% if status and current_user_code in approver_id %}
                                    <button class="btn btn-success btn-sm shadow-sm px-3" onclick="event.stopPropagation(); approveOrder(this)">
                                        <i class="fas fa-check"></i> Duyệt
                                    </button>
                                {% elif current_user_code in approver_id and 'FAILED' in result.Reason %}
                                    <span class="badge bg-danger">Lỗi</span>
                                {% elif result.ApproverDisplay == 'TỰ DUYỆT (SELF - DTK < 100M)' %}
                                    <span class="badge bg-success"><i class="fas fa-check-double me-1"></i> Tự duyệt</span>
                                {% else %}
                                    <span class="badge bg-light text-muted border">Chờ {{ result.ApproverDisplay }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2 text-primary"></i> Chi tiết Đơn hàng: <span id="modalOrderTitle" class="text-primary fw-bold">...</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detail-container" class="p-0">
                        <div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Đang tải dữ liệu...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.js"></script>
    
    <script>
        let currentOrderId = null;
        let lastClickedRow = null;
        const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));

        /**
         * HÀM ĐỊNH DẠNG SỐ AN TOÀN (FIX LỖI NaN)
         * - Loại bỏ dấu phẩy có sẵn trong dữ liệu (ví dụ: "10,000" -> "10000")
         * - Parse sang số thực
         * - Format lại theo chuẩn Mỹ (10,000)
         */
        function formatNumberStandard(value) {
            if (value === null || value === undefined || String(value).trim() === '') {
                return '0';
            }
            // Xóa dấu phẩy cũ trước khi xử lý
            const cleanValue = String(value).replace(/,/g, '');
            const num = parseFloat(cleanValue);
            
            if (isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US').format(num);
        }

        function renderDetailTable(details, container) {
            let tableHtml = '<div class="table-responsive"><table class="table table-striped table-bordered mb-0 table-detail">';
            tableHtml += '<thead><tr><th class="text-center">Mã hàng</th><th>Tên hàng</th><th class="text-end">SL</th><th class="text-end">Đơn giá</th><th class="text-end">Đơn giá QĐ</th><th class="text-end">Thành tiền</th></tr></thead><tbody>';

            if (!details || details.length === 0) {
                tableHtml += '<tr><td colspan="6" class="text-center text-muted">Không có dữ liệu chi tiết.</td></tr>';
            } else {
                details.forEach(item => {
                    // 1. Lấy giá trị thô (Raw) để so sánh màu sắc
                    const rawDonGia = parseFloat(String(item.DonGia || 0).replace(/,/g, ''));
                    const rawDonGiaQD = parseFloat(String(item.DonGiaQuyDinh || 0).replace(/,/g, ''));

                    // 2. Logic tô màu: Giá bán < Giá quy định -> Đỏ
                    const price_ratio_color = (rawDonGia < rawDonGiaQD) ? 'text-danger fw-bold' : 'text-success';
                    
                    // 3. Render HTML với hàm format an toàn
                    tableHtml += `<tr>
                        <td class="text-center font-monospace">${item.MaHang || ''}</td> 
                        <td>${item.TenHang || '—'}</td>
                        <td class="text-end">${formatNumberStandard(item.SoLuong)}</td>
                        <td class="text-end">${formatNumberStandard(item.DonGia)}</td>
                        <td class="text-end ${price_ratio_color}">${formatNumberStandard(item.DonGiaQuyDinh)}</td> 
                        <td class="text-end fw-bold">${formatNumberStandard(item.ThanhTien)}</td>
                    </tr>`;
                });
            }
            tableHtml += '</tbody></table></div>';
            container.innerHTML = tableHtml;
        }

        // Cập nhật hàm showDetails để mở Modal
        function showDetails(sOrderId, orderIdDisplay, rowElement) {
            if (lastClickedRow) $(lastClickedRow).removeClass('row-selected');
            
            lastClickedRow = rowElement;
            $(rowElement).addClass('row-selected');
            
            // Cập nhật tiêu đề Modal và hiển thị Loading
            $('#modalOrderTitle').text(orderIdDisplay);
            const container = document.getElementById('detail-container');
            container.innerHTML = '<div class="d-flex flex-column align-items-center justify-content-center py-5 text-muted"><i class="fas fa-spinner fa-spin fa-2x mb-3 text-primary"></i><p>Đang tải dữ liệu...</p></div>';
            
            detailModal.show();

            // Fetch data
            fetch(`/api/get_order_details/${sOrderId}`)
            .then(response => response.json())
            .then(details => {
                if (details.error) throw new Error(details.error);
                renderDetailTable(details, container);
            })
            .catch(error => {
                console.error(error);
                container.innerHTML = `<div class="alert alert-danger m-3 text-center"><i class="fas fa-exclamation-triangle me-2"></i> LỖI: ${error.message}</div>`;
            });
        }
        
        function approveOrder(buttonElement) {
            const row = $(buttonElement).closest('tr');
            
            // Lấy dữ liệu từ data attributes
            const orderId = row.data('orderid');
            const sOrderId = row.data('sorderid');
            const clientId = row.data('clientid');
            const salesmanId = row.data('salesmanid');
            const ratio = row.data('ratio');

            if (!confirm(`Xác nhận duyệt Đơn hàng ${orderId}? Dữ liệu sẽ được chuyển sang ERP.`)) return;
            
            // Disable nút và hiện loading
            buttonElement.disabled = true;
            $(buttonElement).html('<i class="fas fa-spinner fa-spin"></i>');

            fetch('/api/approve_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    order_id: orderId, 
                    sorder_id: sOrderId,
                    client_id: clientId,
                    salesman_id: salesmanId,
                    approval_ratio: parseFloat(ratio) 
                }),
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    // Xóa dòng khỏi bảng
                    $('#approval-dhb-table').DataTable().row(row).remove().draw();
                } else {
                    alert(`LỖI DUYỆT: ${result.message}`);
                    buttonElement.disabled = false;
                    $(buttonElement).html('<i class="fas fa-check"></i>');
                }
            })
            .catch(error => {
                alert('Lỗi kết nối hoặc xử lý API: ' + error.message);
                buttonElement.disabled = false;
                $(buttonElement).html('<i class="fas fa-check"></i>');
            });
        }

        $(document).ready(function() {
            // Init DataTables
            const table = $('#approval-dhb-table').DataTable({
                "paging": true, "pageLength": 50, "searching": true, "info": true,
                "scrollY": "70vh", "scrollCollapse": true, "dom": 'rtp',
                "language": { 
                    "paginate": { "next": ">", "previous": "<" },
                    "zeroRecords": "Không có dữ liệu phù hợp."
                }
            });

            // Custom Search Box
            $('#customSearchInput').on('keyup', function() { table.search(this.value).draw(); });
        });
    </script>
{% endblock %}