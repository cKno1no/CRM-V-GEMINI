<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Duyệt Đơn Hàng Bán (DHB)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.css"/>
    <style>
        /* CSS tương tự như quote_approval, điều chỉnh màu sắc và bố cục cột */
        body { font-family: 'Roboto', sans-serif; background-color: #F7F9FC; color: #3C4043; overflow-x: hidden; }
        .container-fluid { max-width: 98%; margin-top: 30px; }
        h1 { font-weight: 700; color: #34A853; border-bottom: 3px solid #E6F4EA; padding-bottom: 10px; margin-bottom: 25px; } /* Xanh lá cho DHB */
        
        /* Layout Master-Detail */
        .master-panel { 
            position: sticky; 
            max-height: 85vh; 
            overflow-y: auto; 
            padding-right: 15px;
            padding-left: 15px;
            padding-top: 15px;
        }
        .detail-panel {
            position: sticky; 
            top: 15px; 
            max-height: 85vh;
            overflow-y: auto;
        }
        
        /* Thẩm mỹ Bảng */
        .table-approval th { 
            background-color: #34A853 !important; /* MÀU HEADER: Xanh lá đậm */
            color: white; 
            font-weight: 600; 
            font-size: 0.9rem; 
            position: sticky; top: 0; z-index: 10; 
            white-space: nowrap; vertical-align: middle; border: 1px solid #dee2e6;
            text-align: center; 
        }
        .table-approval td { 
            vertical-align: middle; font-size: 0.85rem; border: 1px solid #dee2e6;
            font-weight: normal; 
        }
        .quote-row:hover { cursor: pointer; background-color: #E6F4EA !important; } /* Xanh lá nhạt khi hover */
        .row-selected { background-color: #A8DCD2 !important; font-weight: bold; } /* Xanh lá đậm hơn khi chọn */
        
        /* Màu và Căn chỉnh */
        .status-pass { background-color: #E6F4EA; color: #1E8E3E; font-weight: 600; } 
        .status-fail { background-color: #FCE8E6 !important; color: #DB4437 !important; font-weight: 600; } /* Đỏ nhạt cho lỗi cứng */
        .status-pending { background-color: #FFF7E6; color: #F4B400; font-weight: 600; } /* Vàng nhạt cho chờ duyệt */
        .ratio-alert { color: #DB4437; font-weight: 700; }
        
        /* CỘT CĂN CHỈNH */
        .col-ratio { width: 5%; }
        .col-nvkd { width: 5%; text-align: center; } 
        .col-vtype { width: 5%; text-align: center; } /* Cột loại chứng từ */
        .col-gt { width: 10%; }
        .col-result { width: 25%; }
        .col-client { width: 20%; text-align: left !important; }
        
        /* CSS cho bảng DETAIL */
        .table-detail th {
            background-color: #4285F4 !important; /* Xanh Google cho Detail */
            color: white;
            font-size: 0.8rem;
            text-align: center;
            border: 1px solid #dee2e6;
            white-space: nowrap;
        }
        .table-detail td {
            font-size: 0.8rem;
            text-align: center;
        }

        /* Nút Header */
        .btn-header-action {
            font-weight: 600;
            padding: 8px 15px; 
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-shipping-fast me-2"></i> PHÊ DUYỆT ĐƠN HÀNG BÁN CẦN KIỂM SOÁT</h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('index') }}" class="btn btn-secondary btn-header-action">
                    <i class="fas fa-home me-1"></i> Về Portal
                </a>
                <a href="{{ url_for('approval_bp.quote_approval_dashboard') }}" target="_blank" class="btn btn-primary btn-header-action">
                    <i class="fas fa-file-signature me-1"></i> Duyệt Chào Giá
                </a>
            </div>
        </div>
        <p class="text-muted">Mặc định hiển thị **Đơn hàng chưa duyệt trong 7 ngày gần nhất**. Click vào Mã DHB để xem chi tiết mặt hàng.</p>

        <div class="card mb-3">
            <div class="card-body">
                <form method="POST" action="{{ url_for('approval_bp.sales_order_approval_dashboard') }}" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="date_from" class="form-label small text-muted">Từ Ngày DHB</label>
                        <input type="date" name="date_from" id="date_from" class="form-control" 
                                value="{{ date_from }}">
                    </div>

                    <div class="col-md-3">
                        <label for="date_to" class="form-label small text-muted">Đến Ngày DHB</label>
                        <input type="date" name="date_to" id="date_to" class="form-control" 
                                value="{{ date_to }}">
                    </div>
                    
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i> Lọc Ngày
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="row g-3">
            <div class="col-lg-7">
                <div class="card master-panel">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0 text-success"><i class="fas fa-list-ul me-2"></i> DANH SÁCH ĐƠN HÀNG BÁN</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="approval-dhb-table" class="table table-hover mb-3 table-approval">
                                <thead>
                                    <tr>
                                        <th class="col-ratio">Hệ số</th>           
                                        <th>Mã DHB</th>
                                        <th class="col-vtype">Loại</th>
                                        <th>Ngày DHB</th>                           
                                        <th class="col-client">Khách hàng</th>
                                        <th class="col-nvkd">NVKD</th>            
                                        <th class="col-gt">Tổng GT (VNĐ)</th>     
                                        <th>KẾT QUẢ KIỂM TRA</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in orders %}
                                    {% set result = order.ApprovalResult %}
                                    {% set status = result.Passed %}
                                    {% set approver_id = result.ApproverRequired %}
                                    {% set row_class = 'status-pass' if status else ('status-pending' if 'PENDING' in result.Reason else 'status-fail') %}
                                    
                                    <tr id="master-{{ order.OrderID }}" 
                                        class="quote-row {% if not status %} {{ row_class }} {% endif %}"
                                        onclick="showDetails('{{ order.SOrderID }}', this)"
                                        data-orderid="{{ order.OrderID }}"
                                        data-sorderid="{{ order.SOrderID }}"
                                        data-clientid="{{ order.ClientID }}"
                                        data-salesmanid="{{ order.SalesManID }}"
                                        data-ratio="{{ result.ApprovalRatio | safe }}"> 
                                        
                                        <td class="text-end col-ratio">
                                            <span class="fw-bold {% if result.ApprovalRatio < 138 %} ratio-alert {% endif %}">
                                                {{ result.ApprovalRatio }}
                                            </span>
                                        </td>
                                        
                                        <td>{{ order.OrderID }}</td>
                                        <td class="col-vtype">{{ order.VoucherTypeID }}</td>
                                        
                                        <td>
                                            {% if order.OrderDate %}
                                                {{ order.OrderDate.strftime('%d/%m') }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        
                                        <td class="col-client text-start">{{ order.ClientName | default('N/A') }}</td>
                                        
                                        <td class="col-nvkd">{{ order.NVKDName | default(order.SalesManID) }}</td>
                                        
                                        <td class="text-end col-gt">{{ "{:,.0f}".format(order.SaleAmount | float) }}</td>
                                        
                                        <td class="col-result">
                                            {{ result.Reason }}
                                        </td>
                                        
                                        <td>
                                            {% if status and current_user_code in approver_id %}
                                                <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); approveOrder(this)">
                                                    <i class="fas fa-check"></i> Duyệt
                                                </button>
                                            {% elif current_user_code in approver_id and 'FAILED' in result.Reason %}
                                                <button class="btn btn-danger btn-sm" disabled>
                                                    <i class="fas fa-times"></i> Cần sửa lỗi
                                                </button>
                                            {% elif result.ApproverDisplay == 'TỰ DUYỆT (SELF - DTK < 100M)' %}
                                                <span class="text-success small">Đã Tự Duyệt</span>
                                            {% else %}
                                                <span class="text-muted small">Chờ {{ result.ApproverDisplay }}</span>
                                            {% endif %}
                                        </td>
                                        </tr>
                                    {% endfor %}
                                    {% if not orders %}
                                    <tr><td colspan="9" class="text-center text-muted">Không có đơn hàng nào cần duyệt.</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card detail-panel">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0 text-primary"><i class="fas fa-info-circle me-2"></i> CHI TIẾT MẶT HÀNG</h5>
                    </div>
                    <div class="card-body p-0" id="detail-container">
                        <p class="p-3 text-muted text-center">Click vào một Đơn hàng Bán trong bảng bên trái để xem chi tiết mặt hàng.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.js"></script>
    
    <script>
        let currentOrderId = null;
        let lastClickedRow = null;

        // Hàm định dạng tiền tệ (cần thiết cho Detail Rendering)
        function formatCurrency(value) {
            if (value === null || value === undefined || value === '—' || String(value).trim() === '') return '—';
            // Đảm bảo loại bỏ dấu phẩy trước khi parse float
            const num = parseFloat(String(value).replace(/,/g, '')); 
            if (isNaN(num)) return '—';
            return num.toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }


        function renderDetailTable(details, container) {
            let tableHtml = '<div class="table-responsive p-3"><table class="table table-sm table-striped table-bordered small mb-0 table-detail">';
            tableHtml += '<thead style="background-color: #34A853; color: white;"><tr>'; // Xanh lá cho header detail
            
            // Header chi tiết DHB
            tableHtml += '<th class="text-center">Mã hàng</th><th>Tên hàng</th><th class="text-end">SL</th>';
            tableHtml += '<th class="text-end">Đơn giá</th><th class="text-end">Đơn giá QĐ</th>';
            tableHtml += '<th>Date 01</th><th>Mã BG</th><th class="text-end">Thành tiền</th></tr></thead><tbody>';

            details.forEach(item => {
                // Sử dụng hàm formatCurrency cho việc hiển thị
                const DonGiaQuyDinh_raw = String(item.DonGiaQuyDinh).replace(/,/g, '');
                const DonGia_raw = String(item.DonGia).replace(/,/g, '');
                
                const price_ratio_color = (parseFloat(DonGia_raw) < parseFloat(DonGiaQuyDinh_raw)) ? 'text-danger' : 'text-success';
                const date01_color = (item.Date01 === 'N/A') ? 'text-danger fw-bold' : '';
                const ma_bg_color = (item.MaBaoGia === null || item.MaBaoGia === '') ? 'text-danger fw-bold' : '';

                tableHtml += '<tr>';
                tableHtml += `<td class="text-center">${item.MaHang}</td>`; 
                tableHtml += `<td class="text-start">${item.TenHang || '—'}</td>`;
                tableHtml += `<td class="text-end">${item.SoLuong}</td>`;
                tableHtml += `<td class="text-end">${item.DonGia}</td>`;
                tableHtml += `<td class="text-end ${price_ratio_color}">${item.DonGiaQuyDinh}</td>`; 
                tableHtml += `<td class="text-center ${date01_color}">${item.Date01}</td>`;
                tableHtml += `<td class="text-center ${ma_bg_color}">${item.MaBaoGia || '—'}</td>`;
                tableHtml += `<td class="text-end fw-bold">${item.ThanhTien}</td>`;
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table></div>';
            container.innerHTML = tableHtml;
        }

        function showDetails(orderId, rowElement) {
            if (lastClickedRow) {
                lastClickedRow.classList.remove('row-selected');
            }

            if (currentOrderId === orderId) {
                currentOrderId = null;
                document.getElementById('detail-container').innerHTML = '<p class="p-3 text-muted text-center">Click vào một Đơn hàng Bán trong bảng bên trái để xem chi tiết mặt hàng.</p>';
                return;
            }

            currentOrderId = orderId;
            lastClickedRow = rowElement;
            rowElement.classList.add('row-selected');

            const container = document.getElementById('detail-container');
            container.innerHTML = '<p class="p-3 text-center"><i class="fas fa-spinner fa-spin me-2"></i> Đang tải chi tiết...</p>';

            fetch(`/api/get_order_details/${orderId}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (!response.ok) throw new Error('Lỗi truy vấn chi tiết đơn hàng (HTTP ' + response.status + ')');
                return response.json();
            })
            .then(details => {
                if (details.error) throw new Error(details.error);
                renderDetailTable(details, container);
            })
            .catch(error => {
                container.innerHTML = `<p class="p-3 text-danger text-center"><i class="fas fa-times-circle me-2"></i> LỖI: ${error.message}</p>`;
                console.error(error);
            });
        }
        
        // HÀM DUYỆT ĐƠN HÀNG (Lấy data từ Data Attributes)
        function approveOrder(buttonElement) {
            const row = $(buttonElement).closest('tr');
            const orderId = row.data('orderid'); // MACT (VoucherNo)
            const sOrderId = row.data('sorderid'); // MasoCT (SOrderID)
            const clientId = row.data('clientid'); // MaKH
            const salesmanId = row.data('salesmanid'); // NGUOILAM
            const ratio = row.data('ratio'); // TySoDuyet

            if (!confirm(`Xác nhận duyệt Đơn hàng Bán ${orderId}? Dữ liệu sẽ được chuyển sang ERP!`)) { return; }
            
            buttonElement.disabled = true;
            $(buttonElement).html('<i class="fas fa-spinner fa-spin"></i>');

            fetch('/api/approve_order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    order_id: orderId, 
                    sorder_id: sOrderId,
                    client_id: clientId,
                    salesman_id: salesmanId,
                    approval_ratio: parseFloat(ratio) 
                }),
            })
            .then(response => {
                if (!response.ok) { 
                    return response.json().then(err => { throw new Error(err.message || 'Lỗi không xác định'); }); 
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    // Dùng DataTables để xóa hàng đã duyệt khỏi bảng
                    $('#approval-dhb-table').DataTable().row(row).remove().draw();
                    // window.location.reload(); // Không cần reload nếu dùng DataTables
                } else {
                    alert(`LỖI DUYỆT: ${result.message}`);
                    buttonElement.disabled = false;
                    $(buttonElement).html('<i class="fas fa-check"></i> Duyệt');
                }
            })
            .catch(error => {
                alert('Lỗi kết nối hoặc xử lý API: ' + error.message);
                buttonElement.disabled = false;
                $(buttonElement).html('<i class="fas fa-check"></i> Duyệt');
            });
        }

        // KHỞI TẠO DATATABLES
        $(document).ready(function() {
            if ($('#approval-dhb-table').length) {
                $('#approval-dhb-table').DataTable({
                    "paging": true,
                    "pageLength": 25,
                    "lengthChange": true,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "scrollY": "70vh", 
                    "scrollCollapse": true,
                    "order": [[3, 'asc']], // Order by OrderDate
                    "language": {
                        "lengthMenu": "Hiển thị _MENU_ mục",
                        "zeroRecords": "Không tìm thấy đơn hàng nào.",
                        "info": "Hiển thị từ _START_ đến _END_ trong tổng số _TOTAL_ mục",
                        "infoEmpty": "Không có dữ liệu",
                        "infoFiltered": "(lọc từ _MAX_ mục)",
                        "search": "Lọc nhanh:",
                        "paginate": {
                            "first": "Đầu",
                            "last": "Cuối",
                            "next": "Sau",
                            "previous": "Trước"
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>