<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập Liệu Nhân Sự Liên Hệ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #F8F9FA; color: #3C4043; }
        .container { max-width: 1200px; margin-top: 30px; }
        h1 { font-weight: 700; color: #007bff; border-bottom: 3px solid #007bff; padding-bottom: 10px; margin-bottom: 25px; } 

        .card { border: 1px solid #E0E0E0; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-radius: 8px; margin-bottom: 30px; }
        
        /* Màu Header */
        #contact-ref-card .card-header { 
            background-color: #346265 !important; 
            color: white !important; 
            font-weight: 600; 
            font-size: 1.2rem;
        }

        /* YÊU CẦU 4: MÀU HEADER CHI TIẾT (Xanh Dương như hình 1) */
        #detail-card .card-header {
            background-color: #E8F0FE; 
            color: #4285F4; 
            font-weight: 600; 
            font-size: 1.2rem;
        }
        
        .form-control-lg { padding: 0.5rem 1rem; }
        
        /* YÊU CẦU 4: MÀU XANH LÁ CHO LABEL */
        .form-label { color: #3C4043; } /* Mặc định */
        .highlight-label { color: #34A853 !important; font-weight: 600; } /* Xanh Lá Cây */

        /* Vùng tham chiếu nhân sự đã nhập */
        .reference-list {
            min-height: 250px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
        }
        .table-ref th { background-color: #E8F0FE; color: #4285F4; }

        /* Nút Lưu và Về Dashboard */
        .btn-save-custom {
            background-color: #34A853; 
            border-color: #34A853;
            font-weight: 600;
            min-width: 150px;
            color: white !important;
        }
        .btn-save-custom:hover {
            background-color: #2F834D;
            border-color: #2F834D;
        }
        .btn-secondary-custom {
            min-width: 150px;
            font-weight: 600;
        }
        
        /* Cần thiết cho Autocomplete */
        #kh_search_results { 
            width: 100%; 
            border-radius: 8px; 
            border-color: #4285F4;
            outline: none;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TẠO MỚI NHÂN SỰ LIÊN HỆ</h1>
        
        {% if message and 'success' in message %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Thành công!</strong> {{ message }}.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% elif message and 'error' in message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Lỗi!</strong> {{ message }}.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <form method="POST" action="/nhansu_nhaplieu">
            <div class="card mb-4" id="contact-ref-card">
                <div class="card-header">Liên hệ tới</div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Công ty</label>
                            
                            <input type="text" id="kh_ten_tat" placeholder="Gõ tên viết tắt hoặc Mã ĐT..." class="form-control form-control-lg"
                                   {% if default_ten_khachhang %} 
                                        value="{{ default_ten_khachhang }}" 
                                        readonly
                                   {% endif %}>
                            <small id="kh_status" class="form-text text-muted">Nhập tên để tìm kiếm tự động.</small>
                            <select id="kh_search_results" class="form-select mt-2" size="5" onchange="chonKhachHang()">
                            </select>
                            
                            <input type="hidden" name="ma_cong_ty_kh" id="kh_ma_doi_tuong" 
                                   value="{{ default_ma_khachhang or '' }}"
                                   {% if not default_ma_khachhang %} required {% endif %}>
                            
                            <h5 class="mt-3">Mã Đối tượng đã chọn: <span id="display_ma_dt" class="highlight-label">
                                {% if default_ma_khachhang %} {{ default_ma_khachhang }} {% else %} ... {% endif %}
                            </span></h5>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Chúng ta đã quen biết:</label>
                            <div class="reference-list mt-1">
                                <table class="table table-sm table-ref table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>Tên</th>
                                            <th>Chức vụ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="nhansu_ref_body">
                                        <tr><td colspan="2" class="text-center text-muted small">Vui lòng chọn Công ty để hiển thị nhân sự đã có.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="detail-card">
                <div class="card-header">Những hiểu biết của bạn</div>
                <div class="card-body">
                    <div class="row g-3">
                        
                        <div class="col-md-6 border-end">
                            
                            <div class="mb-3">
                                <label class="form-label highlight-label">Tên đầy đủ</label>
                                <input type="text" name="ten_ho" class="form-control" required placeholder="PHẢI là tên đầy đủ có họ tên">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tên thường gọi</label>
                                <input type="text" name="ten_thuong_goi" class="form-control" placeholder="Tên giao tiếp khi làm việc, xưng hô">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Chức vụ</label>
                                <input type="text" name="chuc_vu" class="form-control" placeholder="Chức vụ">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label highlight-label">Số ĐTDD 1</label>
                                <input type="text" name="so_dtdd_1" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="dia_chi_email" class="form-control">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">TK Cá nhân</label>
                                <textarea name="ghi_chu" class="form-control" rows="3" 
                                          placeholder="Tên TK, Mã số TK, Ngân hàng, ..."></textarea>
                            </div>
                        </div>

                        <div class="col-md-6">

                            <div class="mb-3">
                                <label class="form-label">Quê quán</label>
                                <select name="que_quan_ddl" id="que_quan_ddl" class="form-select">
                                    <option value="">-- Chọn Tỉnh/Thành phố --</option>
                                    </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Độ tuổi</label>
                                <input type="text" name="do_tuoi" class="form-control" placeholder="Độ tuổi (Không bắt buộc)">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Thâm niên tại nhà máy</label>
                                <input type="text" name="gia_dinh" class="form-control" placeholder="Thâm niên tại nhà máy (Không bắt buộc)">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">TT Cá nhân</label>
                                <textarea name="ghi_chu_dac_biet" class="form-control" rows="3" 
                                          placeholder="Những thông tin 'ngoài lề' về cá nhân: độ tuổi, gia đình, tính cách, quan điểm công việc, ..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="d-flex justify-content-center gap-3 mt-4 pb-5">
                <button type="submit" class="btn btn-primary btn-lg btn-save-custom">Lưu Nhân Sự Mới</button>
                <a href="/nhaplieu" class="btn btn-secondary btn-lg btn-secondary-custom">Quay lại Form Báo Cáo</a>
            </div>
        </form>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }
        
        // Hàm hiển thị danh sách Nhân sự đã nhập
        function displayReferencePersonnel(data) {
            const tbody = document.getElementById('nhansu_ref_body');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted small">Chưa có Nhân sự nào được nhập cho đối tượng này.</td></tr>';
                return;
            }
            
            data.forEach(p => {
                const row = tbody.insertRow();
                // CHÚ Ý: Tên cột là [TEN HO], [CHUC VU] (có khoảng trắng)
                row.insertCell().textContent = `${p['TEN HO']} (${p['TEN THUONG GOI'] || 'N/A'})`;
                row.insertCell().textContent = p['CHUC VU'] || 'N/A';
            });
        }

        // Hàm gọi API lấy danh sách nhân sự đã có (Bảng tham chiếu)
        function fetchReferencePersonnel(maDoiTuong) {
            const tbody = document.getElementById('nhansu_ref_body');
            tbody.innerHTML = '<tr><td colspan="2" class="text-center text-secondary small">Đang tải danh sách...</td></tr>';

            fetch(`/api/nhansu_by_khachhang/${maDoiTuong}`)
                .then(response => {
                    if (!response.ok) throw new Error('Lỗi Server khi tải danh sách Nhân sự.');
                    return response.json();
                })
                .then(data => {
                    displayReferencePersonnel(data);
                })
                .catch(error => {
                    tbody.innerHTML = `<tr><td colspan="2" class="text-center text-danger small">Lỗi: Không tải được danh sách.</td></tr>`;
                    console.error("Fetch Personnel Error:", error);
                });
        }
        
        // Hàm nạp dropdown Tỉnh Thành
        function loadTinhThanhDropdown() {
            const ddl = document.getElementById('que_quan_ddl');
            fetch('/api/tinh_thanh')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        data.forEach(tinh => {
                            const option = document.createElement('option');
                            option.value = tinh;
                            option.textContent = tinh;
                            ddl.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error("Lỗi tải Tỉnh thành:", error));
        }


        // Hàm gọi API và hiển thị 5 lựa chọn (Chỉ chạy khi readonly là FALSE)
        function timKhachHang() {
            const ten_tat_input = document.getElementById('kh_ten_tat');
            if (ten_tat_input.readOnly) return; // KHÔNG CHẠY NẾU LÀ READONLY

            const ten_tat = ten_tat_input.value.trim();
            const status_msg = document.getElementById('kh_status');
            const resultsDropdown = document.getElementById('kh_search_results');
            
            status_msg.textContent = 'Đang tìm kiếm...';
            resultsDropdown.style.display = 'none';
            resultsDropdown.innerHTML = '';


            if (ten_tat.length < 2) {
                status_msg.textContent = 'Nhập ít nhất 2 ký tự.';
                return;
            }

            fetch(`/api/khachhang/${ten_tat}`)
                .then(response => {
                    if (response.status === 404) { throw new Error('Không tìm thấy khách hàng.'); }
                    if (!response.ok) { throw new Error('Lỗi Server.'); }
                    return response.json(); 
                })
                .then(data => {
                    if (data && data.length > 0) {
                        data.forEach(kh => {
                            const option = document.createElement('option');
                            option.value = kh.ID; 
                            option.textContent = `${kh.FullName} (${kh.ID})`;
                            resultsDropdown.appendChild(option);
                        });
                        
                        resultsDropdown.style.display = 'block';
                        resultsDropdown.size = Math.min(data.length, 5); 
                        status_msg.textContent = `Tìm thấy ${data.length} kết quả. Vui lòng chọn.`;
                        
                        if (data.length === 1) {
                             resultsDropdown.selectedIndex = 0;
                             chonKhachHang();
                        }
                    } else {
                        status_msg.textContent = 'Không tìm thấy kết quả nào.';
                    }
                })
                .catch(error => {
                    status_msg.textContent = `Lỗi tra cứu: ${error.message}`;
                });
        }
        
        // Hàm xử lý khi người dùng chọn từ dropdown (Chỉ áp dụng khi KHÔNG phải readonly)
        function chonKhachHang() {
            const ten_tat_input = document.getElementById('kh_ten_tat');
            if (ten_tat_input.readOnly) return; 

            const resultsDropdown = document.getElementById('kh_search_results');
            if (resultsDropdown.selectedIndex === -1) { return; }
            
            const selectedOption = resultsDropdown.options[resultsDropdown.selectedIndex];
            
            const ma_doi_tuong_field = document.getElementById('kh_ma_doi_tuong');
            const maDoiTuongDisplay = document.getElementById('display_ma_dt');

            if (selectedOption) {
                const maDoiTuong = selectedOption.value;

                ma_doi_tuong_field.value = maDoiTuong;
                maDoiTuongDisplay.textContent = maDoiTuong;
                
                // GỌI API ĐỂ TẢI DANH SÁCH NHÂN SỰ ĐÃ CÓ
                fetchReferencePersonnel(maDoiTuong);

                document.getElementById('kh_status').textContent = '✅ Khách hàng đã được chọn và xác nhận.';
            }
        }
        
        // Hàm kích hoạt tải dữ liệu khi trang được mở với mã mặc định
        function initializeDefaultKhachHang() {
            const maDoiTuong = document.getElementById('kh_ma_doi_tuong').value;
            const tenTatInput = document.getElementById('kh_ten_tat');

            if (maDoiTuong.trim() !== '') {
                // Tải danh sách tham chiếu và cập nhật bảng nhân sự
                fetchReferencePersonnel(maDoiTuong);
                
                // Cập nhật trạng thái hiển thị
                document.getElementById('kh_status').textContent = 'Khách hàng được gán mặc định từ form báo cáo.';
                
                // Ẩn dropdown kết quả (nếu nó hiển thị)
                document.getElementById('kh_search_results').style.display = 'none';

            } else {
                 // Nếu không có mã, đảm bảo form là rỗng và cho phép tìm kiếm
                 tenTatInput.readOnly = false;
                 document.getElementById('kh_status').textContent = 'Nhập tên để tìm kiếm tự động.';
            }
        }


        // === ĐĂNG KÝ SỰ KIỆN CHÍNH ===
        document.addEventListener('DOMContentLoaded', function() {
            const tenTatInput = document.getElementById('kh_ten_tat');
            const resultsDropdown = document.getElementById('kh_search_results');
            
            loadTinhThanhDropdown();
            
            // 1. Logic Tải/Khóa khi có mã mặc định
            initializeDefaultKhachHang();
            
            // 2. Kích hoạt lại Autocomplete cho trường hợp không có default code (hoặc sau khi xóa)
            tenTatInput.addEventListener('input', debounce(function() {
                timKhachHang();
            }, 300)); 

            tenTatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !tenTatInput.readOnly) {
                    e.preventDefault(); 
                    timKhachHang();
                }
            });

            resultsDropdown.addEventListener('change', chonKhachHang);
        });

    </script>
</body>
</html>