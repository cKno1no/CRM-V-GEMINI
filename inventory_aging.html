<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Phân tích Tồn kho & Tuổi hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* ================================================= */
        /* CSS CHỦ ĐẠO POWER BI/LOOKER STUDIO */
        /* ================================================= */
        body { 
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #F7F9FC; 
            color: #3C4043; 
        }
        .container-fluid { max-width: 98%; margin-top: 30px; }
        h1 { 
            font-weight: 700; 
            color: #DB4437; 
            border-bottom: 3px solid #F4B400; 
            padding-bottom: 10px; 
            margin-bottom: 25px; 
        }
        .card { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            border-radius: 12px; 
            border: none;
            background-color: white;
        }

        /* KPI Tiles */
        .kpi-tile {
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
            min-height: 120px; 
        }
        .kpi-label { font-size: 0.9rem; font-weight: 500; opacity: 0.9; margin-bottom: 5px; }
        .kpi-value { font-size: 2rem; font-weight: 700; line-height: 1.1; }
        
        /* Màu Sắc Chiến Lược */
        .bg-inventory-total { background-color: #1A73E8; }
        .bg-inventory-new { background-color: #34A853; }
        .bg-inventory-risk { background-color: #DB4437; }

        /* Bảng Phân tích */
        .table-aging th { 
            /* FIX: CỐ ĐỊNH TIÊU ĐỀ KHI CUỘN */
            position: sticky !important; 
            top: 0 !important; 
            z-index: 10; 
            
            background-color: #1A73E8 !important; 
            color: white !important; 
            font-weight: 600; 
            text-align: center !important; 
            font-size: 0.8rem;
        }
        .table-aging td { vertical-align: middle; text-align: right; font-size: 0.85rem; }
        .text-start { text-align: left !important; }
        .text-center { text-align: center !important; }

        /* Aging Buckets Styling: Bỏ in đậm, font màu đen */
        .aging-group { border-left: 1px solid #ccc; padding-left: 5px; background-color: transparent !important; } 
        .aging-value { font-weight: normal; color: black !important; }
        .aging-qty { font-weight: normal; color: #70757A; font-size: 0.75rem; display: block; margin-top: 2px;}

        /* FIX: Giá trị Tổng tồn hiện tại (Màu Cam) */
        .total-value-font { color: #FF9800 !important; font-weight: 700; } 
        .risk-720-text { color: #DB4437; font-weight: 600; }
        .risk-540-720-text { color: #F4B400; }
        
        /* Cấu trúc cột */
        .table-aging { table-layout: fixed; width: 100%; }
        .col-sku { width: 8%; }
        .col-name { width: 25%; }
        .col-class { width: 5%; } 
        .col-value-total { width: 10%; } 
        .col-aging-bucket { width: 9%; }
        .col-d-risk { width: 8%; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-warehouse me-2"></i> PHÂN TÍCH TUỔI HÀNG TỒN KHO</h1>
            <a href="/" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Về Dashboard Báo Cáo</a>
        </div>

        <div class="row g-4 mb-4">
            
            <div class="col-lg-3 col-md-6">
                <div class="kpi-tile bg-inventory-total">
                    <div class="kpi-label">TỔNG TỒN</div>
                    <div class="kpi-value">{{ "{:,.0f}".format(kpi_total_inventory | default(0) | float) }}</div>
                    <div class="kpi-unit">Triệu VNĐ | SL: {{ "{:,.0f}".format(kpi_total_quantity | default(0) | float) }}</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-tile bg-inventory-new">
                    <div class="kpi-label">GIÁ TRỊ TỒN KHO MỚI (< 6 THÁNG)</div>
                    <div class="kpi-value">{{ "{:,.0f}".format(kpi_new_6_months | default(0) | float) }}</div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <div class="kpi-tile bg-orders" style="background-color: #673AB7;">
                    <div class="kpi-label">GIÁ TRỊ CLC MỚI (KHÔNG CẦN DUY TRÌ)</div>
                    <div class="kpi-value">{{ "{:,.0f}".format(kpi_clc_value | default(0) | float) }}</div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-tile bg-inventory-risk">
                    <div class="kpi-label">GIÁ TRỊ TỒN KHO RỦI RO (> 2 NĂM)</div>
                    <div class="kpi-value">{{ "{:,.0f}".format(kpi_over_2_years | default(0) | float) }}</div>
                    <div class="kpi-unit">Triệu VNĐ</div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" action="/inventory_aging" class="row g-3 align-items-end">
                    
                    <div class="col-md-2">
                        <label for="item_filter" class="form-label small text-muted">Mã hàng (SKU) / Tên hàng</label>
                        <input type="text" name="item_filter" id="item_filter" class="form-control" 
                                value="{{ item_filter_term | default('') }}" placeholder="Mã A; Mã B; Tên (ngăn cách bằng ;)">
                    </div>

                    <div class="col-md-2">
                         <label for="category_filter" class="form-label small text-muted">Ngành hàng (I02ID)</label>
                         <input type="text" name="category_filter" id="category_filter" class="form-control" 
                                value="{{ category_filter | default('') }}" placeholder="Ví dụ: BẠC ĐẠN">
                    </div>
                    
                    <div class="col-md-2">
                         <label for="i05id_filter" class="form-label small text-muted">Tính chất (I05ID)</label>
                         <input type="text" name="i05id_filter" id="i05id_filter" class="form-control" 
                                value="{{ i05id_filter | default('') }}" placeholder="S, A, B, C, D...">
                    </div>

                    <div class="col-md-2">
                         <label for="qty_filter" class="form-label small text-muted">Lọc SL Tồn</label>
                         <input type="text" name="qty_filter" id="qty_filter" class="form-control" 
                                value="{{ qty_filter | default('') }}" placeholder="Ví dụ: >100 hoặc =0">
                    </div>
                    
                    <div class="col-md-2">
                         <label for="value_filter" class="form-label small text-muted">Lọc Giá trị Tồn</label>
                         <input type="text" name="value_filter" id="value_filter" class="form-control" 
                                value="{{ value_filter | default('') }}" placeholder="Ví dụ: <50000000">
                    </div>


                    <div class="col-md-1">
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="fas fa-search me-1"></i> Lọc
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card" style="background-color: white;">
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 80vh; overflow-y: auto;">
                    <table class="table table-sm table-bordered table-hover mb-0 table-aging">
                        <thead>
                            <tr>
                                <th class="col-sku text-start">Mã Hàng</th>
                                <th class="col-name text-start">Tên Hàng / Ngành hàng</th>
                                <th class="col-class text-center">Tính chất</th>
                                <th class="col-value-total">Tổng Tồn</th>
                                <th class="col-aging-bucket">0 - 180 ngày</th>
                                <th class="col-aging-bucket">181 - 360 ngày</th>
                                <th class="col-aging-bucket">361 - 540 ngày</th>
                                <th class="col-aging-bucket">541 - 720 ngày</th>
                                <th class="col-aging-bucket">> 720 ngày (Rủi ro)</th>
                                <th class="col-d-risk">Cột D (Rủi ro > 5M)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in aging_data %}
                            {% set over_720_v = row.Range_Over_720_V | default(0) | float %}
                            {% set stock_class = row.StockClass | default('') %}
                            {% set risk_clc_v = row.Risk_CLC_Value | default(0) | float %}
                            
                            <tr>
                                <td class="col-sku text-start {% if over_720_v > 0 %} risk-720-text {% endif %}">{{ row.InventoryID }}</td>
                                <td class="col-name text-start">
                                    {{ row.InventoryName | default('N/A') }} 
                                    <span class="text-muted d-block" style="font-size: 0.75rem;">[{{ row.InventoryTypeName | default(row.ItemCategory) }}]</span>
                                </td>
                                <td class="col-class text-center">{{ stock_class }}</td> 
                                <td class="col-value-total aging-group">
                                    <span class="total-value-font">{{ "{:,.0f}".format(row.TotalCurrentValue | default(0) | float) }}</span>
                                    <span class="aging-qty">SL: {{ "{:,.0f}".format(row.TotalCurrentQuantity | default(0) | float) }}</span>
                                </td>
                                
                                <td class="col-aging-bucket aging-group">
                                    <span class="aging-value">{{ "{:,.0f}".format(row.Range_0_180_V | default(0) | float) }}</span>
                                    <span class="aging-qty">SL: {{ "{:,.0f}".format(row.Range_0_180_Q | default(0) | float) }}</span>
                                </td>
                                
                                <td class="col-aging-bucket aging-group">
                                    <span class="aging-value">{{ "{:,.0f}".format(row.Range_181_360_V | default(0) | float) }}</span>
                                    <span class="aging-qty">SL: {{ "{:,.0f}".format(row.Range_181_360_Q | default(0) | float) }}</span>
                                </td>
                                
                                <td class="col-aging-bucket aging-group">
                                    <span class="aging-value {% if row.Range_361_540_V | float > 0 %} risk-540-720-text {% endif %}">{{ "{:,.0f}".format(row.Range_361_540_V | default(0) | float) }}</span>
                                    <span class="aging-qty">SL: {{ "{:,.0f}".format(row.Range_361_540_Q | default(0) | float) }}</span>
                                </td>
                                
                                <td class="col-aging-bucket aging-group">
                                    <span class="aging-value {% if row.Range_541_720_V | float > 0 %} risk-over-720-text {% endif %}">{{ "{:,.0f}".format(row.Range_541_720_V | default(0) | float) }}</span>
                                    <span class="aging-qty">SL: {{ "{:,.0f}".format(row.Range_541_720_Q | default(0) | float) }}</span>
                                </td>
                                
                                <td class="col-aging-bucket aging-group">
                                    <span class="aging-value risk-720-text">{{ "{:,.0f}".format(over_720_v) }}</span>
                                    <span class="aging-qty">SL: {{ "{:,.0f}".format(row.Range_Over_720_Q | default(0) | float) }}</span>
                                </td>

                                <td class="col-d-risk">
                                    <span class="aging-value risk-720-text">
                                        {{ "{:,.0f}".format(risk_clc_v) }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="10" class="text-center text-muted">Không tìm thấy dữ liệu tồn kho theo tiêu chí lọc.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>