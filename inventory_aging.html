<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Phân tích Tồn kho & Tuổi hàng (I04 Master)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #4318FF; --bg-color: #F4F7FE; --text-dark: #2B3674;
            --danger: #E31A1A; --success: #05CD99; --warning: #FFB547;
            --card-radius: 20px;
        }
        body { background-color: var(--bg-color); font-family: 'Inter', sans-serif; color: var(--text-dark); }
        .container-fluid { max-width: 98%; margin-top: 30px; }

        /* HEADER & KPI */
        .page-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin: 0; }
        .btn-back { background: white; color: #A3AED0; border: 1px solid #E0E5F2; padding: 10px 20px; border-radius: 14px; text-decoration: none; font-weight: 600; }
        
        .kpi-card { background: white; border-radius: 20px; padding: 20px; border: none; height: 100%; display: flex; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .kpi-icon-box { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 15px; }
        .kpi-label { font-size: 0.75rem; color: #A3AED0; font-weight: 700; text-transform: uppercase; }
        .kpi-value { font-size: 1.5rem; font-weight: 700; color: var(--text-dark); line-height: 1.2; }
        .kpi-unit { font-size: 0.8rem; color: #A3AED0; }
        
        .icon-total { background: #F4F7FE; color: var(--primary); }
        .icon-new { background: #E6FDF5; color: var(--success); }
        .icon-clc { background: #F3E5F5; color: #9C27B0; }
        .icon-risk { background: #FFF1F1; color: var(--danger); }

        /* --- TABLE STYLES (NEW MASTER-DETAIL) --- */
        .main-card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; margin-top: 20px; }
        .table-aging { width: 100%; border-collapse: collapse; }
        
        .table-aging th { 
            position: sticky; top: 0; z-index: 100;
            background-color: #FAFCFE; color: #A3AED0; font-weight: 700; font-size: 0.8rem; text-transform: uppercase;
            padding: 15px 10px; border-bottom: 2px solid #E0E5F2; text-align: right;
        }
        .table-aging th.text-start { text-align: left; }
        .table-aging th.text-center { text-align: center; }

        /* Master Row (I04 Group) */
        .row-master { 
            background-color: #F4F7FE; cursor: pointer; transition: background 0.2s;
            border-top: 2px solid white;
        }
        .row-master:hover { background-color: #E3F2FD; }
        .row-master td { padding: 12px 10px; font-weight: 700; color: var(--text-dark); border-bottom: 1px solid #E0E5F2; font-size: 0.95rem; }
        
        .group-icon { transition: transform 0.2s; color: var(--primary); margin-right: 8px; }
        .row-master.expanded .group-icon { transform: rotate(90deg); }

        /* Detail Row (Items) */
        .row-detail { display: none; background-color: white; }
        .row-detail td { padding: 8px 10px; font-size: 0.9rem; color: #555; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .row-detail:hover td { background-color: #FAFCFE; }

        /* Highlights */
        .val-total { color: var(--primary); }
        .val-risk { color: var(--danger); }
        .val-clc { color: #9C27B0; font-weight: 800; } /* Tím đậm */
        .bg-clc-alert { background-color: #F3E5F5 !important; } /* Highlight dòng có CLC */

        .text-start { text-align: left !important; }
        .text-center { text-align: center !important; }
        .text-end { text-align: right !important; }
        
        /* Filter inputs */
        .form-control { border-radius: 12px; border: 1px solid #E0E5F2; background: #F4F7FE; }
        .form-control:focus { background: white; border-color: var(--primary); box-shadow: none; }
        .btn-filter { background: var(--primary); color: white; border-radius: 12px; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="page-header">
            <h1 class="page-title"><i class="fas fa-cubes me-2 text-primary"></i> PHÂN TÍCH TỒN KHO (I04 MASTER)</h1>
            <a href="/" class="btn-back"><i class="fas fa-arrow-left me-2"></i>Về Dashboard</a>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-icon-box icon-total"><i class="fas fa-boxes"></i></div>
                    <div>
                        <div class="kpi-label">Tổng Tồn Kho</div>
                        <div class="kpi-value">{{ "{:,.0f}".format(kpi_total_inventory | default(0)) }}</div>
                        <div class="kpi-unit">Triệu VNĐ</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-icon-box icon-new"><i class="fas fa-leaf"></i></div>
                    <div>
                        <div class="kpi-label text-success">Tồn Mới (< 6T)</div>
                        <div class="kpi-value text-success">{{ "{:,.0f}".format(kpi_new_6_months | default(0)) }}</div>
                        <div class="kpi-unit">Triệu VNĐ</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-icon-box icon-clc"><i class="fas fa-ban"></i></div>
                    <div>
                        <div class="kpi-label" style="color: #9C27B0;">Hàng CLC (Cột D)</div>
                        <div class="kpi-value" style="color: #9C27B0;">{{ "{:,.0f}".format(kpi_clc_value | default(0)) }}</div>
                        <div class="kpi-unit">Triệu VNĐ</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-icon-box icon-risk"><i class="fas fa-exclamation-triangle"></i></div>
                    <div>
                        <div class="kpi-label text-danger">Rủi Ro (> 2 Năm)</div>
                        <div class="kpi-value text-danger">{{ "{:,.0f}".format(kpi_over_2_years | default(0)) }}</div>
                        <div class="kpi-unit">Triệu VNĐ</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-card mb-4" style="padding: 20px;">
            <form method="POST" action="/inventory_aging" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-secondary">Mã / Tên hàng</label>
                    <input type="text" name="item_filter" class="form-control" value="{{ item_filter_term }}" placeholder="Tìm kiếm...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Ngành hàng</label>
                    <input type="text" name="category_filter" class="form-control" value="{{ category_filter }}" placeholder="Ví dụ: BẠC ĐẠN">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Loại (I05)</label>
                    <input type="text" name="i05id_filter" class="form-control" value="{{ i05id_filter }}" placeholder="S, A, B...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-secondary">Giá trị Tồn</label>
                    <input type="text" name="value_filter" class="form-control" value="{{ value_filter }}" placeholder="> 5000000">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-filter w-100 py-2"><i class="fas fa-filter me-2"></i> Lọc</button>
                </div>
            </form>
        </div>

        <div class="main-card">
            <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                <table class="table mb-0 table-aging">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th class="text-start">Mã nhóm / Tên hàng</th>
                            <th class="text-center">Loại</th>
                            <th class="text-end">Tổng Tồn</th>
                            <th class="text-end text-muted">0 - 180</th>
                            <th class="text-end text-muted">181 - 360</th>
                            <th class="text-end text-muted">361 - 540</th>
                            <th class="text-end text-muted">541 - 720</th>
                            <th class="text-end text-danger">> 720 (Rủi ro)</th>
                            <th class="text-end" style="color: #9C27B0;">Cột D (CLC)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in aging_data %}
                        
                        {% set outer_index = loop.index %}

                        <tr class="row-master" onclick="toggleGroup('grp-{{ outer_index }}', this)">
                            <td class="text-center"><i class="fas fa-chevron-right group-icon"></i></td>
                            <td class="text-start">
                                <span class="text-primary">{{ group.GroupID }}</span>
                                <span class="text-dark fw-bold ms-2">{{ group.GroupName }}</span>
                                <span class="badge bg-white text-secondary border ms-2 rounded-pill">{{ group.Items|length }} mã</span>
                            </td>
                            <td></td> <td class="text-end val-total">{{ "{:,.0f}".format(group.Group_TotalVal) }}</td>
                            
                            <td colspan="4"></td>
                            
                            <td class="text-end val-risk">{{ "{:,.0f}".format(group.Group_Over720) }}</td>
                            <td class="text-end val-clc">{{ "{:,.0f}".format(group.Group_CLC) }}</td>
                        </tr>

                        {% for item in group.Items %}
                        <tr class="row-detail grp-{{ outer_index }} {{ 'bg-clc-alert' if item.Risk_CLC_Value > 0 else '' }}">
                            <td></td> <td class="text-start ps-4">
                                <div class="fw-bold text-dark" style="font-size: 0.85rem;">{{ item.InventoryID }}</div>
                                <div class="text-muted small text-truncate" style="max-width: 400px;">{{ item.InventoryName }}</div>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark border">{{ item.StockClass }}</span>
                            </td>
                            <td class="text-end fw-bold">{{ "{:,.0f}".format(item.TotalCurrentValue) }}</td>
                            
                            <td class="text-end text-muted small">{{ "{:,.0f}".format(item.Range_0_180_V) }}</td>
                            <td class="text-end text-muted small">{{ "{:,.0f}".format(item.Range_181_360_V) }}</td>
                            <td class="text-end text-muted small">{{ "{:,.0f}".format(item.Range_361_540_V) }}</td>
                            <td class="text-end text-muted small">{{ "{:,.0f}".format(item.Range_541_720_V) }}</td>
                            
                            <td class="text-end {{ 'text-danger fw-bold' if item.Range_Over_720_V > 0 else 'text-muted small' }}">
                                {{ "{:,.0f}".format(item.Range_Over_720_V) }}
                            </td>
                            <td class="text-end {{ 'val-clc' if item.Risk_CLC_Value > 0 else 'text-muted small' }}">
                                {{ "{:,.0f}".format(item.Risk_CLC_Value) }}
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5 text-muted">Không tìm thấy dữ liệu phù hợp.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleGroup(groupId, row) {
            row.classList.toggle('expanded');
            const details = document.getElementsByClassName(groupId);
            for (let tr of details) {
                if (row.classList.contains('expanded')) {
                    tr.style.display = 'table-row';
                } else {
                    tr.style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>