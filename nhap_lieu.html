<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Hi·ªán Di·ªán Kh√°ch H√†ng</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* T√îNG M√ÄU S√ÅNG & HI·ªÜN ƒê·∫†I (GOOGLE THEME) */
        body { 
            background-color: #F8F9FA; 
            color: #3C4043; 
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        .container { max-width: 1300px; margin-top: 30px; }
        
        h1 { font-weight: 700; color: #4285F4; border-bottom: 3px solid #4285F4; padding-bottom: 10px; margin-bottom: 25px; } 

        /* M√ÄU LABEL */
        .text-primary { 
            color: #34A853 !important; /* Xanh l√° cho N·ªôi dung */
        }
        .text-danger { 
            color: #34A853 !important; /* Xanh l√° cho ƒê√°nh gi√° */
        }

        /* T√äN ƒê·ªêI T∆Ø·ª¢NG M√ÄU XANH ƒê·∫¨M */
        .label-highlight {
            font-weight: 600;
            color: #212529 !important; /* Chuy·ªÉn th√†nh m√†u ƒëen */
        }
        #kh_ten_day_du {
            color: #8C8C8C; /* M√†u ch·ªØ trong √¥ T√™n ƒê·ªëi t∆∞·ª£ng */
        }


        /* Card v√† Box */
        .card { 
            border: 1px solid #E0E0E0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .card-header { 
            background-color: #E8F0FE; 
            color: #4285F4; 
            font-weight: 600;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding: 1rem 1.5rem;
            font-size: 1.2rem;
        }
        
        /* S·ª¨A L·ªñI TH·∫®M M·ª∏ THANH TAB */
        #tab-card .card-header {
            padding: 0; 
        }
        #reportTabs {
            padding-left: 1.5rem; 
            padding-right: 1.5rem;
            border-bottom: none !important; 
        }
        .nav-link { 
            font-weight: 600; 
            color: #70757A; 
            padding: 0.5rem 1rem; 
        }
        .nav-link.active { 
            color: #4285F4 !important; 
            border-color: #4285F4 #dee2e6 transparent !important; 
        }
        #tab-card .card-body {
            border-top: 1px solid #dee2e6; /* ƒê∆∞·ªùng k·∫ª ph√¢n c√°ch */
        }


        /* KHUNG TRA C·ª®U M√ÄU XANH R√äU ƒê·∫¨M */
        #khachhang-card .card-header {
            background-color: #346265 !important; 
            color: white !important;
        }

        /* STYLE CHO ƒê√ÅNH GI√Å C·ªê ƒê·ªäNH */
        #danhgia-fixed-card .card-header {
            background-color: #E8F0FE !important; 
            color: #4285F4 !important; 
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        /* TƒÇNG G·∫§P 1.8 L·∫¶N CHI·ªÄU CAO TEXTAREA */
        .form-control.note-area {
            min-height: 270px; 
            resize: vertical;
            border-radius: 8px;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }
        
        /* Dropdown t√¨m ki·∫øm kh√°ch h√†ng */
        #kh_search_results { 
            width: 100%; 
            border-radius: 8px; 
            border-color: #4285F4;
            outline: none;
            display: none;
        }
        
        /* CSS ·∫®N */
        .hidden-field {
            display: none !important;
        }
        
        /* CSS cho v√πng tham chi·∫øu */
        .reference-box {
            background-color: #F1F3F4;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            font-size: 0.9rem;
            min-height: 120px;
            color: #3C4043;
        }
        .ref-label {
            font-weight: 500;
            color: #70757A;
            display: block;
            margin-top: 5px;
        }
        .ref-content {
            font-weight: 600;
            color: #212529;
            display: block;
        }
        
        /* N√∫t L∆∞u v√† V·ªÅ Dashboard */
        .btn-save-custom {
            min-width: 150px;
        }
        /* CSS cho n√∫t T·∫°o nhanh Nh√¢n s·ª± */
        .btn-quick-create {
            font-size: 0.85rem;
            padding: 0.3rem 0.6rem;
            font-weight: 600;
            margin-top: 5px;
            background-color: #34A853; 
            border-color: #2F834D;
        }
        .btn-quick-create:hover {
            background-color: #2F834D; 
            color: white;
        }

        @media print {
            /* ·∫®n m·ªçi th·ª© kh√°c tr·ª´ Watermark (N·∫øu b·∫°n kh√¥ng mu·ªën in b·∫•t c·ª© th·ª© g√¨) */
            body * { visibility: hidden !important; }
            
            /* Hi·ªÉn th·ªã Watermark */
            #watermark-user-id {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                opacity: 0.5;
                font-size: 50pt;
                color: #CCC;
                content: attr(data-user);
                visibility: visible !important;
                z-index: 9999;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>B√ÅO C√ÅO HI·ªÜN DI·ªÜN KH√ÅCH H√ÄNG</h1>

        {% if message and 'success' in message %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Th√†nh c√¥ng!</strong> B·∫£n ghi ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ an to√†n.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% elif message and 'error' in message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>L·ªói!</strong> {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <form method="POST" action="/nhaplieu" enctype="multipart/form-data">
            
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        
                        <div class="col-md-2">
                            <label class="form-label fw-bold">ID B·∫£n ghi</label>
                            <input type="text" class="form-control form-control-lg" value="[AUTO]" readonly> 
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Lo·∫°i B√°o c√°o</label>
                            <select name="loai" id="ddl_loai_bao_cao" class="form-select form-select-lg" required>
                                <option value="">-- Ch·ªçn Lo·∫°i --</option>
                                {% for loai in loai_bao_cao %}
                                <option value="{{ loai.LOAI }}">{{ loai['DIEN GIAI'] }} ({{ loai.LOAI }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ng∆∞·ªùi b√°o c√°o</label>
                            <select name="nv_bao_cao" class="form-select form-select-lg" required>
                                <option value="">-- Ch·ªçn Nh√¢n vi√™n --</option>
                                {% for user in users %}
                                <option value="{{ user.USERCODE }}" 
                                        {% if user.USERCODE == default_usercode %} selected {% endif %}>
                                    {{ user.SHORTNAME }} ({{ user.USERNAME }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Ng√†y B√°o c√°o</label>
                            <input type="date" name="ngay_bao_cao" class="form-control form-control-lg" value="{{ now_date.strftime('%Y-%m-%d') }}" required>
                        </div>
                        
                        <div class="col-md-12 mt-3">
                             <div class="card p-2" style="border: 1px dashed #ddd; background-color: #fcfcfc;">
                                 <label for="attachment_file" class="form-label fw-bold mb-0">
                                     üìé ƒê√≠nh k√®m File (T√†i li·ªáu, Danh thi·∫øp, H√¨nh ·∫£nh...)
                                 </label>
                                 <input type="file" name="attachment_file" id="attachment_file" class="form-control" multiple
                                        onchange="checkFiles(this)">
                                 <div id="file_list_display"></div> <small class="text-muted mt-1">
                                     *L∆∞u √Ω: File s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o th∆∞ m·ª•c 'attachments' tr√™n server.
                                 </small>
                             </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <div class="card mb-4" id="khachhang-card">
                <div class="card-header">
                    Hi·ªán di·ªán t·∫°i
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-start">
                        <div class="col-md-3">
                            <label class="form-label fw-bold text-dark">T√¨m theo t√™n</label>
                            <input type="text" id="kh_ten_tat" placeholder="G√µ t√™n vi·∫øt t·∫Øt KH..." class="form-control form-control-lg">
                            <small id="kh_status" class="form-text text-muted mb-3 d-block">Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm t·ª± ƒë·ªông.</small>
                        </div>

                        <div class="col-md-5">
                            <label class="form-label label-highlight">ƒê·ªëi t∆∞·ª£ng</label> 
                            <input type="text" id="kh_ten_day_du" placeholder="T√™n ƒê·ªëi t∆∞·ª£ng" class="form-control mb-3" readonly style="color: #8C8C8C;"> 
                            <input type="hidden" name="ma_doi_tuong_kh" id="kh_ma_doi_tuong" required>
                            <select id="kh_search_results" class="form-select mb-2" size="5" style="display:none;" onchange="chonKhachHang()">
                                </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label label-highlight text-danger">Th√¥ng tin Tham chi·∫øu</label>
                            
                            <div class="reference-box">
                                <span class="ref-label">ƒê·ªãa ch·ªâ Tr·ª• s·ªü ch√≠nh:</span>
                                <span class="ref-content" id="ref_diachi">...</span>
                                
                                <span class="ref-label mt-3">T√¨nh tr·∫°ng li√™n h·ªá:</span>
                                <span class="ref-content" id="ref_nlh_count">...</span> 
                            </div>
                        </div>
                        
                        <div class="col-md-6 mt-4">
                            <div class="d-flex justify-content-between align-items-end mb-1">
                                <label class="form-label fw-bold mb-0">Hi·ªán di·ªán tr∆∞·ªõc (1)</label>
                                <a href="#" onclick="openNhansuForm(event)" class="btn btn-sm btn-success btn-quick-create">
                                    ‚ûï T·∫°o
                                </a>
                            </div>
                            <select name="nhansu_hengap_1" id="nhansu_hengap_1" class="form-select">
                                <option value="">-- Ch·ªçn Nh√¢n s·ª± --</option>
                            </select>
                        </div>
                        <div class="col-md-6 mt-4">
                            <label class="form-label fw-bold">Hi·ªán di·ªán tr∆∞·ªõc (2)</label>
                            <select name="nhansu_hengap_2" id="nhansu_hengap_2" class="form-select">
                                <option value="">-- Ch·ªçn Nh√¢n s·ª± (Kh√¥ng b·∫Øt bu·ªôc) --</option>
                            </select>
                        </div>
                        </div>
                </div>
            </div>


            <div class="card mb-4" id="tab-card">
                <div class="card-header p-0">
                    <ul class="nav nav-tabs card-header-tabs" id="reportTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-a-tab" data-bs-toggle="tab" data-bs-target="#tab-a-pane" type="button" role="tab" aria-controls="tab-a-pane" aria-selected="true"><span id="lbl_tab_A">Tab A (C∆° b·∫£n)</span></button>
                        </li>
                        <li class="nav-item" role="presentation" id="li_tab_b">
                            <button class="nav-link" id="tab-b-tab" data-bs-toggle="tab" data-bs-target="#tab-b-pane" type="button" role="tab" aria-controls="tab-b-pane" aria-selected="false"><span id="lbl_tab_B">Tab B (M·ªü r·ªông 1)</span></button>
                        </li>
                        <li class="nav-item" role="presentation" id="li_tab_c">
                            <button class="nav-link" id="tab-c-tab" data-bs-toggle="tab" data-bs-target="#tab-c-pane" type="button" role="tab" aria-controls="tab-c-pane" aria-selected="false"><span id="lbl_tab_C">Tab C (M·ªü r·ªông 2)</span></button>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body tab-content p-4" id="reportTabsContent">
                    
                    <div class="tab-pane fade show active" id="tab-a-pane" role="tabpanel" aria-labelledby="tab-a-tab" tabindex="0">
                        <div class="row g-3">
                            <div class="col-md-6" id="div_noi_dung_1">
                                <label class="form-label text-primary" id="lbl_noi_dung_1">N·ªôi dung 1</label>
                                <textarea name="noi_dung_1" class="form-control note-area" required placeholder="N·ªôi dung 1..."></textarea>
                            </div>
                            <div class="col-md-6" id="div_noi_dung_2">
                                <label class="form-label text-primary" id="lbl_noi_dung_2">N·ªôi dung 2</label>
                                <textarea name="noi_dung_2" class="form-control note-area" required placeholder="N·ªôi dung 2..."></textarea>
                            </div>
                            <div class="col-md-12" id="div_danh_gia_1">
                                <label class="form-label text-danger" id="lbl_danh_gia_1">ƒê√°nh gi√° 1</label>
                                <textarea name="danh_gia_1" class="form-control note-area" required placeholder="ƒê√°nh gi√° 1..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-b-pane" role="tabpanel" aria-labelledby="tab-b-tab" tabindex="0">
                        <div class="row g-3">
                            <div class="col-md-6" id="div_noi_dung_3">
                                <label class="form-label text-primary" id="lbl_noi_dung_3">N·ªôi dung 3</label>
                                <textarea name="noi_dung_3" class="form-control note-area" placeholder="N·ªôi dung th√™m 3"></textarea>
                            </div>
                            <div class="col-md-6" id="div_noi_dung_4">
                                <label class="form-label text-primary" id="lbl_noi_dung_4">N·ªôi dung 4</label>
                                <textarea name="noi_dung_4" class="form-control note-area" placeholder="N·ªôi dung th√™m 4"></textarea>
                            </div>
                            <div class="col-md-12" id="div_danh_gia_3">
                                <label class="form-label text-danger" id="lbl_danh_gia_3">ƒê√°nh gi√° 3</label>
                                <textarea name="danh_gia_3" class="form-control note-area" placeholder="ƒê√°nh gi√° th√™m 3"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="tab-c-pane" role="tabpanel" aria-labelledby="tab-c-tab" tabindex="0">
                        <div class="row g-3">
                            <div class="col-md-12" id="div_noi_dung_5">
                                <label class="form-label text-primary" id="lbl_noi_dung_5">N·ªôi dung 5 (L·ªõn)</label>
                                <textarea name="noi_dung_5" class="form-control note-area" rows="2" placeholder="N·ªôi dung th√™m 5"></textarea>
                            </div>
                            <div class="col-md-6" id="div_danh_gia_4">
                                <label class="form-label text-danger" id="lbl_danh_gia_4">ƒê√°nh gi√° 4</label>
                                <textarea name="danh_gia_4" class="form-control note-area" placeholder="ƒê√°nh gi√° th√™m 4"></textarea>
                            </div>
                            <div class="col-md-6" id="div_danh_gia_5">
                                <label class="form-label text-danger" id="lbl_danh_gia_5">ƒê√°nh gi√° 5</label>
                                <textarea name="danh_gia_5" class="form-control note-area" rows="2" placeholder="ƒê√°nh gi√° th√™m 5"></textarea>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            
            <div class="card mb-4" id="danhgia-fixed-card">
                <div class="card-header">
                    <span class="fw-bold">ƒê√°nh Gi√°</span>
                </div>
                <div class="card-body p-4">
                    <div class="col-md-12" id="div_danh_gia_2">
                        <label class="form-label text-danger" id="lbl_danh_gia_2">Th√¥ng tin quan tr·ªçng</label>
                        <textarea name="danh_gia_2" class="form-control note-area" required placeholder="ƒê√°nh gi√° 2..."></textarea>
                    </div>
                </div>
            </div>


            <div class="d-flex justify-content-center gap-3 mt-5 pb-5">
                <button type="submit" class="btn btn-success btn-lg btn-save-custom">L∆∞u</button>
                <a href="/" class="btn btn-secondary btn-lg btn-save-custom">V·ªÅ Dashboard</a>
            </div>
        </form>
    </div>
    <div id="watermark-user-id" data-user="{{ current_user.usercode }}"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        // H√†m debounce: Tr√¨ ho√£n vi·ªác th·ª±c thi h√†m ƒë·ªÉ tr√°nh spam API
        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }
        
        // √ÅNH X·∫† M√É DLOOKUP v·ªõi T√™n tr∆∞·ªùng HTML (Gi·ªØ nguy√™n)
        const DLOOKUP_MAP = {
            '00M': 'danh_gia_2', 
            '11M': 'noi_dung_1', 
            '13M': 'danh_gia_1', 
            '12M': 'noi_dung_2',
            '21M': 'noi_dung_3',
            '22M': 'noi_dung_4',
            '33M': 'noi_dung_5',
            '23M': 'danh_gia_3',
            '31M': 'danh_gia_4',
            '32M': 'danh_gia_5'
        };

        // √ÅNH X·∫† C·ªòT: [Suffix-M√£] sang [ID c·ªßa LABEL/TAB NAME] (Gi·ªØ nguy√™n)
        const DLOOKUP_LABEL_ID_MAP = {
            '11H': 'lbl_noi_dung_1',
            '12H': 'lbl_noi_dung_2',
            '13H': 'lbl_danh_gia_1',
            '00H': 'lbl_danh_gia_2',
            '21H': 'lbl_noi_dung_3',
            '22H': 'lbl_noi_dung_4',
            '33H': 'lbl_noi_dung_5',
            '23H': 'lbl_danh_gia_3',
            '31H': 'lbl_danh_gia_4',
            '32H': 'lbl_danh_gia_5'
        };
        
        // C√ÅC ID C·ª¶A T√äN TAB TR√äN HTML (Gi·ªØ nguy√™n)
        const TAB_IDS = ['lbl_tab_A', 'lbl_tab_B', 'lbl_tab_C'];


        // √Ånh x·∫° label m·∫∑c ƒë·ªãnh (Gi·ªØ nguy√™n)
        const defaultLabels = {
            'lbl_noi_dung_1': 'N·ªôi dung 1',
            'lbl_noi_dung_2': 'N·ªôi dung 2',
            'lbl_danh_gia_2': 'Th√¥ng tin quan tr·ªçng', 
            'lbl_danh_gia_1': 'ƒê√°nh gi√° 1',
            'lbl_noi_dung_3': 'N·ªôi dung 3',
            'lbl_noi_dung_4': 'N·ªôi dung 4',
            'lbl_noi_dung_5': 'N·ªôi dung 5 (L·ªõn)',
            'lbl_danh_gia_3': 'ƒê√°nh gi√° 3',
            'lbl_danh_gia_4': 'ƒê√°nh gi√° 4',
            'lbl_danh_gia_5': 'ƒê√°nh gi√° 5',
            'lbl_tab_A': 'Tab A (C∆° b·∫£n)',
            'lbl_tab_B': 'Tab B (M·ªü r·ªông 1)',
            'lbl_tab_C': 'Tab C (M·ªü r·ªông 2)'
        };

        // H√†m ƒë·∫∑t l·∫°i khung tham chi·∫øu
        function resetReferenceBox() {
            document.getElementById('ref_diachi').textContent = 'ƒê·ªãa ch·ªâ Tr·ª• s·ªü ch√≠nh...';
            document.getElementById('ref_nlh_count').textContent = 'T√¨nh tr·∫°ng li√™n h·ªá...';
        }

        // H√†m g·ªçi API ƒë·∫øm s·ªë Nh√¢n s·ª± (Sau khi kh√°ch h√†ng ƒë∆∞·ª£c ch·ªçn)
        function fetchReferenceCount(maDoiTuong) {
            const nlhObject = document.getElementById('ref_nlh_count');
            nlhObject.textContent = 'ƒêang ƒë·∫øm...';

            fetch(`/api/khachhang/ref/${maDoiTuong}`)
                .then(response => {
                    if (!response.ok) throw new Error('L·ªói Server khi ƒë·∫øm nh√¢n s·ª±.');
                    return response.json();
                })
                .then(data => {
                    const count = data.CountNLH || 0;
                    nlhObject.textContent = `ƒêang li√™n h·ªá v·ªõi ${count} nh√¢n s·ª± ·ªü ƒë√¢y.`;
                })
                .catch(error => {
                    nlhObject.textContent = `L·ªói: Kh√¥ng ƒë·∫øm ƒë∆∞·ª£c nh√¢n s·ª±.`;
                    console.error("Fetch Count Error:", error);
                });
        }
        
        // --- LOGIC NH√ÇN S·ª∞ H·∫∏N G·∫∂P (M·ªöI) ---
        
        function populateNhansuDropdowns(data) {
            const ddl1 = document.getElementById('nhansu_hengap_1');
            const ddl2 = document.getElementById('nhansu_hengap_2');
            
            // X√≥a c√°c option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
            ddl1.innerHTML = '<option value="">-- Ch·ªçn Nh√¢n s·ª± --</option>';
            ddl2.innerHTML = '<option value="">-- Ch·ªçn Nh√¢n s·ª± (Kh√¥ng b·∫Øt bu·ªôc) --</option>';

            if (data && data.length > 0) {
                data.forEach(item => {
                    // Clone option ƒë·ªÉ th√™m v√†o c·∫£ hai dropdown
                    const option1 = new Option(item.text, item.id);
                    const option2 = new Option(item.text, item.id);
                    
                    ddl1.appendChild(option1);
                    ddl2.appendChild(option2);
                });
            }
        }
        
        function fetchNhansuDropdownData(maDoiTuong) {
            const ddl1 = document.getElementById('nhansu_hengap_1');
            ddl1.innerHTML = '<option value="">ƒêang t·∫£i...</option>'; // Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i

            fetch(`/api/nhansu_ddl_by_khachhang/${maDoiTuong}`)
                .then(response => {
                    // L·ªói 404 (Kh√¥ng t√¨m th·∫•y API) s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü ƒë√¢y
                    if (!response.ok) throw new Error('L·ªói Server khi t·∫£i Dropdown Nh√¢n s·ª±.');
                    return response.json();
                })
                .then(data => {
                    populateNhansuDropdowns(data);
                })
                .catch(error => {
                    // N·∫øu l·ªói, hi·ªÉn th·ªã l·ªói v√† ƒë·∫∑t l·∫°i dropdown
                    ddl1.innerHTML = '<option value="">L·ªói t·∫£i nh√¢n s·ª±.</option>';
                    document.getElementById('nhansu_hengap_2').innerHTML = '<option value="">L·ªói t·∫£i nh√¢n s·ª±.</option>';
                    console.error("Fetch Nhansu DDL Error:", error);
                });
        }
        
        // H√†m m·ªü form Nh·∫≠p s·ª± m·ªõi v√† truy·ªÅn MA DOI TUONG
        function openNhansuForm(event) {
            event.preventDefault();
            const maDoiTuong = document.getElementById('kh_ma_doi_tuong').value;
            if (maDoiTuong.trim() !== '') {
                window.open(`/nhansu_nhaplieu?kh_code=${maDoiTuong}`, '_blank');
            } else {
                alert("Vui l√≤ng ch·ªçn ƒê·ªëi t∆∞·ª£ng (Kh√°ch h√†ng) tr∆∞·ªõc khi t·∫°o Nh√¢n s·ª± m·ªõi.");
            }
        }
        
        // --- LOGIC KI·ªÇM TRA FILE ƒê√çNH K√àM (M·ªöI) ---
        
        const ALLOWED_EXTENSIONS = ['pdf', 'png', 'jpg', 'jpeg', 'gif', 'docx', 'xlsx', 'pptx', 'txt', 'zip', 'rar'];
        const HIGH_RISK_EXTENSIONS = ['exe', 'bat', 'cmd', 'js', 'vbs', 'php', 'asp']; 

        function checkFiles(input) {
            const fileDisplay = document.getElementById('file_list_display');
            fileDisplay.innerHTML = ''; // X√≥a hi·ªÉn th·ªã c≈©
            
            const files = input.files;
            let allFilesValid = true;
            
            if (files.length === 0) return;

            const ul = document.createElement('ul');
            ul.className = 'list-unstyled ps-3 mt-1';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const parts = file.name.split('.');
                const extension = parts.length > 1 ? parts.pop().toLowerCase() : '';
                
                const li = document.createElement('li');
                
                if (ALLOWED_EXTENSIONS.includes(extension) && !HIGH_RISK_EXTENSIONS.includes(extension)) {
                    li.textContent = `‚úÖ ${file.name}`;
                    li.style.color = '#1E8E3E'; // Green
                } else {
                    li.textContent = `‚ùå ${file.name} (T·ªáp r·ªßi ro/Kh√¥ng h·ª£p l·ªá)`;
                    li.className = 'file-error';
                    allFilesValid = false;
                }
                ul.appendChild(li);
            }
            fileDisplay.appendChild(ul);
            
            if (!allFilesValid) {
                alert("H·ªá th·ªëng ƒë√£ ph√°t hi·ªán c√°c t·ªáp r·ªßi ro ho·∫∑c kh√¥ng h·ª£p l·ªá. Vui l√≤ng x√≥a c√°c t·ªáp ƒë√≥ tr∆∞·ªõc khi l∆∞u.");
            }
        }


        // H√†m g·ªçi API v√† hi·ªÉn th·ªã 5 l·ª±a ch·ªçn
        function timKhachHang() {
            const ten_tat = document.getElementById('kh_ten_tat').value.trim();
            const status_msg = document.getElementById('kh_status');
            const resultsDropdown = document.getElementById('kh_search_results');
            
            status_msg.textContent = 'ƒêang t√¨m ki·∫øm...';
            resultsDropdown.style.display = 'none';
            resultsDropdown.innerHTML = '';
            document.getElementById('kh_ma_doi_tuong').value = '';
            document.getElementById('kh_ten_day_du').value = '';
            resetReferenceBox(); 
            populateNhansuDropdowns(null); // ƒê·∫∑t l·∫°i dropdown nh√¢n s·ª±


            if (ten_tat.length < 2) {
                status_msg.textContent = 'Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª±.';
                return;
            }

            fetch(`/sales/api/khachhang/${ten_tat}`)
                .then(response => {
                    if (response.status === 404) { throw new Error('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.'); }
                    if (!response.ok) { throw new Error('L·ªói Server.'); }
                    return response.json(); 
                })
                .then(data => {
                    if (data && data.length > 0) {
                        data.forEach(kh => {
                            const option = document.createElement('option');
                            option.value = kh.ID; 
                            
                            option.textContent = `${kh.FullName} (${kh.ID})`;
                            option.setAttribute('data-fullname', kh.FullName);
                            option.setAttribute('data-diachi', kh.DiaChi || 'N/A');
                            
                            resultsDropdown.appendChild(option);
                        });
                        
                        resultsDropdown.style.display = 'block';
                        resultsDropdown.size = Math.max(Math.min(data.length, 5), 2);
                        status_msg.textContent = `T√¨m th·∫•y ${data.length} k·∫øt qu·∫£. Vui l√≤ng ch·ªçn.`;
                        
                        if (data.length === 1) {
                             resultsDropdown.selectedIndex = 0;
                             chonKhachHang();
                        }
                        
                    } else {
                        status_msg.textContent = 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.';
                    }
                })
                .catch(error => {
                    status_msg.textContent = `L·ªói tra c·ª©u: ${error.message}`;
                    document.getElementById('kh_ten_day_du').placeholder = 'L·ªói t√¨m ki·∫øm.';
                    resetReferenceBox();
                    populateNhansuDropdowns(null);
                });
        }
        
        // H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn t·ª´ dropdown
        function chonKhachHang() {
            const resultsDropdown = document.getElementById('kh_search_results');
            if (resultsDropdown.selectedIndex === -1) { return; }
            
            const selectedOption = resultsDropdown.options[resultsDropdown.selectedIndex];
            
            const ma_doi_tuong_field = document.getElementById('kh_ma_doi_tuong');
            const ten_day_du_field = document.getElementById('kh_ten_day_du');

            if (selectedOption) {
                const maDoiTuong = selectedOption.value;

                ma_doi_tuong_field.value = maDoiTuong;
                ten_day_du_field.value = selectedOption.getAttribute('data-fullname');
                
                // 1. C·∫¨P NH·∫¨T ƒê·ªäA CH·ªà
                document.getElementById('ref_diachi').textContent = selectedOption.getAttribute('data-diachi');

                // 2. G·ªåI API ƒê·ªÇ L·∫§Y TH√îNG TIN THAM CHI·∫æU V√Ä DROPDOWN
                fetchReferenceCount(maDoiTuong);
                fetchNhansuDropdownData(maDoiTuong); // T·∫¢I DROPDOWN NH√ÇN S·ª∞

                document.getElementById('kh_status').textContent = '‚úÖ Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c ch·ªçn v√† x√°c nh·∫≠n.';
            }
        }

        // === LOGIC DLOOKUP M·∫∂C ƒê·ªäNH & THAY ƒê·ªîI TI√äU ƒê·ªÄ (AfterUpdate) ===
        function updateFormVisibility() {
            const ddlLoai = document.getElementById('ddl_loai_bao_cao');
            const loaiCode = ddlLoai.value;
            
            const tabB_li = document.getElementById('li_tab_b');
            const tabC_li = document.getElementById('li_tab_c');
            
            // 1. ƒê·∫∑t l·∫°i tr·∫°ng th√°i HI·ªÜN BAN ƒê·∫¶U cho c·∫£ 3 tab
            if (tabB_li) tabB_li.classList.remove('hidden-field');
            if (tabC_li) tabC_li.classList.remove('hidden-field');
            
            // --- B∆Ø·ªöC 2A: ƒê·∫∑t l·∫°i gi√° tr·ªã v√† ti√™u ƒë·ªÅ m·∫∑c ƒë·ªãnh (Lu√¥n ch·∫°y) ---
            for (const key in defaultLabels) {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = defaultLabels[key]; 
                }
            }
            document.querySelectorAll('.note-area').forEach(textarea => {
                textarea.value = ''; 
            });


            if (loaiCode) {
                // --- B∆Ø·ªöC 2B: G·ªåI API V√Ä G√ÅN GI√Å TR·ªä T√åM ƒê∆Ø·ª¢C ---
                fetch(`/api/defaults/${loaiCode}`)
                    .then(response => {
                        if (response.status === 404) { return {}; }
                        return response.json();
                    })
                    .then(defaults => {
                        
                        // Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa t√™n Tab trong d·ªØ li·ªáu tr·∫£ v·ªÅ
                        const hasTabB = defaults[loaiCode + 'BH'] !== undefined;
                        const hasTabC = defaults[loaiCode + 'CH'] !== undefined;
                        
                        // 1. LOGIC ·∫®N/HI·ªÜN TAB D·ª∞A TR√äN D·ªÆ LI·ªÜU
                        if (!hasTabB && !hasTabC) {
                            if (tabB_li) tabB_li.classList.add('hidden-field');
                            if (tabC_li) tabC_li.classList.add('hidden-field');
                            
                            const tabC_pane = document.getElementById('tab-c-pane');
                            if (tabC_pane && tabC_pane.classList.contains('show')) {
                                const tabA_button = document.getElementById('tab-a-tab');
                                if (tabA_button) {
                                    new bootstrap.Tab(tabA_button).show();
                                }
                            }
                            
                        } else if (hasTabB && !hasTabC) {
                            if (tabC_li) tabC_li.classList.add('hidden-field');
                            
                            const tabC_pane = document.getElementById('tab-c-pane');
                            if (tabC_pane && tabC_pane.classList.contains('show')) {
                                const tabA_button = document.getElementById('tab-a-tab');
                                new bootstrap.Tab(tabA_button).show(); 
                            }
                        }

                        
                        // 2. LOGIC G√ÅN GI√Å TR·ªä V√Ä TI√äU ƒê·ªÄ
                        Object.keys(defaults).forEach(lookupKey => {
                            const value = defaults[lookupKey];
                            
                            // X·ª≠ l√Ω T√™n Tab (V√≠ d·ª•: AAH, ABH, ACH) - 3 k√Ω t·ª±, k·∫øt th√∫c b·∫±ng H
                            if (lookupKey.length === 3 && lookupKey.endsWith('H') && lookupKey.startsWith(loaiCode)) {
                                const tabSTT = lookupKey.substring(1, 2); 
                                const tabLabelId = 'lbl_tab_' + tabSTT;
                                
                                const tabLabelElement = document.getElementById(tabLabelId);
                                if (tabLabelElement && value) {
                                    tabLabelElement.textContent = value;
                                }
                                return;
                            }
                            
                            // X·ª≠ l√Ω Ti√™u ƒë·ªÅ/Gi√° tr·ªã m·∫∑c ƒë·ªãnh (V√≠ d·ª•: A11H, A11M, A21H, A32M) - 4 k√Ω t·ª±
                            if (lookupKey.length === 4) {
                                const codeSuffix = lookupKey.substring(1, 4); 
                                const fieldName = DLOOKUP_MAP[codeSuffix];
                                const labelId = DLOOKUP_LABEL_ID_MAP[codeSuffix];
                                
                                if (fieldName || labelId) {
                                    if (lookupKey.endsWith('M')) {
                                        const element = document.querySelector(`textarea[name="${fieldName}"]`);
                                        if (element && value) element.value = value; 
                                    } else if (lookupKey.endsWith('H')) {
                                        const labelElement = document.getElementById(labelId);
                                        if (labelElement && value) labelElement.textContent = value;
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => {
                        console.error("L·ªói DLookup Default Values:", error);
                    });
            }
        }
        

        // === ƒêƒÇNG K√ù S·ª∞ KI·ªÜN CH√çNH ===
        document.addEventListener('DOMContentLoaded', function() {
            const tenTatInput = document.getElementById('kh_ten_tat');
            const resultsDropdown = document.getElementById('kh_search_results');
            const ddlLoai = document.getElementById('ddl_loai_bao_cao'); 

            // 1. K√çCH HO·∫†T AUTOCOMPLETE
            tenTatInput.addEventListener('input', debounce(function() {
                timKhachHang();
            }, 300)); 

            // 2. NGƒÇN CH·∫∂N SUBMIT khi nh·∫•n ENTER trong √¥ t√¨m ki·∫øm
            tenTatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    timKhachHang();
                }
            });

            // 3. X·ª¨ L√ù CH·ªåN KH√ÅCH H√ÄNG
            resultsDropdown.addEventListener('change', chonKhachHang);
            
            // 4. LOGIC LO·∫†I B√ÅO C√ÅO (AfterUpdate)
            if (ddlLoai) {
                 ddlLoai.addEventListener('change', updateFormVisibility);
                 updateFormVisibility(); // Ch·∫°y l·∫ßn ƒë·∫ßu khi form t·∫£i xong
            }
            
            // ƒê·∫∑t l·∫°i khung tham chi·∫øu v√† dropdown nh√¢n s·ª± khi t·∫£i l·∫ßn ƒë·∫ßu
            resetReferenceBox();
            populateNhansuDropdowns(null);
        });

    </script>
    <script>
        // B·ªî SUNG: KH√ìA CH·ª®C NƒÇNG IN (PRINT BLOCKING)
        document.addEventListener('DOMContentLoaded', function() {
            
            // 1. Ch·∫∑n t·ªï h·ª£p ph√≠m CTRL+P (Windows/Linux) v√† CMD+P (Mac)
            document.addEventListener('keydown', function(e) {
                // Ki·ªÉm tra CTRL/CMD + P
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    alert("Ch·ª©c nƒÉng in ƒë√£ b·ªã kh√≥a tr√™n trang n√†y.");
                }
            }, true); // <<< TH√äM 'true' V√ÄO ƒê√ÇY ƒê·ªÇ TƒÇNG ∆ØU TI√äN

            // 2. Ghi ƒë√® h√†m window.print()
            window.print = function() {
                alert("Ch·ª©c nƒÉng in ƒë√£ b·ªã kh√≥a tr√™n trang n√†y.");
            };
            
            // 3. Kh√≥a c√°c thao t√°c copy/ch·ªçn vƒÉn b·∫£n
            document.addEventListener('contextmenu', e => e.preventDefault()); 
            document.addEventListener('selectstart', e => e.preventDefault()); 
            document.addEventListener('copy', e => { 
                e.preventDefault();
                alert("Sao ch√©p n·ªôi dung b·ªã c·∫•m.");
            });
        });
    </script>
</body>
</html>