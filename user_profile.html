{% extends "base.html" %}

{% block title %}H·ªì s∆° Nh√¢n s·ª± & G√≥c Flex{% endblock %}

{% block extra_css %}
<style>
    /* --- 1. PROFILE HEADER --- */
    .profile-header {
        position: relative; overflow: hidden; border-radius: 0 0 30px 30px;
        background: linear-gradient(135deg, var(--primary), #8E2DE2);
        color: white; padding: 60px 20px 40px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 30px;
    }
    .avatar-wrapper {
        position: relative; width: 130px; height: 130px; margin: 0 auto 15px;
    }
    .profile-avatar {
        width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
        border: 4px solid rgba(255,255,255,0.8); box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        transition: transform 0.3s; background-color: #fff;
    }
    .upload-btn {
        position: absolute; bottom: 5px; right: 5px; width: 38px; height: 38px;
        background: #fff; border-radius: 50%; color: var(--primary);
        display: flex; align-items: center; justify-content: center; cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s;
    }
    .upload-btn:hover { transform: scale(1.1); background: #f8f9fa; }
    
    .level-badge {
        background: linear-gradient(45deg, #FFD700, #FFB547); color: #000;
        font-weight: 800; padding: 5px 15px; border-radius: 20px;
        position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 0.95rem; z-index: 2;
    }
    .xp-container { max-width: 450px; margin: 0 auto; position: relative; }
    .progress-custom { height: 12px; background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden; }
    .progress-bar-custom { background: #00E676; height: 100%; transition: width 1s ease-in-out; box-shadow: 0 0 10px rgba(0, 230, 118, 0.5); }
    .xp-text { font-size: 0.9rem; margin-top: 8px; font-weight: 500; }

    /* --- 2. TABS & SHOP --- */
    .nav-pills-custom .nav-link {
        color: var(--text-dark); background: var(--card-bg); margin-right: 10px;
        border-radius: 12px; font-weight: 600; padding: 12px 25px;
        border: 1px solid var(--border-color); transition: 0.2s;
    }
    .nav-pills-custom .nav-link.active {
        background: var(--primary); color: white; border-color: var(--primary);
        box-shadow: 0 5px 15px rgba(67, 24, 255, 0.3);
    }
    
    .shop-item {
        background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border-color);
        padding: 20px; text-align: center; transition: 0.3s; position: relative; overflow: hidden;
        height: 100%; display: flex; flex-direction: column;
    }
    .shop-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary); }
    .item-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
    .item-type-badge {
        font-size: 0.7rem; text-transform: uppercase; padding: 2px 8px; border-radius: 4px;
        background: var(--input-bg); color: var(--secondary); margin-bottom: 10px; display: inline-block;
    }
    .item-price { font-weight: 800; color: #FFB547; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .shop-item.locked { filter: grayscale(0.8); opacity: 0.9; }
    .locked-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); display: flex; flex-direction: column;
        align-items: center; justify-content: center; color: white;
        z-index: 10; backdrop-filter: blur(2px);
    }

    .system-card {
        background: var(--card-bg); padding: 40px; border-radius: 20px;
        box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
    }

    /* --- 3. [NEW] 3D FLEX ROOM (G√ìC FLEX) --- */
    .flex-room-container {
        perspective: 1200px;
        height: 550px;
        width: 100%;
        overflow: hidden;
        background: radial-gradient(circle at center, #1a2a6c, #b21f1f, #fdbb2d); /* Default Fantasyish */
        border-radius: 20px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background 0.5s;
        box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
    }

    /* N·ªÅn ph√≤ng thay ƒë·ªïi theo Theme */
    [data-theme="light"] .flex-room-container { background: radial-gradient(circle, #89f7fe, #66a6ff); }
    [data-theme="dark"] .flex-room-container { background: radial-gradient(circle, #232526, #414345); }
    [data-theme="adorable"] .flex-room-container { background: radial-gradient(circle, #ff9a9e, #fad0c4); }

    .room-stage {
        width: 500px; height: 500px;
        position: relative;
        transform-style: preserve-3d;
        transform: rotateX(60deg) rotateZ(0deg) scale(0.8);
        transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* S√ÄN NH√Ä */
    .room-floor {
        position: absolute; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(5px);
        border: 10px solid rgba(255,255,255,0.3);
        box-shadow: 0 0 60px rgba(0,0,0,0.3);
        display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr);
    }
    .floor-tile { border: 1px solid rgba(255,255,255,0.1); }

    /* T∆Ø·ªúNG (D·ª±ng ƒë·ª©ng l√™n) */
    .room-wall-left, .room-wall-right {
        position: absolute; bottom: 0; width: 100%; height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }
    .room-wall-left {
        transform-origin: bottom center;
        transform: rotateX(-90deg) translateZ(250px) translateY(0); /* ƒê·∫©y l√πi v·ªÅ sau */
        display: flex; justify-content: space-around; align-items: center; padding: 20px;
    }

    /* V·∫¨T PH·∫®M: TRANH TREO (Themes/Skills) */
    .wall-frame {
        width: 90px; height: 110px;
        background: #fff; border: 5px solid #FFD700;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: 0.3s; cursor: pointer; position: relative;
    }
    .wall-frame:hover { transform: scale(1.1) translateZ(10px); border-color: var(--primary); }
    .wall-frame i { font-size: 2.5rem; color: #333; margin-bottom: 5px; }
    .wall-frame span { font-size: 0.65rem; font-weight: bold; text-align: center; color: #555; }
    .wall-frame .active-badge { position: absolute; top: -10px; right: -10px; font-size: 1.2rem; color: #00E676; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }

    /* V·∫¨T PH·∫®M: PET & DECOR (Tr√™n s√†n) */
    .floor-item {
        position: absolute;
        transform-style: preserve-3d;
        transition: 0.3s; cursor: pointer;
        display: flex; justify-content: center; align-items: center;
    }
    /* Quan tr·ªçng: D·ª±ng item ƒë·ª©ng l√™n vu√¥ng g√≥c v·ªõi s√†n */
    .floor-item-inner {
        transform: rotateX(-90deg) translateY(-50%) scale(1.5);
        filter: drop-shadow(0 15px 10px rgba(0,0,0,0.4));
        transition: 0.3s;
    }
    .floor-item:hover .floor-item-inner { transform: rotateX(-90deg) translateY(-70%) scale(1.7); }

    /* K·ªÜ C√öP */
    .trophy-stand {
        position: absolute; width: 120px; height: 120px;
        top: 50%; left: 50%; transform: translate(-50%, -50%);
        border: 2px dashed rgba(255,255,255,0.3);
        border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
    }
    .trophy-item {
        font-size: 4rem; color: #FFD700;
        transform: rotateX(-90deg) translateY(-30%);
        filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
        animation: floatTrophy 3s infinite ease-in-out;
    }
    @keyframes floatTrophy { 0%, 100% { transform: rotateX(-90deg) translateY(-30%); } 50% { transform: rotateX(-90deg) translateY(-45%); } }

    /* Controls */
    .room-controls {
        position: absolute; bottom: 20px; right: 20px;
        display: flex; gap: 10px; z-index: 10;
    }
    .item-tooltip {
        position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); color: white; padding: 4px 10px;
        border-radius: 6px; font-size: 0.75rem; white-space: nowrap;
        opacity: 0; transition: 0.2s; pointer-events: none;
    }
    .wall-frame:hover .item-tooltip, .floor-item:hover .item-tooltip { opacity: 1; bottom: 110%; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    
    <div class="profile-header">
        <div class="avatar-wrapper">
            <div class="level-badge">LV.{{ user_stats.Level }}</div>
            <img src="{{ user_stats.AvatarUrl or url_for('static', filename='img/default_avatar.png') }}" 
                 class="profile-avatar" id="avatarPreview" alt="Avatar">
            
            <label for="avatarUpload" class="upload-btn" title="ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán">
                <i class="fas fa-camera"></i>
            </label>
            <input type="file" id="avatarUpload" accept="image/*" hidden onchange="previewAndUpload(this)">
        </div>
        
        <h2 class="fw-bold mb-1">{{ user_context.shortname }}</h2>
        <p class="opacity-75 mb-4">{{ user_context.bo_phan }} | {{ user_context.role }}</p>
        
        <div class="xp-container">
            <div class="d-flex justify-content-between xp-text mb-1">
                <span>XP: {{ "{:,.0f}".format(user_stats.CurrentXP) }} / {{ "{:,.0f}".format(user_stats.next_level_xp) }}</span>
                <span class="fw-bold"><i class="fas fa-coins text-warning me-1"></i>{{ "{:,.0f}".format(user_stats.TitanCoins) }} Coins</span>
            </div>
            <div class="progress-custom">
                <div class="progress-bar-custom" style="width: {{ user_stats.xp_percent }}%;"></div>
            </div>
            <div class="text-end mt-1"><small style="opacity: 0.8">Ti·∫øn ƒë·ªô l√™n c·∫•p ti·∫øp theo</small></div>
        </div>
    </div>

    <div class="container pb-5">
        <ul class="nav nav-pills nav-pills-custom mb-5 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-store">
                    <i class="fas fa-store me-2"></i>Titan Store
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-inventory">
                    <i class="fas fa-vr-cardboard me-2"></i>G√≥c Flex C·ªßa T√¥i
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-system">
                    <i class="fas fa-user-shield me-2"></i>T√†i Kho·∫£n
                </button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            
            <div class="tab-pane fade show active" id="pills-store">
                <div class="row g-4">
                    {% for item in shop_items %}
                    <div class="col-md-3 col-6">
                        {% set is_locked = user_stats.Level < item.MinLevel %}
                        <div class="shop-item {{ 'locked' if is_locked else '' }}">
                            {% if is_locked %}
                            <div class="locked-overlay">
                                <i class="fas fa-lock mb-2 fs-2"></i>
                                <span class="fw-bold">Y√™u c·∫ßu LV.{{ item.MinLevel }}</span>
                            </div>
                            {% endif %}
                            <span class="item-type-badge">{{ item.ItemType }}</span>
                            <div class="item-icon">{{ item.Icon }}</div>
                            <h6 class="fw-bold text-truncate" title="{{ item.ItemName }}">{{ item.ItemName }}</h6>
                            <p class="small text-muted mb-3" style="min-height: 40px;">{{ item.Description }}</p>
                            <div class="mt-auto">
                                {% if item.IsOwned %}
                                    <button class="btn btn-sm btn-secondary w-100 rounded-pill" disabled><i class="fas fa-check me-1"></i>ƒê√£ s·ªü h·ªØu</button>
                                {% else %}
                                    <div class="item-price mb-2">{{ "{:,.0f}".format(item.Price) }} <i class="fas fa-coins"></i></div>
                                    <button class="btn btn-sm btn-primary w-100 rounded-pill fw-bold" onclick="buyItem('{{ item.ItemCode }}', {{ item.Price }})" {{ 'disabled' if is_locked else '' }}>Mua ngay</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="tab-pane fade" id="pills-inventory">
                <div class="card border-0 mb-3 bg-transparent">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0 text-muted"><i class="fas fa-cube me-2"></i>Kh√¥ng gian tr∆∞ng b√†y</h5>
                        <button class="btn btn-sm btn-outline-primary bg-white shadow-sm" onclick="shareFlex()"><i class="fas fa-camera me-2"></i>Ch·ª•p ·∫£nh khoe ngay</button>
                    </div>
                </div>

                <div class="flex-room-container" id="flexRoom">
                    <div class="room-stage" id="roomStage">
                        
                        <div class="room-wall-left">
                            {% for item in inventory if item.ItemType in ['THEME', 'SKILL'] %}
                            <div class="wall-frame" onclick="equipItem('{{ item.ItemCode }}')" title="{{ item.Description }}">
                                <div class="item-tooltip">{{ item.ItemName }}</div>
                                {% if item.IsEquipped %}<div class="active-badge"><i class="fas fa-check-circle"></i></div>{% endif %}
                                <div class="text-center"><span style="font-size: 2rem;">{{ item.Icon }}</span></div>
                                <span class="text-truncate w-100 px-1 mt-2">{{ item.ItemName }}</span>
                            </div>
                            {% else %}
                            <div class="wall-frame" style="border-color: #ccc; filter: grayscale(1); opacity: 0.5;">
                                <i class="fas fa-plus"></i><span>Tr·ªëng</span>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="room-floor">
                            {% for i in range(16) %}<div class="floor-tile"></div>{% endfor %}
                            
                            {% for item in inventory if item.ItemType == 'PET' %}
                                {% set pos_top = [20, 60, 40, 70] | random %}
                                {% set pos_left = [20, 70, 30, 60] | random %}
                                
                                <div class="floor-item" style="top: {{ pos_top }}%; left: {{ pos_left }}%;" onclick="equipItem('{{ item.ItemCode }}')">
                                    <div class="item-tooltip">{{ item.ItemName }} {{ '(ƒêang d√πng)' if item.IsEquipped else '' }}</div>
                                    <div class="floor-item-inner">
                                        {% if item.ItemCode == 'fox' %}
                                            <lottie-player src="{{ url_for('static', filename='json/Fox-Audio.json') }}" background="transparent" speed="1" style="width: 80px; height: 80px;" loop autoplay></lottie-player>
                                        {% else %}
                                            <span style="font-size: 3.5rem;">{{ item.Icon }}</span>
                                        {% endif %}
                                    </div>
                                    {% if item.IsEquipped %}
                                        <div class="position-absolute top-0 start-50 translate-middle badge bg-success" style="transform: rotateX(-90deg) !important; margin-top: -10px;">Active</div>
                                    {% endif %}
                                </div>
                            {% endfor %}

                            <div class="trophy-stand">
                                {% if user_stats.Level >= 10 %}
                                    <div class="trophy-item" title="Th√†nh t·ª±u: C√°n m·ªëc Level 10">üèÜ</div>
                                {% elif current_user.role == 'ADMIN' %}
                                    <div class="trophy-item" title="Admin Quy·ªÅn L·ª±c">üëë</div>
                                {% else %}
                                    <div class="floor-item-inner" style="opacity: 0.3; font-size: 2rem;">Coming Soon</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="room-controls">
                        <button class="btn btn-light rounded-circle shadow" onclick="rotateRoom('left')"><i class="fas fa-undo"></i></button>
                        <button class="btn btn-light rounded-circle shadow" onclick="rotateRoom('right')"><i class="fas fa-redo"></i></button>
                    </div>
                </div>
                
                <p class="text-center text-muted mt-3 small"><i class="fas fa-mouse-pointer me-1"></i>Click v√†o v·∫≠t ph·∫©m ƒë·ªÉ Trang b·ªã/S·ª≠ d·ª•ng. D√πng n√∫t xoay ƒë·ªÉ xem to√†n c·∫£nh.</p>
            </div>

            <div class="tab-pane fade" id="pills-system">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="system-card">
                            <h5 class="fw-bold mb-4 text-center"><i class="fas fa-key me-2 text-primary"></i>ƒê·ªïi M·∫≠t Kh·∫©u</h5>
                            <form id="changePassForm" onsubmit="changePassword(event)">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-muted">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                    <input type="password" name="current_password" class="form-control" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-muted">M·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" name="new_password" class="form-control" required minlength="6" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±">
                                </div>
                                <div class="mb-4">
                                    <label class="form-label small fw-bold text-muted">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                    <input type="password" name="confirm_password" class="form-control" required placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                                </div>
                                <button type="submit" class="btn btn-primary w-100 rounded-pill py-2 fw-bold shadow-sm">
                                    <i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- 1. JS FOR 3D ROOM ---
    let currentRotation = 0;
    
    function rotateRoom(direction) {
        const stage = document.getElementById('roomStage');
        if (direction === 'left') {
            currentRotation -= 45;
        } else {
            currentRotation += 45;
        }
        // Gi·ªØ g√≥c nghi√™ng X 60deg (nh√¨n t·ª´ tr√™n xu·ªëng), ch·ªâ xoay tr·ª•c Z
        stage.style.transform = `rotateX(60deg) rotateZ(${currentRotation}deg) scale(0.8)`;
    }

    function shareFlex() {
        alert("üì∏ T√°ch! ƒê√£ ch·ª•p ·∫£nh G√≥c Flex.\nT√≠nh nƒÉng ƒëƒÉng l√™n Newsfeed ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!");
        const flash = document.createElement('div');
        flash.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;opacity:1;transition:opacity 0.5s;';
        document.body.appendChild(flash);
        setTimeout(() => { flash.style.opacity = 0; }, 50);
        setTimeout(() => { flash.remove(); }, 500);
    }

    // --- 2. EXISTING FUNCTIONS ---
    function previewAndUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('avatarPreview').src = e.target.result; }
            reader.readAsDataURL(file);

            const formData = new FormData();
            formData.append('avatar', file);

            fetch('/api/user/upload_avatar', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if(data.success) console.log('Avatar updated');
                else alert('‚ùå L·ªói t·∫£i ·∫£nh: ' + data.message);
            })
            .catch(err => alert('L·ªói k·∫øt n·ªëi: ' + err));
        }
    }

    function changePassword(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        if (data.new_password !== data.confirm_password) {
            alert('‚ùå X√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp!');
            return;
        }

        const btn = form.querySelector('button[type="submit"]');
        const oldText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

        fetch('/api/user/change_password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                alert('‚úÖ ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                window.location.href = '/logout';
            } else {
                alert('‚ùå L·ªói: ' + res.message);
                btn.disabled = false; btn.innerHTML = oldText;
            }
        })
        .catch(err => {
            alert('L·ªói h·ªá th·ªëng.');
            btn.disabled = false; btn.innerHTML = oldText;
        });
    }

    function buyItem(itemCode, price) {
        if(!confirm(`B·∫°n mu·ªën d√πng ${price} Coins ƒë·ªÉ mua v·∫≠t ph·∫©m n√†y?`)) return;
        fetch('/api/user/buy_item', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ item_code: itemCode })
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                alert(res.message);
                location.reload();
            } else {
                alert('‚ùå ' + res.message);
            }
        });
    }

    function equipItem(itemCode) {
        fetch('/api/user/equip_item', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ item_code: itemCode })
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                if(itemCode.includes('theme') || ['light','dark','fantasy','adorable'].includes(itemCode)) {
                    document.documentElement.setAttribute('data-theme', itemCode);
                    localStorage.setItem('titan_theme', itemCode);
                }
                alert('‚úÖ ' + res.message);
                location.reload();
            } else {
                alert('‚ùå ' + res.message);
            }
        });
    }
</script>
{% endblock %}