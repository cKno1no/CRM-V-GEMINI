{% extends "base.html" %}

{% block title %}H·ªì s∆° & G√≥c Flex | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* ========================================= */
    /* 1. FLEX STAGE (S√ÇN KH·∫§U T∆Ø∆†NG T√ÅC) */
    /* ========================================= */
    .flex-stage-wrapper {
        position: relative;
        width: 100%;
        height: 70vh;
        min-height: 500px;
        background: radial-gradient(circle at center bottom, #2b3040 0%, #1a1c29 100%);
        border-radius: 0 0 40px 40px;
        overflow: hidden; 
        margin-bottom: -60px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.4);
        border-bottom: 4px solid rgba(255,255,255,0.1);
    }

    .stage-bg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-image: var(--bg-image);
        background-size: cover; background-position: center;
        opacity: 0.5; filter: blur(5px); z-index: 0; pointer-events: none;
    }

    .draggable-item {
        position: absolute; cursor: grab; z-index: 10; transition: transform 0.1s;
        top: 50%; left: 50%; transform: translate(-50%, -50%); user-select: none;
    }
    .draggable-item:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.05); }

    .interact-anim { animation: bounce 0.5s ease; }
    @keyframes bounce { 
        0%, 100% { transform: translate(-50%, -50%) scale(1); } 
        50% { transform: translate(-50%, -50%) scale(1.2); } 
    }

    /* AVATAR & PET COMPONENT */
    .avatar-wrapper { width: 180px; height: 180px; position: relative; }
    .main-avatar {
        width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
        border: 4px solid rgba(255,255,255,0.8); box-shadow: 0 0 30px rgba(67, 24, 255, 0.6);
        background: #fff; position: relative; z-index: 2;
    }
    .frame-lottie {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1.65);
        width: 100%; height: 100%; z-index: 3; pointer-events: none;
    }
    
    .stage-info {
        position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%);
        text-align: center; width: 300px; pointer-events: none;
    }
    .stage-name { 
        font-family: 'Fredoka', sans-serif; font-size: 2rem; font-weight: 700; color: white;
        text-shadow: 0 4px 10px rgba(0,0,0,0.8); background: rgba(0,0,0,0.3);
        padding: 5px 20px; border-radius: 20px; backdrop-filter: blur(4px); display: inline-block;
    }
    .stage-title {
        background: linear-gradient(90deg, #FFD700, #FFA500); color: #fff;
        padding: 4px 15px; border-radius: 20px; font-weight: 800; font-size: 0.8rem;
        text-transform: uppercase; box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
    }

    .pet-wrapper { width: 250px; height: 250px; } /* Pet to h∆°n ch√∫t */
    .chat-bubble {
        position: absolute; top: -40px; right: -20px; background: white; color: #333;
        padding: 8px 15px; border-radius: 15px 15px 0 15px; font-weight: bold; font-size: 0.85rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s;
        pointer-events: none; width: max-content;
    }
    .pet-wrapper:hover .chat-bubble { opacity: 1; top: -50px; }

    /* ========================================= */
    /* 2. CARD & LAYOUT */
    /* ========================================= */
    .profile-body { position: relative; z-index: 20; padding-bottom: 50px; }
    .glass-card {
        background: var(--card-bg); border: 1px solid var(--border-color);
        border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.05); overflow: hidden; height: 100%;
    }
    .xp-bar-container { background: var(--input-bg); height: 12px; border-radius: 10px; margin: 15px 0; overflow: hidden; }
    .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--warning), #FFD700); width: 0%; transition: width 1s; }

    /* ========================================= */
    /* 3. ITEM GRID SYSTEM (BIGGER & BETTER) */
    /* ========================================= */
    .category-header {
        font-size: 1rem; font-weight: 800; color: var(--secondary);
        text-transform: uppercase; letter-spacing: 1px; margin: 30px 0 20px 0;
        display: flex; align-items: center;
    }
    .category-header::after { content: ''; flex: 1; height: 1px; background: var(--border-color); margin-left: 15px; }

    /* [UPDATE 3] Grid to g·∫•p 4 l·∫ßn (min 220px) */
    .item-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
        gap: 20px;
    }

    .item-card {
        aspect-ratio: 1/1; background: var(--input-bg);
        border: 2px solid transparent; border-radius: 24px;
        position: relative; cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        overflow: hidden;
    }

    .item-card:hover { transform: translateY(-8px); border-color: var(--primary); background: #fff; box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
    .item-card.active { border-color: var(--success); background: rgba(5, 205, 153, 0.05); box-shadow: inset 0 0 0 2px var(--success); }
    
    /* [UPDATE 5] Locked Item Style */
    .item-card.locked {
        cursor: not-allowed;
        filter: grayscale(100%);
        opacity: 0.7;
    }
    .item-card.locked:hover { transform: none; border-color: transparent; box-shadow: none; }
    
    .lock-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.1); z-index: 5;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: #555; font-weight: bold; font-size: 1.2rem;
    }

    .equipped-badge {
        position: absolute; top: 12px; right: 12px;
        background: var(--success); color: white; width: 28px; height: 28px; border-radius: 50%;
        font-size: 14px; display: flex; align-items: center; justify-content: center;
        z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* [UPDATE 1] Item Preview To Nh·∫•t C√≥ Th·ªÉ */
    .item-preview {
        width: 100%; height: 100%; padding: 15px; /* Padding nh·ªè ƒë·ªÉ h√¨nh to ra */
        display: flex; align-items: center; justify-content: center;
        z-index: 1; /* Th·∫•p h∆°n gi√° ti·ªÅn */
    }
    .item-preview img, .item-preview lottie-player {
        width: 100%; height: 100%; object-fit: contain;
    }

    .item-meta {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: rgba(255,255,255,0.95); padding: 8px 0;
        text-align: center; font-size: 0.9rem; font-weight: 700; color: var(--text-dark);
        transform: translateY(100%); transition: transform 0.2s; z-index: 11;
        backdrop-filter: blur(4px);
    }
    .item-card:hover .item-meta { transform: translateY(0); }
    
    /* [UPDATE 4] Price Tag Z-Index Fix */
    .price-tag {
        position: absolute; top: 12px; right: 12px;
        background: var(--card-bg); color: var(--text-dark);
        padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 800;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 4px;
        z-index: 10; /* Cao h∆°n Lottie */
    }

    .nav-pills .nav-link { 
        border-radius: 12px; font-weight: 700; padding: 12px 25px;
        background: var(--input-bg); color: var(--secondary); margin-right: 15px;
    }
    .nav-pills .nav-link.active { background: var(--primary); color: #fff; box-shadow: 0 5px 15px rgba(67, 24, 255, 0.3); }

</style>
{% endblock %}

{% block content %}

<div class="flex-stage-wrapper" id="stage-area">
    <div class="stage-bg"></div>
    <div class="position-absolute top-0 start-50 translate-middle-x mt-3 text-white-50 small" style="z-index: 5;">
        <i class="fas fa-hand-pointer me-1"></i> K√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp g√≥c Flex
    </div>

    <div class="draggable-item" id="drag-avatar" onclick="interactElement(this)">
        <div class="avatar-wrapper">
            {% if user.AvatarFrame %}
            <div class="frame-lottie">
                <lottie-player src="{{ url_for('static', filename='assets/json/' + user.AvatarFrame + '.json') }}" background="transparent" speed="1" loop autoplay></lottie-player>
            </div>
            {% endif %}
            <img src="{{ user.AvatarUrl if user.AvatarUrl else url_for('static', filename='img/default_avatar.png') }}" class="main-avatar">
            <div class="stage-info">
                {% if user.Title %}<div class="stage-title"><i class="fas fa-crown me-1"></i>{{ user.Title }}</div>{% endif %}
                <div class="stage-name">{{ user.SHORTNAME or user.USERNAME }}</div>
            </div>
        </div>
    </div>

    {% if user.EquippedPet %}
    <div class="draggable-item" id="drag-pet" style="left: 70%; top: 60%;" onclick="interactElement(this)">
        <div class="pet-wrapper">
            <div class="chat-bubble">Ch√†o s·∫øp! ü¶ä</div>
            <lottie-player src="{{ url_for('static', filename='assets/json/' + user.EquippedPet + '.json') }}" background="transparent" speed="1" loop autoplay></lottie-player>
        </div>
    </div>
    {% endif %}
    
    <div class="position-absolute bottom-0 end-0 p-4" style="z-index: 20;">
        <button class="btn btn-light rounded-circle shadow-lg" style="width: 50px; height: 50px;" onclick="document.getElementById('avatar-upload').click()"><i class="fas fa-camera text-primary"></i></button>
        <input type="file" id="avatar-upload" hidden accept="image/*" onchange="uploadAvatar(this)">
    </div>
</div>

<div class="container profile-body">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-4 text-primary"><i class="fas fa-id-card me-2"></i>H·ªì s∆°</h5>
                <div class="text-center mb-4">
                    <h2 class="fw-bold m-0">{{ user.USERNAME }}</h2>
                    <p class="text-muted">{{ user['CHUC VU'] }}</p>
                </div>
                <div class="info-row"><span class="info-label">Level</span><span class="info-val fw-bold text-dark">{{ user.Level }}</span></div>
                <div class="xp-bar-container"><div class="xp-bar-fill" style="width: {{ user.ProgressPercent }}%"></div></div>
                <div class="bg-light p-3 rounded-4 mt-3 d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center"><i class="fas fa-coins text-warning fa-2x me-3"></i><div><div class="small text-muted fw-bold">Coins</div><h4 class="mb-0 fw-bold">{{ "{:,}".format(user.TotalCoins) }}</h4></div></div>
                    <button class="btn btn-sm btn-primary rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#changePassModal"><i class="fas fa-key"></i></button>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="glass-card p-4">
                <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-inventory"><i class="fas fa-box-open me-2"></i>T√∫i ƒë·ªì</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-shop"><i class="fas fa-store me-2"></i>C·ª≠a h√†ng</button></li>
                </ul>

                <div class="tab-content">
                    
                    <div class="tab-pane fade show active" id="tab-inventory">
                        {% if inventory %}
                            <div class="category-header"><i class="fas fa-paw me-2 text-warning"></i>Th√∫ c∆∞ng (Pets)</div>
                            <div class="item-grid">
                                {# L·ªçc c√°c item c√≥ Type l√† PET ho·∫∑c m√£ c√≥ ch·ªØ 'pet' #}
                                {% for item in inventory if item.ItemType.strip().upper() == 'PET' %}
                                    <div class="item-card {{ 'active' if item.ItemCode == user.EquippedPet }}" onclick="equipItem('{{ item.ItemCode }}')">
                                        {% if item.ItemCode == user.EquippedPet %}<div class="equipped-badge"><i class="fas fa-check"></i></div>{% endif %}
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemCode|capitalize }}</div>
                                    </div>
                                {% else %}<div class="text-muted small fst-italic">Tr·ªëng.</div>{% endfor %}
                            </div>

                            <div class="category-header mt-4"><i class="fas fa-crop-alt me-2 text-info"></i>Khung (Frames)</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType == 'FRAME' or 'frame' in item.ItemCode %}
                                    <div class="item-card {{ 'active' if item.ItemCode == user.AvatarFrame }}" onclick="equipItem('{{ item.ItemCode }}')">
                                        {% if item.ItemCode == user.AvatarFrame %}<div class="equipped-badge"><i class="fas fa-check"></i></div>{% endif %}
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemCode }}</div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="category-header mt-4"><i class="fas fa-palette me-2 text-danger"></i>Themes</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType == 'THEME' or item.ItemCode in ['light', 'dark', 'fantasy', 'adorable'] %}
                                    <div class="item-card {{ 'active' if item.ItemCode == user.ThemeColor }}" onclick="equipItem('{{ item.ItemCode }}')">
                                        {% if item.ItemCode == user.ThemeColor %}<div class="equipped-badge"><i class="fas fa-check"></i></div>{% endif %}
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemCode|capitalize }}</div>
                                    </div>
                                {% endfor %}
                            </div>

                            <div class="category-header mt-4"><i class="fas fa-bolt me-2 text-warning"></i>K·ªπ nƒÉng</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType.strip().upper() == 'SKILL' %}
                                    <div class="item-card" onclick="equipItem('{{ item.ItemCode }}')">
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemCode|capitalize }}</div>
                                    </div>
                                {% else %}<div class="text-muted small fst-italic">Tr·ªëng.</div>{% endfor %}
                            </div>

                            <div class="category-header mt-4"><i class="fas fa-tree me-2 text-success"></i>Trang tr√≠</div>
                            <div class="item-grid">
                                {% for item in inventory if item.ItemType.strip().upper() == 'DECOR' %}
                                    <div class="item-card" onclick="equipItem('{{ item.ItemCode }}')">
                                        <div class="item-preview">
                                            <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                        </div>
                                        <div class="item-meta">{{ item.ItemCode|capitalize }}</div>
                                    </div>
                                {% else %}<div class="text-muted small fst-italic">Tr·ªëng.</div>{% endfor %}
                            </div>

                        {% else %}
                            <div class="text-center py-5"><p class="text-muted">T√∫i ƒë·ªì tr·ªëng.</p></div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="tab-shop">
                        
                        <div class="category-header"><i class="fas fa-paw me-2 text-warning"></i>Mua Th√∫ c∆∞ng</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType == 'PET' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    
                                    {% if is_locked %}
                                        <div class="lock-overlay"><i class="fas fa-lock mb-2"></i> Lv.{{ item.MinLevel }}</div>
                                    {% else %}
                                        <div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>
                                    {% endif %}
                                    
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="category-header mt-4"><i class="fas fa-crop-alt me-2 text-info"></i>Mua Khung Avatar</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType == 'FRAME' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    {% if is_locked %}<div class="lock-overlay"><i class="fas fa-lock mb-2"></i> Lv.{{ item.MinLevel }}</div>
                                    {% else %}<div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>{% endif %}
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="category-header mt-4"><i class="fas fa-palette me-2 text-danger"></i>Mua Giao di·ªán</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType == 'THEME' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    {% if is_locked %}<div class="lock-overlay"><i class="fas fa-lock mb-2"></i> Lv.{{ item.MinLevel }}</div>
                                    {% else %}<div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>{% endif %}
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="category-header mt-4"><i class="fas fa-bolt me-2 text-warning"></i>Mua K·ªπ nƒÉng</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType.strip().upper() == 'SKILL' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    {% if is_locked %}<div class="lock-overlay"><i class="fas fa-lock mb-2"></i> Lv.{{ item.MinLevel }}</div>
                                    {% else %}<div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>{% endif %}
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="category-header mt-4"><i class="fas fa-tree me-2 text-success"></i>Mua ƒê·ªì Trang tr√≠</div>
                        <div class="item-grid">
                            {% for item in items if item.ItemType.strip().upper() == 'DECOR' %}
                                {% set is_locked = item.MinLevel > user.Level %}
                                <div class="item-card {{ 'locked' if is_locked }}" 
                                     onclick="{{ 'alertLocked(' + item.MinLevel|string + ')' if is_locked else 'buyItem(\'' + item.ItemCode + '\', ' + item.Price|string + ')' }}">
                                    {% if is_locked %}<div class="lock-overlay"><i class="fas fa-lock mb-2"></i> Lv.{{ item.MinLevel }}</div>
                                    {% else %}<div class="price-tag"><i class="fas fa-coins text-warning"></i>{{ item.Price }}</div>{% endif %}
                                    <div class="item-preview">
                                        <lottie-player src="{{ url_for('static', filename='assets/json/' + item.ItemCode + '.json') }}" background="transparent" speed="1" loop hover></lottie-player>
                                    </div>
                                    <div class="item-meta">{{ item.ItemName }}</div>
                                </div>
                            {% endfor %}
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="changePassModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ƒê·ªïi m·∫≠t kh·∫©u</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="password" id="old-pass" class="form-control mb-3" placeholder="M·∫≠t kh·∫©u c≈©">
                <input type="password" id="new-pass" class="form-control" placeholder="M·∫≠t kh·∫©u m·ªõi">
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-100" onclick="changePassword()">X√°c nh·∫≠n ƒë·ªïi</button></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- DRAG LOGIC ---
    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = dragMouseDown;
        function dragMouseDown(e) { e = e || window.event; pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
        function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
    }
    document.addEventListener('DOMContentLoaded', function() {
        dragElement(document.getElementById("drag-avatar"));
        const pet = document.getElementById("drag-pet");
        if(pet) dragElement(pet);
    });
    function interactElement(el) {
        el.classList.add('interact-anim'); setTimeout(() => el.classList.remove('interact-anim'), 500);
        if(el.id === 'drag-pet') {
            const msgs = ["Ch√†o s·∫øp!", "C·ªë l√™n!", "Titan OS x·ªãn!", "ƒê√≥i qu√°..."];
            const bubble = el.querySelector('.chat-bubble');
            if(bubble) { bubble.innerText = msgs[Math.floor(Math.random()*msgs.length)]; bubble.style.opacity=1; setTimeout(()=>bubble.style.opacity=0, 3000); }
        }
    }

    // --- GAME LOGIC ---
    function alertLocked(level) { alert(`üîí V·∫≠t ph·∫©m n√†y y√™u c·∫ßu Level ${level} ƒë·ªÉ m·ªü kh√≥a!`); }

    function uploadAvatar(input) {
        if (input.files && input.files[0]) {
            const formData = new FormData(); formData.append('avatar', input.files[0]); // <-- ƒê·ªïi th√†nh 'avatar'
            fetch('/api/user/upload_avatar', {method: 'POST', body: formData}).then(r=>r.json()).then(data=>{
                if(data.success) { location.reload(); } else alert(data.message);
            });
        }
    }

    function buyItem(itemCode, price) {
        if(!confirm(`Mua v·ªõi gi√° ${price} Coins?`)) return;
        fetch('/api/user/buy_item', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ item_code: itemCode })})
        .then(r=>r.json()).then(res=>{ alert(res.message); if(res.success) location.reload(); });
    }

    function equipItem(itemCode) {
        fetch('/api/user/equip_item', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ item_code: itemCode })})
        .then(r=>r.json()).then(res=>{ 
            if(res.success) {
                if(['light','dark','fantasy','adorable'].includes(itemCode)) {
                    document.documentElement.setAttribute('data-theme', itemCode);
                    localStorage.setItem('titan_theme', itemCode);
                }
                alert(res.message); location.reload();
            } else alert(res.message);
        });
    }
    
    function changePassword() {
        const o = document.getElementById('old-pass').value; const n = document.getElementById('new-pass').value;
        if(!o||!n) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin");
        fetch('/api/user/change_password', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({old_pass: o, new_pass: n})})
        .then(r=>r.json()).then(res=>{ alert(res.message); if(res.success) location.reload(); });
    }
</script>
{% endblock %}