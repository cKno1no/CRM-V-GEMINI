<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ Thống Quản Trị - CRM | KPI | CEQ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* ======================================= */
        /* THIẾT KẾ BACKGROUND (Giữ nguyên) */
        /* ======================================= */
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #3C4043;
            position: relative;
        }

        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://picsum.photos/1920/1080?'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed; 
            filter: grayscale(100%) brightness(1.1);
            z-index: -1;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: -1;
        }

        .content-wrapper {
            position: relative;
            z-index: 1;
            padding: 50px 0;
            max-width: 900px;
            margin: auto;
        }

        /* ======================================= */
        /* PHONG CÁCH MUZ.LI (Giữ nguyên) */
        /* ======================================= */
        h1 {
            font-weight: 900;
            font-size: 2.5rem;
            color: #212529; 
            border-bottom: 2px solid #E9ECEF;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        /* Accordion Style */
        .accordion-button {
            font-weight: 700;
            font-size: 1.25rem;
            color: #212529 !important;
            background-color: #FFFFFF !important; 
            border: 1px solid #E9ECEF;
            box-shadow: none;
            padding: 1rem 1.5rem;
        }
        .accordion-button:not(.collapsed) {
            background-color: #F8F9FA !important; 
            color: #3C4043 !important;
        }
        .accordion-item {
            border: none;
            margin-bottom: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* Menu Link Style */
        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 1.5rem;
            text-decoration: none;
            color: #3C4043;
            transition: background-color 0.15s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .menu-link:hover {
            background-color: #F8F9FA;
            color: #1A73E8;
            border-left: 3px solid #1A73E8;
        }

        .menu-link i {
            font-size: 1rem;
            width: 30px;
            color: #6C757D;
        }

        /* Màu sắc module đặc biệt */
        .module-crm i { color: #34A853; }
        .module-kpi i { color: #DB4437; } 
        .module-ceq i { color: #F4B400; }
        .module-title-crm i { color: #34A853; }
        .module-title-kpi i { color: #DB4437; }
        .module-title-ceq i { color: #F4B400; }
        
        /* Chữ mờ cho Dự kiến */
        .menu-link.planned {
            color: #ADB5BD;
            cursor: default;
        }
        .menu-link.planned i {
            color: #ADB5BD;
        }
    </style>
</head>
<body>
    <div class="background-container"></div>
    <div class="overlay"></div>

    <div class="content-wrapper">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div class="logo-box">
                </div>
            <a href="/logout" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
            </a>
        </header>

        <h1><i class="fas fa-sitemap me-3"></i> PORTAL ĐIỀU HÀNH</h1>
        <p class="text-muted">Chào mừng, <strong>{{ current_user.shortname }}</strong> ({{ current_user.usercode }}).</p>

        <div class="accordion" id="mainAccordion">

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingCRM">
                    <button class="accordion-button module-title-crm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCRM" aria-expanded="true" aria-controls="collapseCRM">
                        <i class="fas fa-users me-3"></i> CUSTOMER RELATIONSHIP MANAGEMENT
                    </button>
                </h2>
                <div id="collapseCRM" class="accordion-collapse collapse show" aria-labelledby="headingCRM" data-bs-parent="#mainAccordion">
                    <div class="accordion-body p-0">
                        <a href="/dashboard" class="menu-link module-crm" target="_blank">
                            <i class="fas fa-file-invoice me-3"></i> Dashboard Báo cáo & Lịch sử
                        </a>
                        <a href="/nhaplieu" class="menu-link module-crm" target="_blank">
                            <i class="fas fa-plus-circle me-3"></i> Lập Báo cáo Hiện diện Khách hàng
                        </a>
                        <a href="/task_dashboard" class="menu-link module-crm" target="_blank">
                            <i class="fas fa-tasks me-3"></i> Quản lý Đầu việc & Giao việc
                        </a>
                        <a href="/delivery_dashboard" class="menu-link module-crm" target="_blank">
                            <i class="fas fa-shipping-fast me-3"></i> Hoạch định & Thực thi giao vận
                        </a>
                        <a href="/x" class="menu-link module-crm" target="_blank">
                            <i class="fas fa-user-clock me-3"></i> Dự phòng & Đặt hàng tồn kho
                        </a>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingKPI">
                    <button class="accordion-button collapsed module-title-kpi" type="button" data-bs-toggle="collapse" data-bs-target="#collapseKPI" aria-expanded="false" aria-controls="collapseKPI">
                        <i class="fas fa-chart-bar me-3"></i> KEY PERFORMANCE INDICATOR & APPROVAL
                    </button>
                </h2>
                <div id="collapseKPI" class="accordion-collapse collapse" aria-labelledby="headingKPI" data-bs-parent="#mainAccordion">
                    <div class="accordion-body p-0">
                        <a href="/sales_dashboard" class="menu-link module-kpi" target="_blank">
                            <i class="fas fa-percent me-3"></i> Hiệu suất Sales & Mục tiêu
                        </a>
                        
                        <a href="/quote_approval" class="menu-link module-kpi" target="_blank">
                            <i class="fas fa-certificate me-3"></i> Theo dõi & Phê duyệt
                        </a>
                        
                        <a href="/quote_input_table" class="menu-link module-kpi" target="_blank">
                            <i class="fas fa-bullseye me-3"></i> Bám sát & Hành động
                        </a>
                        
                        {% set is_finance_user = current_user.role|upper == 'ADMIN' or current_user.bo_phan|upper == '6. KTTC' %}

                        <a href="{% if is_finance_user %}{{ url_for('kpi_bp.ar_aging_dashboard') }}{% else %}#{% endif %}" 
                           class="menu-link module-kpi {% if not is_finance_user %}planned{% endif %}" 
                           target="{% if is_finance_user %}_blank{% else %}_self{% endif %}">
                            <i class="fas fa-hand-holding-usd me-3"></i> Nhắc nợ & Thu tiền
                        </a>

                        <a href="/realtime_dashboard" class="menu-link module-kpi" target="_blank">
                            <i class="fas fa-tachometer-alt me-3"></i> Chỉ số kinh doanh - Realtime Dashboard
                        </a>
                        
                        <a href="/sales/sales_lookup" class="menu-link module-kpi" target="_blank">
                            <i class="fas fa-search-dollar me-3"></i> Tra cứu & truy xuất
                        </a>
                        
                        </div>
                </div>
            </div>

            {% if current_user.role|upper == 'ADMIN' %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingCEQ">
                    <button class="accordion-button collapsed module-title-ceq" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCEQ" aria-expanded="false" aria-controls="collapseCEQ">
                        <i class="fas fa-chart-pie me-3"></i> CAPITAL EFFICIENCY GOVERNANCE (CEQ)
                    </button>
                </h2>
                <div id="collapseCEQ" class="accordion-collapse collapse" aria-labelledby="headingCEQ" data-bs-parent="#mainAccordion">
                    <div class="accordion-body p-0">
                        <a href="/inventory_aging" class="menu-link module-ceq" target="_blank">
                            <i class="fas fa-warehouse me-3"></i> Phân tích Tuổi hàng Tồn kho (Aging)
                        </a>
                        <a href="/ar_aging" class="menu-link module-ceq" target="_blank">
                             <i class="fas fa-dollar-sign me-3"></i> Phân tích Công nợ (AR Aging)
                        </a>
                        <a href="#" class="menu-link planned"><i class="fas fa-flask me-3"></i> Dự kiến: Chi phí</a>
                        <a href="#" class="menu-link planned"><i class="fas fa-flask me-3"></i> Dự kiến: Dòng tiền</a>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <style>
        /* Nút nổi (Chat Toggle) */
        .chatbot-toggle {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background-color: #4285F4;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 9998;
            transition: transform 0.2s, background-color 0.2s;
        }
        .chatbot-toggle:hover {
            transform: scale(1.1);
            background-color: #1a73e8;
        }

        /* Cửa sổ Chat (Ẩn mặc định) */
        .chatbot-window {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 350px;
            max-width: 90vw; /* Giới hạn cho mobile */
            height: 450px;
            max-height: 70vh; /* Giới hạn cho mobile */
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            display: none; 
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s, height 0.3s, bottom 0.3s, right 0.3s;
        }
        .chatbot-window.active {
            display: flex; 
        }

        /* --- YÊU CẦU 7: CSS MAXIMIZE --- */
        .chatbot-window.maximized {
            width: 95vw;
            height: 85vh;
            max-height: 85vh;
            bottom: 2.5vh;
            right: 2.5vw;
        }
        /* --- KẾT THÚC YÊU CẦU 7 --- */


        /* Header */
        .chatbot-header {
            background-color: #4285F4;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
        }
        .chatbot-header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chatbot-control-btn {
            cursor: pointer; 
            font-size: 1.1rem;
            color: #E8F0FE;
            background: none;
            border: none;
            padding: 0 5px;
        }
        .chatbot-control-btn:hover {
            color: white;
        }


        /* Lịch sử Chat */
        .chatbot-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #F8F9FA;
            display: flex; /* Dùng flex để tin nhắn căn bottom */
            flex-direction: column; /* Tin nhắn xếp chồng lên nhau */
        }
        /* Đẩy tin nhắn lên trên */
        .chat-message-container {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            white-space: pre-wrap; 
            line-height: 1.5;
        }
        .chat-user {
            background-color: #E8F0FE;
            color: #1A73E8;
            align-self: flex-end; /* Đẩy sang phải */
            margin-left: 15%;
        }
        .chat-bot {
            background-color: #E9ECEF;
            color: #3C4043;
            align-self: flex-start; /* Đẩy sang trái */
            margin-right: 15%;
        }
        .chat-bot strong, .chat-bot b {
            color: #1A73E8;
        }
        .chat-bot i {
            color: #5F6368;
        }

        /* Khung nhập liệu */
        .chatbot-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #E0E0E0;
        }
        .chatbot-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 8px 15px;
            outline: none;
        }
        .chatbot-send-btn {
            background: none;
            border: none;
            color: #4285F4;
            font-size: 1.5rem;
            margin-left: 10px;
            cursor: pointer;
        }
    </style>

    <div class="chatbot-toggle" id="chatbotToggle">
        <i class="fas fa-robot"></i>
    </div>

    <div class="chatbot-window" id="chatbotWindow">
        <div class="chatbot-header" id="chatbotHeader">
            <span>Trợ lý Ảo (AI)</span>
            <div class="chatbot-header-controls">
                <button class="chatbot-control-btn" id="chatbotMaximizeBtn" title="Mở rộng">
                    <i class="fas fa-expand-alt"></i>
                </button>
                <button class="chatbot-control-btn" id="chatbotClose" title="Đóng">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="chatbot-history" id="chatbotHistory">
            <div class="chat-message-container">
                <div class="chat-message chat-bot">
                    <br>Chào bạn, tôi có thể giúp gì?<br>                                       
                    <br>1. <strong>22212 NSK C3</strong> (Tra nhanh tồn kho)
                    <br>2. <strong>Giá 22214 cho Vina Kraft</strong> (Tra giá KH)
                    <br>3. <strong>Takako mua spray nine chưa</strong> (Lịch sử mua hàng)
                    <br>4. <strong>Dự phòng Kiswire mã AB</strong> (Đặt Dự phòng)
                    <br>5. <strong>Giao hàng cho Takako chưa</strong> (Tiến độ giao hàng)
                </div>
            </div>
        </div>
        
        <div class="chatbot-input-area">
            <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Nhập câu hỏi...">
            <button class="chatbot-send-btn" id="chatbotSendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const toggleBtn = document.getElementById('chatbotToggle');
        const closeBtn = document.getElementById('chatbotClose');
        const maximizeBtn = document.getElementById('chatbotMaximizeBtn'); // (Yêu cầu 7)
        const windowEl = document.getElementById('chatbotWindow');
        const historyEl = document.getElementById('chatbotHistory');
        const inputEl = document.getElementById('chatbotInput');
        const sendBtn = document.getElementById('chatbotSendBtn');

        // Mở/Đóng cửa sổ chat
        toggleBtn.addEventListener('click', () => windowEl.classList.toggle('active'));
        closeBtn.addEventListener('click', () => windowEl.classList.remove('active'));

        // --- YÊU CẦU 7: LOGIC MAXIMIZE ---
        maximizeBtn.addEventListener('click', () => {
            windowEl.classList.toggle('maximized');
            const icon = maximizeBtn.querySelector('i');
            if (windowEl.classList.contains('maximized')) {
                icon.classList.remove('fa-expand-alt');
                icon.classList.add('fa-compress-alt');
                maximizeBtn.title = "Thu nhỏ";
            } else {
                icon.classList.add('fa-expand-alt');
                icon.classList.remove('fa-compress-alt');
                maximizeBtn.title = "Mở rộng";
            }
        });
        // --- KẾT THÚC YÊU CẦU 7 ---

        // Hàm gửi tin nhắn
        const sendMessage = () => {
            const messageText = inputEl.value.trim();
            if (messageText === '') return;

            addMessageToHistory(messageText, 'user');
            inputEl.value = '';
            addMessageToHistory('...', 'bot', true); // 'true' = loading
            
            // Gọi API (Backend)
            fetch('/api/chatbot_query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: messageText })
            })
            .then(response => response.json())
            .then(data => {
                updateBotMessage(data.response);
            })
            .catch(error => {
                console.error('Chatbot API Error:', error);
                updateBotMessage('Lỗi kết nối. Vui lòng thử lại.');
            });
        };

        // Đăng ký sự kiện
        sendBtn.addEventListener('click', sendMessage);
        inputEl.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- Helper Functions ---
        const messageContainer = document.createElement('div');
        messageContainer.className = 'chat-message-container';
        historyEl.appendChild(messageContainer);
        
        function addMessageToHistory(text, type, isLoading = false) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('chat-message');
            
            if (type === 'user') {
                msgDiv.classList.add('chat-user');
                msgDiv.textContent = text;
            } else {
                msgDiv.classList.add('chat-bot');
                if (isLoading) {
                    msgDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
                    msgDiv.id = 'bot-loading-message';
                } else {
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    text = text.replace(/\n/g, '<br>');
                    msgDiv.innerHTML = text;
                }
            }
            
            messageContainer.appendChild(msgDiv);
            historyEl.scrollTop = historyEl.scrollHeight;
        }
        
        function updateBotMessage(responseText) {
            const loadingMsg = document.getElementById('bot-loading-message');
            if (loadingMsg) {
                responseText = responseText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                responseText = responseText.replace(/\n/g, '<br>');
                loadingMsg.innerHTML = responseText;
                loadingMsg.removeAttribute('id'); 
            } else {
                addMessageToHistory(responseText, 'bot');
            }
            historyEl.scrollTop = historyEl.scrollHeight;
        }

    });
    </script>
</body>
</html>