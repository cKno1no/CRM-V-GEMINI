{% extends "base.html" %}

{% block title %}Chi Tiết Báo Cáo #{{ report['STT'] }} | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* INFO GRID */
    .info-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;
    }
    .info-grid-item dt { font-size: 0.85rem; font-weight: 500; color: var(--secondary); margin-bottom: 5px; text-transform: uppercase; }
    .info-grid-item dd { font-size: 1rem; font-weight: 600; color: var(--text-dark); margin: 0; }

    /* RESULT BOX */
    .result-box {
        padding: 15px; background-color: var(--input-bg); border-radius: 12px; margin-bottom: 10px;
        border: 1px solid var(--border-color);
    }
    .result-box h6 { font-weight: 600; color: var(--primary); font-size: 0.9rem; margin-bottom: 5px; }
    .result-box p { font-weight: 500; font-size: 1rem; color: var(--text-dark); margin-bottom: 0; white-space: pre-wrap; }

    /* RICH TEXT CONTENT */
    .report-content-flow { line-height: 1.7; font-size: 1rem; color: var(--text-dark); }
    .report-content-flow img { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; }
    
    /* Header Colors */
    .card-header-custom.content-header { background-color: var(--input-bg); color: var(--primary); }
    .card-header-custom.result-header { background-color: rgba(255, 181, 71, 0.1); color: var(--warning); }
    .card-header-custom.result-header i { color: var(--warning); }

    /* Attachments */
    .attachment-link {
        display: block; padding: 12px 15px; border-radius: 12px;
        background-color: var(--input-bg); color: var(--primary);
        font-weight: 600; text-decoration: none; transition: all 0.2s; border: 1px solid var(--border-color);
    }
    .attachment-link:hover { background-color: var(--primary-light); transform: translateX(5px); border-color: var(--primary); }

    @media (max-width: 768px) { .info-grid { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block page_title %}Chi Tiết Báo Cáo <span class="text-primary">#{{ report['STT'] }}</span>{% endblock %}
{% block page_sub %}Ngày tạo: {{ report['NGAY'] }}{% endblock %}

{% block header_actions %}
<a href="javascript:history.back()" class="btn btn-back"><i class="fas fa-arrow-left me-2"></i>Quay lại</a>
{% endblock %}

{% block content %}
    <div class="main-card">
        <div class="card-header-custom">
            <span><i class="fas fa-user-tag me-2 text-primary"></i> 1. Thông Tin Chung</span>
        </div>
        <div class="card-body-custom">
            <div class="info-grid">
                <div class="info-grid-item">
                    <dt>Ngày Báo Cáo</dt>
                    <dd>{{ report['NGAY'] }}</dd>
                </div>
                <div class="info-grid-item">
                    <dt>Người Báo Cáo</dt>
                    <dd>{{ report['HO TEN'] | default(report['NGUOI']) }}</dd>
                </div>
                <div class="info-grid-item">
                    <dt>Loại Báo Cáo</dt>
                    <dd>{{ report['DIEN GIAI'] | default(report['LOAI']) }}</dd>
                </div>
                <div class="info-grid-item" style="grid-column: 1 / -1;">
                    <dt>Khách Hàng</dt>
                    <dd>{{ report['TEN DOI TUONG'] | default(report['KHACH HANG']) }} <span class="text-muted fw-normal">({{ report['KHACH HANG'] }})</span></dd>
                </div>
            </div>
        </div>
    </div>

    {% if report['STT'] is defined and report['STT'] < 51799 %}
        {% set legacy_names = {
            'NOI DUNG 1': 'Nội Dung 1', 'NOI DUNG 2': 'Nội Dung 2', 'NOI DUNG 3': 'Nội Dung 3', 'NOI DUNG 4': 'Nội Dung 4',
            'DANH GIA 1': 'Đánh Giá 1', 'DANH GIA 2': 'Đánh Giá 2', 'DANH GIA 3': 'Đánh Giá 3', 'DANH GIA 4': 'Đánh Giá 4'
        } %}
        {% for field, label in legacy_names.items() %}
            {% if report[field] and report[field]|striptags|trim %}
                <div class="main-card">
                    <div class="card-header-custom content-header"><i class="fas fa-folder-open me-2"></i> {{ label }}</div>
                    <div class="card-body-custom report-content-flow">{{ report[field] | safe }}</div>
                </div>
            {% endif %}
        {% endfor %}

    {% else %}
        <div class="main-card">
            <div class="card-header-custom result-header">
                <span><i class="fas fa-poll-h me-2"></i> 2. Phân Loại & Kết Quả</span>
            </div>
            <div class="card-body-custom">
                {% if report['TEN_ND4'] or report['NOI DUNG 4'] %}
                <div class="result-box"><h6>{{ report['TEN_ND4'] or 'Mục đích' }}</h6><p>{{ report['NOI DUNG 4'] or '—' }}</p></div>
                {% endif %}
                {% if report['TEN_ND5'] or report['NOI DUNG 5'] %}
                <div class="result-box"><h6>{{ report['TEN_ND5'] or 'Kết quả' }}</h6><p>{{ report['NOI DUNG 5'] or '—' }}</p></div>
                {% endif %}
                {% if report['TEN_DG4'] or report['DANH GIA 4'] %}
                <div class="result-box"><h6>{{ report['TEN_DG4'] or 'Hành động tiếp theo' }}</h6><p>{{ report['DANH GIA 4'] or '—' }}</p></div>
                {% endif %}
            </div>
        </div>

        {% if report['DANH GIA 2'] and report['DANH GIA 2']|striptags|trim %}
        <div class="main-card">
            <div class="card-header-custom content-header"><i class="fas fa-pen me-2"></i> {{ report['TEN_TAB_A'] or 'Nội dung chính' }}</div>
            <div class="card-body-custom report-content-flow">{{ report['DANH GIA 2'] | safe }}</div>
        </div>
        {% endif %}
        
        {% if report['NOI DUNG 2'] and report['NOI DUNG 2']|striptags|trim %}
        <div class="main-card">
            <div class="card-header-custom content-header"><i class="fas fa-align-left me-2"></i> {{ report['TEN_TAB_B'] or 'Nội dung mở rộng' }}</div>
            <div class="card-body-custom report-content-flow">{{ report['NOI DUNG 2'] | safe }}</div>
        </div>
        {% endif %}
    {% endif %}

    {% if report.attachments and report.attachments|length > 0 %}
    <div class="main-card">
        <div class="card-header-custom"><span><i class="fas fa-paperclip me-2 text-secondary"></i> Tệp Đính Kèm</span></div>
        <div class="card-body-custom">
            <div class="d-grid gap-2">
            {% for file_path in report.attachments %}
                {% set file_name = file_path.split('/')[-1] %}
                <a href="{{ url_for('static', filename='attachments/' + file_name) }}" target="_blank" class="attachment-link">
                    <i class="fas fa-file-arrow-down me-2"></i> {{ file_name }}
                </a>
            {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}