{% extends "base.html" %}

{% block title %}Phân Tích Lợi Nhuận | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* KPI CARDS */
    .kpi-card { 
        border: none; border-radius: 16px; padding: 20px; color: white; 
        box-shadow: var(--shadow-sm); height: 100%; 
        position: relative; overflow: hidden;
    }
    .kpi-title { font-size: 0.85rem; font-weight: 600; opacity: 0.9; letter-spacing: 0.5px; text-transform: uppercase; }
    .kpi-value { font-size: 1.8rem; font-weight: 800; margin-top: 10px; }
    
    /* Gradients giữ nguyên vì là màu chỉ báo đặc thù */
    .bg-revenue { background: linear-gradient(135deg, #4318FF 0%, #7B61FF 100%); }
    .bg-cogs { background: linear-gradient(135deg, #FFB547 0%, #FFCA85 100%); }
    .bg-profit { background: linear-gradient(135deg, #05CD99 0%, #0BE8B0 100%); }
    .bg-margin { background: linear-gradient(135deg, #E31A1A 0%, #FF5F5F 100%); }

    /* TABLE STYLES */
    .table { 
        width: 100%; margin-bottom: 0; border-collapse: separate; border-spacing: 0;
    }
    
    .table thead th { 
        background-color: var(--input-bg); color: var(--secondary); 
        font-weight: 700; font-size: 0.8rem; text-transform: uppercase; 
        padding: 15px; border-bottom: 2px solid var(--border-color); cursor: pointer;
        white-space: nowrap;
    }
    .table thead th:hover { color: var(--primary); }
    
    .table td { 
        vertical-align: middle; font-size: 0.9rem; border-bottom: 1px solid var(--border-color); 
        padding: 12px 15px; color: var(--text-dark);
    }

    /* Hierarchy Rows - Thích ứng Theme */
    /* Level 1: Customer */
    .row-lvl-1 { background-color: var(--card-bg); font-weight: 700; cursor: pointer; }
    .row-lvl-1:hover { background-color: var(--input-bg); }
    
    /* Level 2: Order */
    .row-lvl-2 { background-color: var(--input-bg); cursor: pointer; display: none; }
    .row-lvl-2 td { border-bottom: 1px dashed var(--border-color); color: var(--text-dark); opacity: 0.9; }
    .row-lvl-2:hover { background-color: rgba(0,0,0,0.05); }

    /* Level 3: Item */
    .row-lvl-3 { background-color: var(--bg-color); display: none; }
    .row-lvl-3 td { font-size: 0.85rem; color: var(--secondary); border-bottom: 1px solid var(--border-color); }
    
    /* Icons & Text Colors */
    .icon-expand { transition: transform 0.2s; display: inline-block; }
    .expanded .icon-expand { transform: rotate(90deg); }
    
    .text-loss { color: var(--danger) !important; }
    .text-success-custom { color: var(--success) !important; }
    
    .filter-box { 
        background: var(--card-bg); padding: 8px 15px; 
        border-radius: 12px; border: 1px solid var(--border-color);
        display: flex; align-items: center; gap: 10px;
    }
    .sort-icon { margin-left: 5px; font-size: 0.7rem; color: var(--secondary); }
    .sort-active { color: var(--primary); }

    /* Mobile Responsive */
    @media (max-width: 992px) {
        .filter-container { flex-direction: column; width: 100%; gap: 10px; }
        .filter-box { width: 100%; }
        .table th:nth-child(2), .table td:nth-child(2) {
            position: sticky; left: 0; background-color: var(--card-bg); z-index: 5;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); max-width: 150px;
        }
        .row-lvl-2 td:nth-child(2) { background-color: var(--input-bg); }
    }
</style>
{% endblock %}

{% block page_title %}Phân Tích Lợi Nhuận{% endblock %}
{% block page_sub %}Hiệu quả kinh doanh theo Khách hàng & Đơn hàng{% endblock %}

{% block header_actions %}
<div class="d-flex gap-2 filter-container">
    <div class="filter-box">
        <i class="fas fa-search text-muted"></i>
        <input type="text" id="quickSearch" class="form-control form-control-sm border-0 shadow-none p-0 bg-transparent" 
               placeholder="Tìm nhanh...">
    </div>

    <form class="filter-box" method="POST">
        <input type="date" name="date_from" class="form-control form-control-sm border-0 bg-transparent p-0" value="{{ date_from }}" style="width: 110px;">
        <i class="fas fa-arrow-right text-muted small"></i>
        <input type="date" name="date_to" class="form-control form-control-sm border-0 bg-transparent p-0" value="{{ date_to }}" style="width: 110px;">
        <button type="submit" class="btn btn-primary btn-sm rounded-circle shadow-sm" style="width: 30px; height: 30px; padding: 0;">
            <i class="fas fa-filter"></i>
        </button>
    </form>
</div>
{% endblock %}

{% block content %}
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
            <div class="kpi-card bg-revenue">
                <div class="kpi-title">DOANH THU</div>
                <div class="kpi-value">{{ summary.Revenue | format_tr }}</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card bg-cogs">
                <div class="kpi-title">GIÁ VỐN</div>
                <div class="kpi-value">{{ summary.COGS | format_tr }}</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card bg-profit">
                <div class="kpi-title">LÃI GỘP</div>
                <div class="kpi-value">{{ summary.GrossProfit | format_tr }}</div>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card bg-margin">
                <div class="kpi-title">% MARGIN</div>
                <div class="kpi-value">{{ "{:.1f}%".format(summary.AvgMargin) }}</div>
            </div>
        </div>
    </div>

    <div class="main-card">
        <div class="table-responsive">
            <table class="table" id="mainTable">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th onclick="sortTable('name')">ĐỐI TƯỢNG <i class="fas fa-sort sort-icon"></i></th>
                        <th onclick="sortTable('sales')">NV <i class="fas fa-sort sort-icon"></i></th>
                        <th class="text-end" onclick="sortTable('revenue')">DOANH THU <i class="fas fa-sort sort-icon"></i></th>
                        <th class="text-end">GIÁ VỐN</th>
                        <th class="text-end" onclick="sortTable('profit')">LÃI GỘP <i class="fas fa-sort-down sort-active sort-icon"></i></th>
                        <th class="text-center" onclick="sortTable('margin')">% <i class="fas fa-sort sort-icon"></i></th>
                        <th class="text-center" style="width: 80px;">#</th>
                    </tr>
                </thead>
                
                {% if details %}
                    {% for cust in details %}
                    {% set cust_loop = loop %}
                    <tbody class="customer-group" 
                           data-name="{{ cust.Name }} {{ cust.ID }}" 
                           data-sales="{{ cust.SalesMan }}"
                           data-revenue="{{ cust.Revenue }}"
                           data-profit="{{ cust.Profit }}"
                           data-margin="{{ cust.Margin }}">
                        
                        <tr class="row-lvl-1" onclick="toggleLvl1('grp-{{ cust_loop.index }}', this)">
                            <td class="text-center"><i class="fas fa-chevron-right icon-expand text-primary"></i></td>
                            <td>
                                <div class="text-truncate fw-bold" style="max-width: 300px;" title="{{ cust.Name }}">{{ cust.Name }}</div>
                                <div class="small text-muted">{{ cust.ID }}</div>
                            </td>
                            <td class="text-muted small">{{ cust.SalesMan }}</td>
                            <td class="text-end fw-bold">{{ cust.Revenue | format_tr }}</td>
                            <td class="text-end text-muted">{{ cust.COGS | format_tr }}</td>
                            <td class="text-end fw-bold {{ 'text-loss' if cust.Profit < 0 else 'text-success-custom' }}">{{ cust.Profit | format_tr }}</td>
                            <td class="text-center fw-bold {{ 'text-loss' if cust.Margin < 10 else '' }}">{{ "{:.1f}%".format(cust.Margin) }}</td>
                            <td class="text-center" onclick="event.stopPropagation()">
                                <a href="/customer_360/{{ cust.ID }}" target="_blank" 
                                   class="btn btn-sm btn-light border shadow-sm text-primary"
                                   data-bs-toggle="tooltip" title="360° View">
                                    <i class="fas fa-chart-pie"></i>
                                </a>
                            </td>
                        </tr>

                        {% for order in cust.Orders %}
                        {% set order_loop = loop %}
                        <tr class="row-lvl-2 grp-{{ cust_loop.index }} search-item" 
                            data-search="{{ order.SoDonHang }} {{ order.VoucherNo }}"
                            onclick="toggleLvl2('ord-{{ cust_loop.index }}-{{ order_loop.index }}', this)">
                            <td class="text-center"><i class="fas fa-caret-right icon-expand text-secondary"></i></td>
                            <td class="ps-4">
                                <span class="fw-bold">{{ order.SoDonHang }}</span>
                                <span class="badge bg-white text-dark border ms-2">{{ order.VoucherNo }}</span>
                            </td>
                            <td class="small text-muted">{{ order.Date | format_date }}</td>
                            <td class="text-end">{{ order.Revenue | format_tr }}</td>
                            <td class="text-end small">{{ order.COGS | format_tr }}</td>
                            <td class="text-end {{ 'text-loss' if order.Profit < 0 else '' }}">{{ order.Profit | format_tr }}</td>
                            <td class="text-center small {{ 'text-loss' if order.Margin < 10 else 'text-muted' }}">{{ "{:.1f}%".format(order.Margin) }}</td>
                            <td></td>
                        </tr>

                        {% for item in order.Items %}
                        <tr class="row-lvl-3 ord-{{ cust_loop.index }}-{{ order_loop.index }} search-item" data-search="{{ item.MaHang }} {{ item.TenHang }}">
                            <td></td>
                            <td class="ps-5">
                                <div class="small fw-bold">{{ item.MaHang }}</div>
                                <div class="text-muted text-truncate small" style="max-width: 250px;">{{ item.TenHang }}</div>
                            </td>
                            <td class="small text-muted">SL: {{ item.SoLuong | format_number }}</td>
                            <td class="text-end small">{{ item.DoanhThu | format_tr }}</td>
                            <td class="text-end small text-muted">{{ item.GiaVon | format_tr }}</td>
                            <td class="text-end small {{ 'text-loss' if item.LaiGop < 0 else 'text-success-custom' }}">{{ item.LaiGop | format_tr }}</td>
                            <td class="text-center small {{ 'text-loss' if item.TyLeLaiGop < 10 else 'text-muted' }}">{{ "{:.1f}%".format(item.TyLeLaiGop) }}</td>
                            <td></td>
                        </tr>
                        {% endfor %} {% endfor %} 
                    </tbody>
                    {% endfor %} 
                {% else %}
                    <tbody><tr><td colspan="8" class="text-center py-5 text-muted">Không có dữ liệu phù hợp.</td></tr></tbody>
                {% endif %}
            </table>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Init Tooltips
    document.addEventListener("DOMContentLoaded", function(){
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });

    // 1. EXPAND/COLLAPSE LOGIC
    function toggleLvl1(groupId, row) {
        row.classList.toggle('expanded');
        const isExpanded = row.classList.contains('expanded');
        const lv2Rows = document.getElementsByClassName(groupId);
        
        for (let r of lv2Rows) {
            if (isExpanded) {
                r.style.display = 'table-row';
            } else {
                r.style.display = 'none';
                r.classList.remove('expanded');
                const subGroupId = r.getAttribute('onclick').match(/'([^']+)'/)[1];
                const lv3Rows = document.getElementsByClassName(subGroupId);
                for(let r3 of lv3Rows) r3.style.display = 'none';
            }
        }
    }

    function toggleLvl2(subGroupId, row) {
        row.classList.toggle('expanded');
        const isExpanded = row.classList.contains('expanded');
        const lv3Rows = document.getElementsByClassName(subGroupId);
        for (let r of lv3Rows) {
            r.style.display = isExpanded ? 'table-row' : 'none';
        }
    }

    // 2. FILTER LOGIC
    function debounce(func, timeout = 500) {
        let timer;
        return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); };
    }

    function performFilter() {
        const input = document.getElementById('quickSearch');
        const filter = input.value.toLowerCase();
        const bodies = document.querySelectorAll('tbody.customer-group');

        bodies.forEach(body => {
            const custName = body.getAttribute('data-name').toLowerCase();
            const salesMan = body.getAttribute('data-sales').toLowerCase();
            let childText = '';
            body.querySelectorAll('.search-item').forEach(item => {
                childText += item.getAttribute('data-search') + ' ';
            });
            childText = childText.toLowerCase();

            if (custName.includes(filter) || salesMan.includes(filter) || childText.includes(filter)) {
                body.style.display = "";
                if (filter.length > 2 && childText.includes(filter)) {
                    const rowLvl1 = body.querySelector('.row-lvl-1');
                    if (!rowLvl1.classList.contains('expanded')) {
                        rowLvl1.click(); // Auto expand if match child
                    }
                }
            } else {
                body.style.display = "none";
            }
        });
    }
    document.getElementById('quickSearch').addEventListener('input', debounce(performFilter));

    // 3. SORT LOGIC
    let currentSort = { column: 'profit', dir: 'desc' };

    function sortTable(column) {
        const table = document.getElementById('mainTable');
        const bodies = Array.from(document.querySelectorAll('tbody.customer-group'));
        
        if (currentSort.column === column) {
            currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.dir = 'desc';
            if(column === 'name' || column === 'sales') currentSort.dir = 'asc';
        }

        document.querySelectorAll('.sort-icon').forEach(i => i.className = 'fas fa-sort sort-icon');
        const th = document.querySelector(`th[onclick="sortTable('${column}')"] i`);
        if(th) th.className = `fas fa-sort-${currentSort.dir === 'asc' ? 'up' : 'down'} sort-active sort-icon`;

        bodies.sort((a, b) => {
            let valA = a.getAttribute(`data-${column}`);
            let valB = b.getAttribute(`data-${column}`);
            if (column !== 'name' && column !== 'sales') {
                valA = parseFloat(valA); valB = parseFloat(valB);
            }
            if (valA < valB) return currentSort.dir === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.dir === 'asc' ? 1 : -1;
            return 0;
        });

        bodies.forEach(body => table.appendChild(body));
    }
</script>
{% endblock %}