{% extends "base.html" %}

{% block title %}Duyệt Chào Giá (v2) | Titan OS{% endblock %}

{% block extra_css %}
<style>
    /* --- CUSTOM LAYOUT FOR APPROVAL --- */
    .table-approval { 
        border: 1px solid var(--border-color); width: 100%; 
    }
    .table-approval th { 
        position: sticky; top: 0; z-index: 10;
        background-color: var(--input-bg) !important; 
        color: var(--secondary) !important;
        font-weight: 700; font-size: 0.85rem; text-transform: uppercase;
        padding: 12px 8px; border-bottom: 2px solid var(--border-color);
        white-space: nowrap; text-align: center;
    }
    .table-approval td { 
        vertical-align: middle; font-size: 0.9rem; 
        border-bottom: 1px solid var(--border-color);
        padding: 10px 8px; color: var(--text-dark);
    }

    /* Status Colors & Logic */
    .quote-row { transition: background-color 0.2s; cursor: pointer; }
    .quote-row:hover td { background-color: var(--input-bg) !important; }
    
    .status-pass { border-left: 5px solid var(--success) !important; }
    .status-fail { border-left: 5px solid var(--danger) !important; }
    .status-pending { border-left: 5px solid var(--warning) !important; }
    
    .ratio-alert { color: var(--danger); font-weight: 800; }
    .bg-highlight { background-color: rgba(5, 205, 153, 0.2) !important; transition: background-color 1s; }
    .row-selected td { background-color: var(--input-bg) !important; font-weight: 700; color: var(--primary); }

    /* Columns */
    .col-ratio { width: 80px; text-align: right; }
    .col-nvkd { width: 120px; text-align: center; }
    .col-gt { width: 120px; text-align: right; font-weight: 700; }
    .col-result { max-width: 250px; }
    .col-nguoi-lap { color: var(--secondary); font-size: 0.85rem; }

    /* Action Box */
    .action-box { display: flex; justify-content: center; gap: 5px; }
    .status-badge-action { 
        background: var(--input-bg); color: var(--secondary); 
        padding: 4px 8px; border-radius: 8px; font-size: 0.75rem; 
    }

    /* Modal Styles */
    .modal-header { background-color: var(--input-bg); border-bottom: 1px solid var(--border-color); }
    .modal-title { color: var(--text-dark); font-weight: 700; }
    .modal-body { background-color: var(--card-bg); color: var(--text-dark); }
    .modal-footer { background-color: var(--card-bg); border-top: 1px solid var(--border-color); }

    /* Table Detail (Inside Modal) */
    .table-detail th { 
        background-color: var(--primary) !important; color: white !important; 
        font-weight: 600; font-size: 0.8rem; text-align: center;
    }
    .table-detail td { 
        color: var(--text-dark); vertical-align: middle; 
        border-bottom: 1px solid var(--border-color); 
    }

    /* Filter Inputs */
    .form-control { border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--text-dark); }
    .form-control:focus { background-color: var(--card-bg); border-color: var(--primary); }

    /* Mobile Responsive */
    @media (max-width: 992px) {
        .table-responsive { overflow-x: auto; }
        .col-nguoi-lap, .col-khach { display: none; } /* Ẩn bớt cột trên mobile */
    }
</style>
{% endblock %}

{% block page_title %}<i class="fas fa-certificate me-2"></i> PHÊ DUYỆT BÁO GIÁ{% endblock %}
{% block page_sub %}Chào mừng, <strong>{{ current_user.shortname }}</strong> ({{ current_user.usercode }}){% endblock %}

{% block header_actions %}
<a href="{{ url_for('index') }}" class="btn btn-back"><i class="fas fa-home me-2"></i>Portal</a>
<a href="{{ url_for('approval_bp.sales_order_approval_dashboard') }}" target="_blank" class="btn btn-success text-white shadow-sm">
    <i class="fas fa-file-invoice-dollar me-2"></i>Duyệt ĐH Bán
</a>
{% endblock %}

{% block content %}
    <div class="main-card mb-4">
        <div class="card-body-custom" style="padding: 20px;">
            <form method="POST" action="{{ url_for('approval_bp.quote_approval_dashboard') }}" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-muted text-uppercase">Từ Ngày</label>
                    <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted text-uppercase">Đến Ngày</label>
                    <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter me-2"></i> Lọc</button>
                </div>
                <div class="col-md-4 text-end">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" id="customSearchInput" class="form-control border-start-0 ps-0" placeholder="Tìm Mã BG, Khách hàng...">
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="main-card">
        <div class="card-header-custom">
            <span><i class="fas fa-list-ul me-2 text-primary"></i> DANH SÁCH CHÀO GIÁ CẦN DUYỆT</span>
        </div>
        <div class="card-body-custom p-0">
            <div class="table-responsive" style="max-height: 90vh;">
                <table id="approval-table" class="table table-hover table-approval mb-0"> 
                    <thead>
                        <tr>
                            <th class="col-ratio">Hệ số</th> 
                            <th>Mã BG</th>
                            <th>Ngày</th> 
                            <th class="col-khach text-start">Khách hàng</th>
                            <th class="col-nvkd">NVKD</th> 
                            <th class="col-nguoi-lap">TKKD</th> 
                            <th class="col-gt">Tổng GT</th> 
                            <th class="col-result text-start">KẾT QUẢ KIỂM TRA</th>
                            <th class="text-center" style="width: 100px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for quote in quotes %}
                        {% set result = quote.ApprovalResult %}
                        {% set status = result.Passed %}
                        {% set approver_id = result.ApproverRequired %}
                        {% set row_class = 'status-pass' if status else ('status-pending' if 'PENDING' in result.Reason else 'status-fail') %}
                        
                        <tr id="master-{{ quote.QuotationID }}" 
                            class="quote-row {% if not status %} {{ row_class }} {% endif %}"
                            onclick="showDetails('{{ quote.QuotationID }}', this)"
                            data-quotationno="{{ quote.QuotationNo }}"
                            data-objectid="{{ quote.ClientID | default('') }}"
                            data-ratio="{{ result.ApprovalRatio | safe }}"
                            data-nvkd="{{ quote.EmployeeID | default('') }}" 
                            data-quotation-id="{{ quote.QuotationID | default('') }}">
                            
                            <td class="text-end col-ratio">
                                <span class="fw-bold {% if result.ApprovalRatio < 138 %} ratio-alert {% endif %}">
                                    {{ result.ApprovalRatio }}
                                </span>
                            </td>
                            
                            <td class="fw-bold text-primary">{{ quote.QuotationNo }}</td>
                            
                            <td class="text-center">{{ quote.QuotationDate | format_date }}</td>
                            
                            <td class="col-khach text-start text-truncate" style="max-width: 200px;" title="{{ quote.ClientName }}">
                                {{ quote.ClientName | default('N/A') }}
                            </td>
                            
                            <td class="col-nvkd" id="salesman-cell-{{ quote.QuotationID }}">
                                {{ quote.NVKDName | default(quote.SalesManID) }}
                                <button class="btn btn-sm p-0 ms-1 text-muted" title="Đổi NVKD"
                                        onclick="event.stopPropagation(); openSalesmanModal('{{ quote.QuotationID }}', '{{ quote.QuotationNo }}', '{{ quote.SalesManID | default('') }}', '{{ quote.NVKDName | default('N/A') }}')">
                                    <i class="fas fa-pen-square"></i>
                                </button>
                            </td>
                            <td class="col-nguoi-lap text-center">{{ quote.SalesAdminName | default(quote.EmployeeID) }}</td> 
                            
                            <td class="text-end col-gt text-dark">{{ quote.SaleAmount | format_tr }}</td>
                            
                            <td class="col-result text-start small">
                                {{ result.Reason }}
                            </td>
                            
                            <td class="text-center">
                                <div class="action-box">
                                    {% if quote.NeedsCostOverride == 1 and not quote.HasCostOverrideData %}
                                        <button class="btn btn-warning btn-sm shadow-sm text-dark" onclick="event.stopPropagation(); openCostOverrideForm('{{ quote.QuotationID }}', '{{ quote.QuotationNo }}')">
                                            <i class="fas fa-coins"></i> Cost
                                        </button>
                                    {% elif status and current_user_code in approver_id %}
                                        <button class="btn btn-success btn-sm shadow-sm text-white" onclick="event.stopPropagation(); approveQuote(this)">
                                            <i class="fas fa-check"></i> Duyệt
                                        </button>
                                    {% else %}
                                        <span class="status-badge-action">Chờ xử lý</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i> Chi tiết Báo giá #<span id="quoteDetailNo"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="detail-container"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="costOverrideModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--warning);">
                    <h5 class="modal-title text-dark"><i class="fas fa-money-bill-wave me-2"></i> Bổ sung Giá nhập (Cost) #<span id="quoteNoDisplay"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="overrideQuoteId" value="">
                    <div id="costOverrideDetail" class="table-responsive"><p class="text-center text-muted">Đang tải...</p></div>
                    <div class="alert alert-info mt-3 small">*Lưu ý: Chỉ cần nhập giá trị ước lượng vào cột **Giá Cost (Nhập)**.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success text-white" id="saveCostOverrideBtn"><i class="fas fa-save me-1"></i> Lưu</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="salesmanUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--primary);">
                    <h5 class="modal-title text-white">Thay đổi NVKD</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Báo giá: <strong id="salesmanModalQuoteNo">...</strong></p>
                    <input type="hidden" id="salesmanModalQuoteID" value="">
                    
                    <div class="mb-3">
                        <label class="form-label">NVKD Hiện tại:</label>
                        <input type="text" id="currentSalesman" class="form-control" readonly disabled>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chọn NVKD Mới:</label>
                        <select id="newSalesmanSelect" class="form-select" required>
                            <option value="">-- Vui lòng chọn --</option>
                            {% for salesman in salesman_list %}
                                <option value="{{ salesman.USERCODE }}">{{ salesman.SHORTNAME }} ({{ salesman.USERCODE }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success text-white" id="saveSalesmanChangeBtn"><i class="fas fa-save me-1"></i> Lưu Thay đổi</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.js"></script>
    
    <script>
        let lastClickedRow = null;

        /**
         * HÀM ĐỊNH DẠNG SỐ AN TOÀN (SỬA LỖI NaN)
         * - Tự động loại bỏ dấu phẩy (,) có sẵn trong chuỗi từ server
         * - Chuyển đổi sang Float an toàn
         * - Trả về định dạng chuẩn Mỹ (1,234.56)
         */
        function formatNumberStandard(value) {
            // 1. Kiểm tra giá trị rỗng/null
            if (value === null || value === undefined || String(value).trim() === '') {
                return '0';
            }

            // 2. Chuyển về chuỗi và loại bỏ dấu phẩy (,) nếu có
            // Ví dụ: "1,200.00" -> "1200.00"
            const cleanValue = String(value).replace(/,/g, '');

            // 3. Parse sang số thực
            const num = parseFloat(cleanValue);

            // 4. Nếu vẫn lỗi NaN thì trả về 0
            if (isNaN(num)) return '0';

            // 5. Định dạng lại
            return new Intl.NumberFormat('en-US').format(num);
        }

        // --- RENDER DETAIL TABLE ---
        function renderDetailTable(details, container) {
            let tableHtml = '<div class="table-responsive p-3"><table class="table table-sm table-striped table-bordered small mb-0 table-detail">';
            tableHtml += '<thead><tr><th class="text-center">Mã hàng</th><th>Tên hàng</th><th class="text-end">SL</th><th class="text-end">Đơn giá</th><th class="text-end">Đơn giá QĐ</th><th class="text-end">Thành tiền</th><th>Ghi chú</th></tr></thead><tbody>';

            if (!details || details.length === 0) {
                tableHtml += '<tr><td colspan="7" class="text-center text-muted">Không có dữ liệu chi tiết.</td></tr>';
            } else {
                details.forEach(item => {
                    // 1. Lấy giá trị thô (Raw) để so sánh (Xóa dấu phẩy trước khi so sánh)
                    const rawDonGia = parseFloat(String(item.DonGia || 0).replace(/,/g, ''));
                    const rawDonGiaQD = parseFloat(String(item.DonGiaQuyDinh || 0).replace(/,/g, ''));

                    // 2. Logic tô màu: Nếu Giá bán < Giá quy định -> Màu đỏ
                    const price_ratio_color = (rawDonGia < rawDonGiaQD) ? 'text-danger fw-bold' : 'text-success';
                    
                    // 3. Render HTML dùng hàm formatNumberStandard đã sửa
                    tableHtml += `<tr>
                        <td class="text-center font-monospace">${item.MaHang || ''}</td>
                        <td>${item.TenHang || '—'}</td>
                        <td class="text-end">${formatNumberStandard(item.SoLuong)}</td>
                        <td class="text-end">${formatNumberStandard(item.DonGia)}</td>
                        <td class="text-end ${price_ratio_color}">${formatNumberStandard(item.DonGiaQuyDinh)}</td>
                        <td class="text-end fw-bold">${formatNumberStandard(item.ThanhTien)}</td>
                        <td>${item.Notes || ''}</td>
                    </tr>`;
                });
            }
            tableHtml += '</tbody></table></div>';
            container.innerHTML = tableHtml;
        }

        function showDetails(quoteId, rowElement) {
             const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
             const container = document.getElementById('detail-container');
             const quoteNo = $(rowElement).data('quotationno');
             
             $('#quoteDetailNo').text(quoteNo); 
             container.innerHTML = '<p class="p-3 text-center"><i class="fas fa-spinner fa-spin me-2"></i> Đang tải chi tiết...</p>';
             detailModal.show();
             
             if(lastClickedRow) $(lastClickedRow).removeClass('row-selected');
             $(rowElement).addClass('row-selected');
             lastClickedRow = rowElement;

             fetch(`/api/get_quote_details/${quoteId}`)
                .then(r => r.json())
                .then(details => { 
                     if (details.error) throw new Error(details.error); 
                     renderDetailTable(details, container); 
                 })
                .catch(e => {
                    console.error(e);
                    container.innerHTML = `<p class="text-danger text-center p-3">LỖI KHI TẢI DỮ LIỆU: ${e.message}</p>`;
                });
        }
        
        function approveQuote(buttonElement) {
            const row = $(buttonElement).closest('tr');
            if (!confirm(`Xác nhận duyệt Chào Giá số ${row.data('quotationno')}?`)) return;
            
            buttonElement.disabled = true; $(buttonElement).html('<i class="fas fa-spinner fa-spin"></i>');
            fetch('/api/approve_quote', { 
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    quotation_no: row.data('quotationno'), quotation_id: row.data('quotation-id'), 
                    object_id: row.data('objectid'), employee_id: row.data('nvkd'), 
                    approval_ratio: parseFloat(row.data('ratio') || 0) 
                }) 
            })
            .then(r => r.json()).then(data => {
                if (data.success) { alert(data.message); $('#approval-table').DataTable().row(row).remove().draw(); } 
                else { alert('Lỗi: ' + data.message); buttonElement.disabled = false; $(buttonElement).html('<i class="fas fa-check"></i> Duyệt'); }
            }).catch(e => { alert('Lỗi kết nối'); buttonElement.disabled = false; });
        }
        
        // --- COST OVERRIDE LOGIC & SALESMAN UPDATE ---
        
        // Cost Override: Mở form
        function openCostOverrideForm(quoteId, quoteNo) {
             const modal = new bootstrap.Modal(document.getElementById('costOverrideModal'));
             $('#quoteNoDisplay').text(quoteNo); $('#overrideQuoteId').val(quoteId);
             $('#costOverrideDetail').html('<p class="text-center">Đang tải...</p>');
             modal.show();
             
             fetch(`/api/get_quote_cost_details/${quoteId}`).then(r => r.json()).then(details => {
                let html = '<table class="table table-sm table-bordered"><thead><tr><th>Mã</th><th>Tên</th><th>SL</th><th>Giá bán</th><th>Cost (Nhập)</th><th>Ghi chú</th></tr></thead><tbody>';
                details.forEach(i => { 
                    // Dùng hàm formatNumberStandard cho các giá trị hiển thị
                    html += `<tr data-tx-id="${i.TransactionID}">
                        <td>${i.InventoryID}</td>
                        <td>${i.InventoryName}</td>
                        <td>${i.QuoQuantity}</td>
                        <td>${formatNumberStandard(i.UnitPrice)}</td>
                        <td><input class="form-control form-control-sm cost-input" value="${formatNumberStandard(i.Cost)}" onfocus="this.select()"></td>
                        <td><input class="form-control form-control-sm note-input" value="${i.NOTE||''}"></td>
                    </tr>`; 
                });
                html += '</tbody></table>'; $('#costOverrideDetail').html(html);
             });
        }
        
        // Cost Override: Lưu
        $('#saveCostOverrideBtn').on('click', function() {
             const updates = [];
             $('#costOverrideDetail tbody tr').each(function() {
                 // Clean dấu phẩy trước khi parse float để lưu
                 const rawCostVal = $(this).find('.cost-input').val().replace(/,/g, '');
                 const cost = parseFloat(rawCostVal || 0);
                 const note = $(this).find('.note-input').val();
                 
                 // Chỉ đẩy lên nếu có dữ liệu
                 if(cost >= 0 || note) {
                     updates.push({ transaction_id: $(this).data('tx-id'), cost: cost, note: note });
                 }
             });
             
             if(!updates.length) return alert('Không có thay đổi.');
             
             fetch('/api/save_quote_cost_override', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ quote_id: $('#overrideQuoteId').val(), updates: updates }) })
             .then(r => r.json()).then(res => { if(res.success) { alert('Thành công!'); window.location.reload(); } else alert(res.message); });
        });

        $(document).ready(function() {
            // DataTables Config
            const table = $('#approval-table').DataTable({
                "paging": true, "pageLength": 25, "searching": true, "ordering": true, "info": true, 
                "scrollY": "65vh", "scrollCollapse": true, 
                "dom": 'rt<"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>', 
                "order": [[1, 'asc']], 
                "language": { "zeroRecords": "Không tìm thấy.", "info": "Hiển thị _START_ đến _END_ của _TOTAL_", "paginate": { "next": ">", "previous": "<" } }
            });

            // Custom Search Box Logic
            $('#customSearchInput').on('keyup', function() { table.search(this.value).draw(); });
            
            // Logic Salesman Update Modal
            let salesmanUpdateModalInstance = null;
            window.openSalesmanModal = function(quoteId, quoteNo, currentSalesmanId, currentSalesmanName) {
                if (!salesmanUpdateModalInstance) salesmanUpdateModalInstance = new bootstrap.Modal(document.getElementById('salesmanUpdateModal'));
                $('#salesmanModalQuoteNo').text(quoteNo); $('#salesmanModalQuoteID').val(quoteId);
                const displayName = (currentSalesmanName && currentSalesmanName !== 'N/A') ? `${currentSalesmanName} (${currentSalesmanId})` : currentSalesmanId;
                $('#currentSalesman').val(displayName); $('#newSalesmanSelect').val('');
                salesmanUpdateModalInstance.show();
            }

            $('#saveSalesmanChangeBtn').on('click', function() {
                const button = $(this);
                const quoteId = $('#salesmanModalQuoteID').val();
                const newSalesmanId = $('#newSalesmanSelect').val();
                
                if (!newSalesmanId) return alert('Vui lòng chọn NVKD mới.');

                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang lưu...');

                fetch('/api/quote/update_salesman', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quotation_id: quoteId, new_salesman_id: newSalesmanId })
                })
                .then(r => r.json()).then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.reload(); // Reload để cập nhật lại bảng
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(e => { alert('Lỗi kết nối: ' + e.message); })
                .finally(() => { button.prop('disabled', false).html('<i class="fas fa-save me-1"></i> Lưu Thay đổi'); });
            });
        });
    </script>
{% endblock %}