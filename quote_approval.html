<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Duyệt Chào Giá (v2)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE STYLES --- */
        :root {
            --primary: #4318FF;
            --primary-light: #F4F7FE;
            --secondary: #A3AED0;
            --text-dark: #2B3674;
            --danger: #E31A1A;
            --success: #05CD99;
            --warning: #FFB547;
            --bg-color: #F4F7FE;
            --card-radius: 20px;
            --input-bg: #F4F7FE;
        }
        
        body { 
            background-color: var(--bg-color); 
            font-family: 'Inter', sans-serif; 
            color: var(--text-dark); 
            overflow-y: auto !important;
        }
        .container-fluid { max-width: 98%; margin-top: 30px; }
        
        /* --- 2. HEADER & LAYOUT --- */
        .page-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin: 0; }
        
        .btn-action {
            padding: 10px 20px; border-radius: 14px; font-weight: 600; border: none;
            text-decoration: none; transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-back { background-color: white; color: var(--secondary); border: 1px solid #E0E5F2; }
        .btn-back:hover { color: var(--text-dark); background-color: #f8f9fa; }
        .btn-portal { background-color: var(--primary); color: white; }
        .btn-so-approve { background-color: var(--success); color: white; }

        /* --- 3. MAIN CARDS --- */
        .main-card {
            border: none; background: white; border-radius: var(--card-radius);
            box-shadow: 0px 18px 40px rgba(112, 144, 176, 0.12); margin-bottom: 25px; overflow: hidden;
        }
        .card-header-custom {
            background-color: white; color: var(--text-dark); font-weight: 700; font-size: 1.1rem;
            padding: 20px 25px; border-bottom: 1px solid var(--primary-light);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-header-custom i { font-size: 1.1rem; margin-right: 12px; color: var(--primary); }
        .card-body-custom { padding: 25px; background-color: white; }
        
        /* --- 4. FORMS & MODALS --- */
        .form-label { font-weight: 600; color: var(--text-dark); font-size: 0.9rem; margin-bottom: 8px; }
        .form-control, .form-select {
            border: none; background-color: var(--input-bg); border-radius: 16px;
            padding: 12px 15px; font-size: 0.95rem; color: var(--text-dark); box-shadow: none;
        }
        .form-control:focus, .form-select:focus { background-color: #fff; box-shadow: 0 0 0 2px var(--primary); }
        .btn-primary { background-color: var(--primary); border: none; border-radius: 12px; font-weight: 600; padding: 12px; }
        .btn-primary:hover { background-color: #3a14db; }
        .btn-success { background-color: var(--success); border-color: var(--success); border-radius: 12px; font-weight: 600;}
        .btn-secondary { background-color: #f0f0f0; color: var(--secondary); border: none; border-radius: 12px; font-weight: 600; }
        .btn-secondary:hover { background-color: #e0e0e0; color: var(--text-dark); }
        .btn-warning { background-color: var(--warning); border-color: var(--warning); border-radius: 12px; font-weight: 600;}
        
        .modal-content { border-radius: var(--card-radius); border: none; }
        .modal-header { background-color: var(--primary-light); border-bottom: none; }
        .modal-header .modal-title { color: var(--primary); font-weight: 700; }
        .modal-header.bg-warning .modal-title { color: var(--text-dark); }
        .modal-header.bg-primary .modal-title { color: white; }

        /* --- 5. DATA TABLES --- */
        .master-table-scroll { max-height: 90vh; overflow-y: auto; }
        .table-approval { border: 1px solid var(--primary-light); width: 100%; }
        .table-approval th { font-size: 0.95rem; }
        
        /* Thanh Lọc */
        #custom-filter-box { display: flex; align-items: center; justify-content: flex-end; gap: 10px; flex-grow: 1; }
        .custom-filter-wrapper { display: flex; align-items: center; gap: 10px; flex-grow: 1; justify-content: flex-end; }
        .custom-filter-wrapper label { font-weight: 600; color: var(--text-dark); font-size: 0.95rem; margin-bottom: 0; white-space: nowrap; }
        .custom-filter-wrapper input { width: 300px; border: none; background: var(--input-bg); border-radius: 16px; padding: 8px 15px; height: 40px; font-size: 0.95rem; }
        .btn-reset-filter { height: 40px; width: 40px; border-radius: 12px; font-size: 1rem; padding: 0; line-height: 1; }
        div.dataTables_wrapper div.dataTables_filter { display: none !important; }
        
        /* Style Status */
        .status-pass { border-left: 5px solid var(--success) !important; }
        .status-fail { border-left: 5px solid var(--danger) !important; }
        .status-pending { border-left: 5px solid var(--secondary) !important; }
        .ratio-alert { color: var(--danger); }
        .bg-highlight { background-color: #d4edda !important; transition: background-color 1s; }

        /* Responsive */
        @media (max-width: 768px) {
            .table-responsive { overflow-x: auto; }
            .table-approval th, .table-approval td { font-size: 0.75rem; padding: 6px 4px; }
            .card-header-custom { flex-direction: column; align-items: flex-start; }
            #custom-filter-box { margin-top: 10px; width: 100%; justify-content: flex-start; }
            .col-nguoi-lap { display: none; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="page-header">
            <h1 class="page-title"><i class="fas fa-certificate me-2"></i> PHÊ DUYỆT BÁO GIÁ</h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('index') }}" class="btn-action btn-portal"><i class="fas fa-home me-1"></i> Về Portal</a>
                <a href="{{ url_for('approval_bp.sales_order_approval_dashboard') }}" target="_blank" class="btn-action btn-so-approve"><i class="fas fa-file-invoice-dollar me-1"></i> Duyệt ĐH Bán</a>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <p style="font-size: 1.1em; font-weight: 500;" class="text-dark">
                Chào mừng, <strong>{{ current_user.shortname|default('Guest') }}</strong> ({{ current_user.usercode }}).
            </p>
            <p class="text-muted small">Mặc định hiển thị Báo giá trong 7 ngày. Click Mã BG để xem chi tiết.</p>
        </div>

        <div class="main-card mb-3">
            <div class="card-body-custom" style="padding: 20px 25px;">
                <form method="POST" action="{{ url_for('approval_bp.quote_approval_dashboard') }}" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="date_from" class="form-label">Từ Ngày BG</label>
                        <input type="date" name="date_from" id="date_from" class="form-control" value="{{ date_from }}">
                    </div>
                    <div class="col-md-3">
                        <label for="date_to" class="form-label">Đến Ngày BG</label>
                        <input type="date" name="date_to" id="date_to" class="form-control" value="{{ date_to }}">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-1"></i> Lọc Ngày</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="row g-3 align-items-start">
            <div class="col-lg-12">
                <div class="main-card master-panel">
                    <div class="card-header-custom">
                        <div><i class="fas fa-list-ul"></i> DANH SÁCH CHÀO GIÁ</div>
                        <div id="custom-filter-box"></div>
                    </div>
                    <div class="card-body-custom p-3">
                        <div class="table-responsive master-table-scroll">
                            <table id="approval-table" class="table table-hover table-approval"> 
                                <thead>
                                    <tr>
                                        <th class="col-hs">Hệ số <i class="fas fa-sort"></i></th> 
                                        <th class="col-ma">Mã BG <i class="fas fa-sort"></i></th>
                                        <th class="col-ngay">Ngày <i class="fas fa-sort"></i></th> 
                                        <th class="col-khach">Khách hàng <i class="fas fa-sort"></i></th>
                                        <th class="col-nvkd">NVKD <i class="fas fa-sort"></i></th> 
                                        <th class="col-nguoi-lap">TKKD <i class="fas fa-sort"></i></th> 
                                        <th class="col-gt">Tổng GT <i class="fas fa-sort"></i></th> 
                                        <th class="col-result">KẾT QUẢ KIỂM TRA <i class="fas fa-sort"></i></th>
                                        <th class="action-cell">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for quote in quotes %}
                                    {% set result = quote.ApprovalResult %}
                                    {% set status = result.Passed %}
                                    {% set approver_id = result.ApproverRequired %}
                                    {% set row_class = 'status-pass' if status else ('status-pending' if 'PENDING' in result.Reason else 'status-fail') %}
                                    
                                    <tr id="master-{{ quote.QuotationID }}" 
                                        class="quote-row {% if not status %} {{ row_class }} {% endif %}"
                                        onclick="showDetails('{{ quote.QuotationID }}', this)"
                                        data-quotationno="{{ quote.QuotationNo }}"
                                        data-objectid="{{ quote.ClientID | default('') }}"
                                        data-ratio="{{ result.ApprovalRatio | safe }}"
                                        data-nvkd="{{ quote.EmployeeID | default('') }}" 
                                        data-quotation-id="{{ quote.QuotationID | default('') }}">
                                        
                                        <td class="text-end col-ratio">
                                            <span class="fw-bold {% if result.ApprovalRatio < 138 %} ratio-alert {% endif %}">
                                                {{ result.ApprovalRatio }}
                                            </span>
                                        </td>
                                        
                                        <td>{{ quote.QuotationNo }}</td>
                                        
                                        <td>
                                            {% if quote.QuotationDate %}
                                                {{ quote.QuotationDate.strftime('%d/%m') }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        
                                        <td>{{ quote.ClientName | default('N/A') }}</td>
                                        
                                        <td class="col-nvkd" id="salesman-cell-{{ quote.QuotationID }}">
                                            {{ quote.NVKDName | default(quote.SalesManID) }}
                                            <button class="btn btn-xs btn-outline-primary p-0 px-1" style="font-size: 0.65rem;"
                                                    onclick="event.stopPropagation(); openSalesmanModal('{{ quote.QuotationID }}', '{{ quote.QuotationNo }}', '{{ quote.SalesManID | default('') }}', '{{ quote.NVKDName | default('N/A') }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                        <td class="col-nguoi-lap">{{ quote.SalesAdminName | default(quote.EmployeeID) }}</td> 
                                        
                                        <td class="text-end col-gt">{{ "{:,.0f}".format(quote.SaleAmount | float) }}</td>
                                        
                                        <td class="col-result">{{ result.Reason }}</td>
                                        
                                        <td class="action-cell">
                                            <div class="action-box mx-auto">
                                                {% if quote.NeedsCostOverride == 1 and not quote.HasCostOverrideData %}
                                                    <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); openCostOverrideForm('{{ quote.QuotationID }}', '{{ quote.QuotationNo }}')">
                                                        <i class="fas fa-money-bill-wave me-1"></i> Cost
                                                    </button>
                                                {% elif status and current_user_code in approver_id %}
                                                    <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); approveQuote(this)">
                                                        <i class="fas fa-check"></i> Duyệt
                                                    </button>
                                                {% else %}
                                                    <span class="status-badge-action text-muted small">Chờ xử lý</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i> Chi tiết Báo giá #<span id="quoteDetailNo"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="detail-container">
                        <p class="p-3 text-muted text-center">Đang tải chi tiết...</p>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="costOverrideModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark"><i class="fas fa-money-bill-wave me-2"></i> Bổ sung Giá nhập (Cost) #<span id="quoteNoDisplay"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="overrideQuoteId" value="">
                    <div id="costOverrideDetail" class="table-responsive"><p class="text-center text-muted">Đang tải...</p></div>
                    <div class="alert alert-info mt-3 small">*Lưu ý: Chỉ cần nhập giá trị ước lượng vào cột **Giá Cost (Nhập)**.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" id="saveCostOverrideBtn"><i class="fas fa-save me-1"></i> Lưu</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="salesmanUpdateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Thay đổi NVKD cho Báo giá</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Báo giá: <strong id="salesmanModalQuoteNo">...</strong></p>
                    <input type="hidden" id="salesmanModalQuoteID" value="">
                    
                    <div class="mb-3">
                        <label class="form-label">NVKD Hiện tại:</label>
                        <input type="text" id="currentSalesman" class="form-control" readonly disabled>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chọn NVKD Mới:</label>
                        <select id="newSalesmanSelect" class="form-select" required>
                            <option value="">-- Vui lòng chọn --</option>
                            {% for salesman in salesman_list %}
                                <option value="{{ salesman.USERCODE }}">{{ salesman.SHORTNAME }} ({{ salesman.USERCODE }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" id="saveSalesmanChangeBtn"><i class="fas fa-save me-1"></i> Lưu Thay đổi</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/dt-1.11.5/datatables.min.js"></script>
    
    <script>
        let lastClickedRow = null;

        function formatCurrency(value) {
            if (value === null || value === undefined || value === '—' || String(value).trim() === '') return '—';
            const num = parseFloat(String(value).replace(/,/g, '')); 
            if (isNaN(num)) return '—';
            return num.toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // --- RENDER DETAIL TABLE ---
        function renderDetailTable(details, container) {
            let tableHtml = '<div class="table-responsive p-3"><table class="table table-sm table-striped table-bordered small mb-0 table-detail">';
            tableHtml += '<thead><tr><th>Mã hàng</th><th>Tên hàng</th><th class="text-end">SL</th><th class="text-end">Đơn giá</th><th class="text-end">Đơn giá QĐ</th><th class="text-end">Thành tiền</th><th>Ghi chú</th></tr></thead><tbody>';

            details.forEach(item => {
                const DonGiaQuyDinh = formatCurrency(item.DonGiaQuyDinh || 0);
                const DonGia = formatCurrency(item.DonGia || 0);
                const price_ratio_color = (parseFloat(String(item.DonGia).replace(/,/g, '')) < parseFloat(String(item.DonGiaQuyDinh).replace(/,/g, ''))) ? 'text-danger' : 'text-success';
                
                tableHtml += `<tr><td class="text-center">${item.MaHang}</td><td>${item.TenHang || '—'}</td><td class="text-end">${formatCurrency(item.SoLuong)}</td><td class="text-end">${DonGia}</td><td class="text-end ${price_ratio_color}">${DonGiaQuyDinh}</td><td class="text-end fw-bold">${formatCurrency(item.ThanhTien)}</td><td>${item.Notes || '—'}</td></tr>`;
            });
            tableHtml += '</tbody></table></div>';
            container.innerHTML = tableHtml;
        }

        function showDetails(quoteId, rowElement) {
             const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
             const container = document.getElementById('detail-container');
             const quoteNo = $(rowElement).data('quotationno');
             
             $('#quoteDetailNo').text(quoteNo); 
             container.innerHTML = '<p class="p-3 text-center"><i class="fas fa-spinner fa-spin me-2"></i> Đang tải chi tiết...</p>';
             detailModal.show();
             
             if(lastClickedRow) $(lastClickedRow).removeClass('row-selected');
             $(rowElement).addClass('row-selected');
             lastClickedRow = rowElement;

             fetch(`/api/get_quote_details/${quoteId}`).then(r => r.json()).then(details => { 
                 if (details.error) throw new Error(details.error); 
                 renderDetailTable(details, container); 
             }).catch(e => container.innerHTML = `<p class="text-danger text-center">LỖI: ${e.message}</p>`);
        }
        
        function approveQuote(buttonElement) {
            const row = $(buttonElement).closest('tr');
            if (!confirm(`Xác nhận duyệt Chào Giá số ${row.data('quotationno')}?`)) return;
            
            buttonElement.disabled = true; $(buttonElement).html('<i class="fas fa-spinner fa-spin"></i>');
            fetch('/api/approve_quote', { 
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    quotation_no: row.data('quotationno'), quotation_id: row.data('quotation-id'), 
                    object_id: row.data('objectid'), employee_id: row.data('nvkd'), 
                    approval_ratio: parseFloat(row.data('ratio') || 0) 
                }) 
            })
            .then(r => r.json()).then(data => {
                if (data.success) { alert(data.message); $('#approval-table').DataTable().row(row).remove().draw(); } 
                else { alert('Lỗi: ' + data.message); buttonElement.disabled = false; $(buttonElement).html('<i class="fas fa-check"></i> Duyệt'); }
            }).catch(e => { alert('Lỗi kết nối'); buttonElement.disabled = false; });
        }
        
        // --- COST OVERRIDE ---
        function openCostOverrideForm(quoteId, quoteNo) {
             const modal = new bootstrap.Modal(document.getElementById('costOverrideModal'));
             $('#quoteNoDisplay').text(quoteNo); $('#overrideQuoteId').val(quoteId);
             $('#costOverrideDetail').html('<p class="text-center">Đang tải...</p>');
             modal.show();
             fetch(`/api/get_quote_cost_details/${quoteId}`).then(r => r.json()).then(details => {
                let html = '<table class="table table-sm table-bordered"><thead><tr><th>Mã</th><th>Tên</th><th>SL</th><th>Giá bán</th><th>Cost</th><th>Note</th></tr></thead><tbody>';
                details.forEach(i => { html += `<tr data-tx-id="${i.TransactionID}"><td>${i.InventoryID}</td><td>${i.InventoryName}</td><td>${i.QuoQuantity}</td><td>${formatCurrency(i.UnitPrice)}</td><td><input class="form-control form-control-sm cost-input" value="${formatCurrency(i.Cost)}"></td><td><input class="form-control form-control-sm note-input" value="${i.NOTE||''}"></td></tr>`; });
                html += '</tbody></table>'; $('#costOverrideDetail').html(html);
             });
        }
        
        $('#saveCostOverrideBtn').on('click', function() {
             const updates = [];
             $('#costOverrideDetail tbody tr').each(function() {
                 const cost = parseFloat($(this).find('.cost-input').val().replace(/,/g, '') || 0);
                 const note = $(this).find('.note-input').val();
                 if(cost > 0 || note) updates.push({ transaction_id: $(this).data('tx-id'), cost: cost, note: note });
             });
             if(!updates.length) return alert('Không có thay đổi.');
             fetch('/api/save_quote_cost_override', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ quote_id: $('#overrideQuoteId').val(), updates: updates }) })
             .then(r => r.json()).then(res => { if(res.success) { alert('Thành công!'); window.location.reload(); } else alert(res.message); });
        });

        // --- CẬP NHẬT LOGIC JS CHO NÚT LƯU SALESMAN ---
        $(document).ready(function() {
            // Init DataTables (Giữ nguyên)
            const table = $('#approval-table').DataTable({
                "paging": true, "pageLength": 25, "searching": true, "ordering": true, "info": true, 
                "scrollY": "70vh", "scrollCollapse": true, 
                "dom": 'rt<"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>', 
                "order": [[1, 'asc']], 
                "language": { "zeroRecords": "Không tìm thấy.", "info": "_START_ - _END_ / _TOTAL_", "paginate": { "next": "Sau", "previous": "Trước" } }
            });

            // Filter (Giữ nguyên)
            const customFilter = $('<div class="custom-filter-wrapper"><label>Lọc:</label><input type="search" id="customSearchInput" placeholder="Tìm kiếm..."></div>');
            customFilter.find('input').on('keyup', function() { table.search(this.value).draw(); });
            const resetBtn = $('<button class="btn btn-secondary btn-reset-filter"><i class="fas fa-undo-alt"></i></button>').on('click', function() { customFilter.find('input').val(''); table.search('').columns().search('').draw(); });
            $('#custom-filter-box').empty().append(customFilter).append(resetBtn);

            // Logic Update Salesman
            let salesmanUpdateModalInstance = null;
            
            window.openSalesmanModal = function(quoteId, quoteNo, currentSalesmanId, currentSalesmanName) {
                if (!salesmanUpdateModalInstance) salesmanUpdateModalInstance = new bootstrap.Modal(document.getElementById('salesmanUpdateModal'));
                $('#salesmanModalQuoteNo').text(quoteNo); $('#salesmanModalQuoteID').val(quoteId);
                const displayName = (currentSalesmanName && currentSalesmanName !== 'N/A') ? `${currentSalesmanName} (${currentSalesmanId})` : currentSalesmanId;
                $('#currentSalesman').val(displayName); $('#newSalesmanSelect').val('');
                salesmanUpdateModalInstance.show();
            }

            $('#saveSalesmanChangeBtn').on('click', function() {
                const button = $(this);
                const quoteId = $('#salesmanModalQuoteID').val();
                const newSalesmanId = $('#newSalesmanSelect').val();
                const currentQuoteNo = $('#salesmanModalQuoteNo').text(); 
                
                if (!newSalesmanId) return alert('Vui lòng chọn NVKD mới.');

                button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang lưu...');

                fetch('/api/quote/update_salesman', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quotation_id: quoteId, new_salesman_id: newSalesmanId })
                })
                .then(r => r.json()).then(data => {
                    if (data.success) {
                        alert(data.message);
                        
                        const resultData = data.data || {};
                        const newSalesmanText = $('#newSalesmanSelect option:selected').text();
                        let newSalesmanName = resultData.NewSalesmanName || newSalesmanText.split('(')[0].trim();
                        
                        // 1. CẬP NHẬT Ô NVKD TRÊN BẢNG
                        const cellId = 'salesman-cell-' + quoteId;
                        const cellNode = document.getElementById(cellId);
                        
                        if (cellNode) {
                            const newContent = `${newSalesmanName} 
                                <button class="btn btn-xs btn-outline-primary p-0 px-1" style="font-size: 0.65rem;"
                                        onclick="event.stopPropagation(); openSalesmanModal('${quoteId}', '${currentQuoteNo}', '${newSalesmanId}', '${newSalesmanName}')">
                                    <i class="fas fa-edit"></i>
                                </button>`;
                            
                            table.cell(cellNode).data(newContent);
                            const rowNode = $(cellNode).closest('tr');

                            // 2. CẬP NHẬT TRẠNG THÁI & LÝ DO
                            if (resultData.AnalysisMsg) {
                                const resultCell = rowNode.find('.col-result');
                                if (resultCell.length) table.cell(resultCell[0]).data(resultData.AnalysisMsg);
                            }

                            // 3. CẬP NHẬT MÀU DÒNG
                            rowNode.removeClass('status-pass status-fail status-pending');
                            if (resultData.NewStatus === true) rowNode.addClass('status-pass');
                            else rowNode.addClass('status-pending');

                            // 4. [QUAN TRỌNG] CẬP NHẬT NÚT HÀNH ĐỘNG (ACTION BUTTON)
                            // Tìm ô chứa nút hành động (.action-cell hoặc div .action-box)
                            const actionBox = rowNode.find('.action-box'); 
                            
                            if (resultData.NewStatus === true) {
                                // Nếu Trạng thái mới là Pass -> Hiện nút DUYỆT XANH
                                actionBox.html(`
                                    <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); approveQuote(this)">
                                        <i class="fas fa-check"></i> Duyệt
                                    </button>
                                `);
                            } else {
                                // Nếu không Pass -> Hiện chữ Chờ xử lý
                                actionBox.html(`
                                    <span class="status-badge-action text-muted small">Chờ xử lý</span>
                                `);
                            }

                            // 5. CẬP NHẬT DATA ATTRIBUTE
                            rowNode.attr('data-nvkd', newSalesmanId);
                            rowNode.data('nvkd', newSalesmanId);

                            table.draw(false);
                            rowNode.addClass('bg-highlight');
                            setTimeout(() => rowNode.removeClass('bg-highlight'), 1500);
                        }
                        salesmanUpdateModalInstance.hide();
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(e => { alert('Lỗi kết nối: ' + e.message); })
                .finally(() => { button.prop('disabled', false).html('<i class="fas fa-save me-1"></i> Lưu Thay đổi'); });
            });
        });
    </script>
</body>
</html>