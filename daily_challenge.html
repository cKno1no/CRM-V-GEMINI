{% extends "base.html" %}

{% block title %}ƒê·∫•u Tr∆∞·ªùng N3H{% endblock %}

{% block content %}
<div class="container py-5" x-data="dailyGame()" x-init="init()">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            
            <div class="text-center mb-5">
                <h1 class="fw-black text-primary display-4 mb-2"><i class="fas fa-meteor text-warning me-2"></i>ƒê·∫§U TR∆Ø·ªúNG N3H</h1>
                <p class="text-muted lead">SƒÉn XP m·ªói ng√†y - Nh·∫≠n th∆∞·ªüng li·ªÅn tay</p>
            </div>

            <div x-show="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">ƒêang k·∫øt n·ªëi ƒë·∫•u tr∆∞·ªùng...</p>
            </div>

            <div x-show="!loading && status === 'WAITING'" class="card shadow-lg border-0 rounded-4 text-center p-5 animate__animated animate__fadeIn">
                <div class="mb-4">
                    <img src="https://cdn3d.iconscout.com/3d/premium/thumb/clock-5206700-4352236.png" width="150" class="floating-anim">
                </div>
                <h3 class="fw-bold text-dark">Ch∆∞a ƒë·∫øn gi·ªù thi ƒë·∫•u!</h3>
                <p class="text-muted mb-4">
                    ƒê·∫•u tr∆∞·ªùng s·∫Ω m·ªü c·ª≠a v√†o l√∫c: <strong class="text-primary fs-5" x-text="nextSlot"></strong>
                </p>
                <div class="alert alert-light border border-primary border-opacity-25 rounded-3 d-inline-block px-4">
                    <i class="fas fa-info-circle me-2 text-primary"></i>H√£y quay l·∫°i sau nh√© S·∫øp!
                </div>
                <div class="mt-4">
                    <a href="/training" class="btn btn-outline-secondary rounded-pill px-4">V·ªÅ trang h·ªçc t·∫≠p</a>
                </div>
            </div>

            <div x-show="!loading && status === 'AVAILABLE'" class="card shadow-lg border-0 rounded-4 overflow-hidden animate__animated animate__fadeInUp">
                <div class="card-header bg-primary text-white p-4 d-flex justify-content-between align-items-center">
                    <span class="badge bg-white text-primary fw-bold px-3 py-2"><i class="fas fa-fire me-1"></i> ƒêANG DI·ªÑN RA</span>
                    <div class="h4 m-0 fw-bold font-monospace" x-text="formatTime(secondsLeft)"></div>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-light border-start border-4 border-warning fs-5 fw-medium text-dark mb-4" x-text="question"></div>
                    
                    <div class="mb-3">
                        <textarea class="form-control form-control-lg bg-light" rows="4" x-model="answer" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..."></textarea>
                    </div>
                    
                    <button @click="submit()" class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm" :disabled="submitting || !answer">
                        <span x-show="!submitting">G·ª≠i Tr·∫£ L·ªùi üöÄ</span>
                        <span x-show="submitting">ƒêang ch·∫•m ƒëi·ªÉm...</span>
                    </button>
                </div>
            </div>

            <div x-show="!loading && status === 'DONE'" class="card shadow-lg border-0 rounded-4 text-center p-5 animate__animated animate__zoomIn">
                <div class="mb-3 display-1">üéâ</div>
                <h2 class="fw-bold text-success">B·∫°n ƒë√£ ho√†n th√†nh phi√™n n√†y!</h2>
                <p class="text-muted">ƒêi·ªÉm s·ªë c·ªßa b·∫°n: <strong x-text="result ? result.score : '??'"></strong>/10</p>
                <a href="/training" class="btn btn-primary rounded-pill px-5 mt-3">Quay l·∫°i H·ªçc vi·ªán</a>
            </div>

        </div>
    </div>
</div>

<script>
    function dailyGame() {
        return {
            loading: true,
            status: '',
            nextSlot: '',
            question: '',
            sessionId: null,
            secondsLeft: 0,
            answer: '',
            submitting: false,
            result: null,
            timer: null,

            init() { this.checkStatus(); },

            checkStatus() {
                this.loading = true;
                fetch('/api/challenge/status').then(r => r.json()).then(data => {
                    this.status = data.status;
                    if (data.status === 'AVAILABLE') {
                        this.question = data.question;
                        this.sessionId = data.session_id;
                        this.secondsLeft = data.seconds_left;
                        this.startTimer();
                    } else if (data.status === 'WAITING') {
                        this.nextSlot = data.next_slot;
                    }
                    this.loading = false;
                });
            },

            startTimer() {
                if (this.timer) clearInterval(this.timer);
                this.timer = setInterval(() => {
                    this.secondsLeft--;
                    if (this.secondsLeft <= 0) {
                        this.status = 'WAITING';
                        this.nextSlot = 'Phi√™n sau'; // Ho·∫∑c reload l·∫°i ƒë·ªÉ l·∫•y gi·ªù m·ªõi
                        clearInterval(this.timer);
                        Swal.fire('H·∫øt gi·ªù!', 'Phi√™n ƒë·∫•u gi√° ƒë√£ k·∫øt th√∫c.', 'warning');
                    }
                }, 1000);
            },

            submit() {
                this.submitting = true;
                fetch('/api/challenge/submit', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({session_id: this.sessionId, answer: this.answer})
                }).then(r => r.json()).then(data => {
                    this.result = data;
                    this.status = 'DONE';
                    if (this.timer) clearInterval(this.timer);
                    if (data.score >= 5) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }).finally(() => this.submitting = false);
            },

            formatTime(s) {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m}:${sec < 10 ? '0'+sec : sec}`;
            }
        }
    }
</script>
<style>
    .floating-anim { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
</style>
{% endblock %}