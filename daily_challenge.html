{% extends "base.html" %}

{% block title %}ƒê·∫•u Tr∆∞·ªùng N3H | Titan OS{% endblock %}

{% block extra_css %}
<style>
    .floating-anim { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    
    .timer-badge {
        font-family: 'JetBrains Mono', monospace;
        letter-spacing: 1px;
        transition: all 0.3s ease;
    }
    .timer-danger {
        color: #ff4444 !important;
        animation: blink 1s infinite;
    }
    @keyframes blink { 50% { opacity: 0.5; } }
    
    .status-card {
        border-radius: 24px;
        border: 1px solid var(--border-color);
        background: var(--card-bg);
    }
    .alert-custom {
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5" x-data="dailyGame()" x-init="init()">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            
            <div class="text-center mb-5">
                <h1 class="fw-black text-primary display-4 mb-2">
                    <i class="fas fa-meteor text-warning me-2"></i>ƒê·∫§U TR∆Ø·ªúNG N3H
                </h1>
                <p class="text-muted lead">SƒÉn XP m·ªói ng√†y - Nh·∫≠n th∆∞·ªüng li·ªÅn tay</p>
            </div>

            <div x-show="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">ƒêang k·∫øt n·ªëi ƒë·∫•u tr∆∞·ªùng...</p>
            </div>

            <div x-show="!loading && status === 'WAITING'" class="card shadow-lg border-0 rounded-4 text-center p-5 animate__animated animate__fadeIn">
                <div class="mb-4">
                    <img src="https://cdn3d.iconscout.com/3d/premium/thumb/clock-5206700-4352236.png" width="150" class="floating-anim">
                </div>
                <h3 class="fw-bold text-dark">Ch∆∞a ƒë·∫øn gi·ªù thi ƒë·∫•u!</h3>
                <p class="text-muted mb-4">
                    ƒê·∫•u tr∆∞·ªùng s·∫Ω m·ªü c·ª≠a v√†o l√∫c: <strong class="text-primary fs-5" x-text="nextSlot"></strong>
                </p>
                <div class="alert alert-light border border-primary border-opacity-25 rounded-3 d-inline-block px-4">
                    <i class="fas fa-info-circle me-2 text-primary"></i>H√£y quay l·∫°i sau nh√© S·∫øp!
                </div>
                <div class="mt-4">
                    <a href="/" class="btn btn-outline-secondary rounded-pill px-4">V·ªÅ trang ch·ªß</a>
                </div>
            </div>

            <div x-show="!loading && status === 'AVAILABLE'" class="card shadow-lg border-0 rounded-4 overflow-hidden animate__animated animate__fadeInUp">
                <div class="card-header bg-primary text-white p-4 d-flex justify-content-between align-items-center">
                    <span class="badge bg-white text-primary fw-bold px-3 py-2">
                        <i class="fas fa-fire me-1"></i> ƒêANG DI·ªÑN RA
                    </span>
                    <div class="h4 m-0 fw-bold timer-badge" :class="secondsLeft < 60 ? 'timer-danger' : ''">
                        <i class="fas fa-clock me-2"></i><span x-text="formatTime(secondsLeft)">15:00</span>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-custom border-start border-4 border-primary bg-light fs-5 fw-bold text-dark mb-4 shadow-sm">
                        <i class="fas fa-question-circle me-2 text-primary"></i>
                        <span x-text="question"></span>
                    </div>
                    
                    <div class="options-list mb-4" x-show="options && (options.A || options.B || options.C || options.D)">
                        <p class="text-secondary small fw-bold mb-2 uppercase"><i class="fas fa-list-ul me-2"></i>Th√¥ng tin b·ªï tr·ª£ / C√¢u h·ªèi ph·ª•:</p>
                        <div class="d-flex flex-column gap-2">
                            <template x-if="options.A">
                                <div class="p-3 rounded-3 border bg-white d-flex align-items-start animate__animated animate__fadeInLeft">
                                    <b class="text-primary me-2">A.</b> <span class="text-dark" x-text="options.A"></span>
                                </div>
                            </template>
                            <template x-if="options.B">
                                <div class="p-3 rounded-3 border bg-white d-flex align-items-start animate__animated animate__fadeInLeft" style="animation-delay: 0.1s">
                                    <b class="text-primary me-2">B.</b> <span class="text-dark" x-text="options.B"></span>
                                </div>
                            </template>
                            <template x-if="options.C">
                                <div class="p-3 rounded-3 border bg-white d-flex align-items-start animate__animated animate__fadeInLeft" style="animation-delay: 0.2s">
                                    <b class="text-primary me-2">C.</b> <span class="text-dark" x-text="options.C"></span>
                                </div>
                            </template>
                            <template x-if="options.D">
                                <div class="p-3 rounded-3 border bg-white d-flex align-items-start animate__animated animate__fadeInLeft" style="animation-delay: 0.3s">
                                    <b class="text-primary me-2">D.</b> <span class="text-dark" x-text="options.D"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold text-primary">
                            <i class="fas fa-pen-fancy me-2"></i>B√†i l√†m c·ªßa s·∫øp:
                        </label>
                        <textarea class="form-control form-control-lg border-2 shadow-sm" rows="6" 
                                x-model="answer" 
                                placeholder="D·ª±a v√†o c√°c g·ª£i √Ω tr√™n, s·∫øp h√£y nh·∫≠p c√¢u tr·∫£ l·ªùi chi ti·∫øt t·∫°i ƒë√¢y..."></textarea>
                        <div class="text-end mt-1">
                            <small class="text-muted" x-text="'ƒê·ªô d√†i: ' + answer.length + ' k√Ω t·ª±'"></small>
                        </div>
                    </div>
                    
                    <button @click="submit()" class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow text-uppercase" 
                            :disabled="submitting || answer.trim().length < 10">
                        <span x-show="!submitting">N·ªôp b√†i h·ªá th·ªëng <i class="fas fa-paper-plane ms-2"></i></span>
                        <span x-show="submitting"><i class="fas fa-spinner fa-spin me-2"></i>ƒêang g·ª≠i b√†i...</span>
                    </button>
                </div>
            </div>

            <div x-show="!loading && status === 'SUBMITTED'" class="card shadow-lg border-0 rounded-4 text-center p-5 animate__animated animate__zoomIn status-card">
                <div class="mb-4">
                    <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_9n6mxtis.json" 
                                   background="transparent" speed="1" style="width: 200px; height: 200px; margin: auto;" loop autoplay></lottie-player>
                </div>
                <h3 class="fw-bold text-primary">B√†i l√†m ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n!</h3>
                <div class="alert alert-info border-0 shadow-sm mt-3 text-start">
                    <i class="fas fa-info-circle me-2"></i>
                    AI s·∫Ω b·∫Øt ƒë·∫ßu ch·∫•m ƒëi·ªÉm v√† g·ª≠i th√¥ng b√°o k·∫øt qu·∫£ v√†o h√≤m th∆∞ sau khi <b>k·∫øt th√∫c th·ªùi gian thi (15 ph√∫t)</b>. S·∫øp h√£y y√™n t√¢m ngh·ªâ ng∆°i nh√©!
                </div>
                <div class="mt-4">
                    <a href="/" class="btn btn-primary rounded-pill px-5">Quay l·∫°i Dashboard</a>
                </div>
            </div>

            <div x-show="!loading && status === 'DONE'" class="card shadow-lg border-0 rounded-4 text-center p-5 animate__animated animate__zoomIn">
                <div class="mb-3 display-1">üéâ</div>
                <h2 class="fw-bold text-success">Phi√™n n√†y s·∫øp ƒë√£ ho√†n th√†nh!</h2>
                <p class="text-muted">K·∫øt qu·∫£ ghi nh·∫≠n: <strong class="fs-4 text-primary" x-text="score"></strong>/10</p>
                <div class="p-3 bg-light rounded-3 mb-4">
                    <small class="text-secondary italic" x-text="feedback"></small>
                </div>
                <a href="/" class="btn btn-primary rounded-pill px-5">V·ªÅ trang ch·ªß</a>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function dailyGame() {
        return {
            loading: true,
            status: 'WAITING',
            nextSlot: '',
            question: '',
            options: { A: '', B: '', C: '', D: '' },
            sessionId: null,
            secondsLeft: 900, // M·∫∑c ƒë·ªãnh 15 ph√∫t
            answer: '',
            submitting: false,
            score: 0,
            feedback: '',
            timer: null,

            init() { 
                this.checkStatus();
            },

            checkStatus() {
                this.loading = true;
                fetch('/api/challenge/status')
                    .then(r => r.json())
                    .then(data => {
                        this.status = data.status; // WAITING, AVAILABLE, SUBMITTED, DONE
                        if (data.status === 'AVAILABLE') {
                            this.question = data.question;
                            this.options = data.options || { A: '', B: '', C: '', D: '' };
                            this.sessionId = data.session_id;
                            this.secondsLeft = data.seconds_left || 900;
                            this.startTimer();
                        } else if (data.status === 'WAITING') {
                            this.nextSlot = data.next_slot;
                        } else if (data.status === 'DONE') {
                            this.score = data.score;
                            this.feedback = data.feedback;
                        }
                        this.loading = false;
                    })
                    .catch(err => {
                        console.error("L·ªói k·∫øt n·ªëi:", err);
                        this.status = 'WAITING';
                        this.nextSlot = 'L·ªói k·∫øt n·ªëi server';
                        this.loading = false;
                    });
            },

            startTimer() {
                if (this.timer) clearInterval(this.timer);
                this.timer = setInterval(() => {
                    if (this.secondsLeft <= 0) {
                        clearInterval(this.timer);
                        this.status = 'WAITING';
                        Swal.fire({
                            title: 'H·∫øt gi·ªù!',
                            text: 'Th·ªùi gian l√†m b√†i 15 ph√∫t ƒë√£ k·∫øt th√∫c.',
                            icon: 'error',
                            confirmButtonText: 'Quay l·∫°i'
                        }).then(() => window.location.reload());
                        return;
                    }
                    this.secondsLeft--;
                }, 1000);
            },

            async submit() {
                if (!this.answer.trim()) return;
                
                this.submitting = true;
                try {
                    const res = await fetch('/api/challenge/submit', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            answer: this.answer
                        })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        this.status = 'SUBMITTED'; // Chuy·ªÉn sang giao di·ªán ch·ªù AI ch·∫•m
                        if (this.timer) clearInterval(this.timer);
                        Swal.fire('Th√†nh c√¥ng!', data.msg, 'success');
                    } else {
                        Swal.fire('Th√¥ng b√°o', data.msg, 'warning');
                    }
                } catch (e) {
                    Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ g·ª≠i b√†i. Vui l√≤ng ki·ªÉm tra m·∫°ng.', 'error');
                } finally {
                    this.submitting = false;
                }
            },

            formatTime(s) {
                if (s < 0) return "00:00";
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            }
        }
    }
</script>
{% endblock %}