<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bảng Điều phối Giao vận (v2)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE STYLES (Đồng bộ nhaplieu_new) --- */
        :root {
            --primary: #4318FF;
            --primary-light: #F4F7FE;
            --secondary: #A3AED0;
            --text-dark: #2B3674;
            --danger: #E31A1A;
            --success: #05CD99;
            --warning: #FFB547;
            --bg-color: #F4F7FE;
            --card-radius: 20px;
            --input-bg: #F4F7FE;
        }
        
        body { 
            background-color: var(--bg-color); 
            font-family: 'Inter', sans-serif; 
            color: var(--text-dark); 
        }
        .container-fluid { max-width: 98%; margin-top: 30px; }

        /* --- 2. HEADER & TABS (Style mới) --- */
        .page-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); margin: 0; }
        
        .btn-back {
            background-color: white; color: var(--secondary); border: 1px solid #E0E5F2;
            padding: 10px 20px; border-radius: 14px; font-weight: 600; text-decoration: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: all 0.2s;
        }
        .btn-back:hover { color: var(--text-dark); background-color: #f8f9fa; }

        .nav-tabs {
            border-bottom: 1px solid #E0E5F2;
        }
        .nav-tabs .nav-link {
            font-weight: 600;
            color: var(--secondary);
            border: none;
            border-bottom: 2px solid transparent;
            padding: 10px 20px;
        }
        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            background: none;
        }

        /* --- 3. KANBAN BOARD (Style mới) --- */
        .kanban-board-container { 
            display: flex; width: 100%; overflow-x: auto; 
            gap: 15px; padding: 10px; min-height: 80vh; 
        }
        .kanban-column { 
            flex-shrink: 0; width: 280px; 
            background-color: var(--input-bg); /* Nền xám tím */
            border-radius: 12px; padding: 0; 
            display: flex; flex-direction: column; 
            max-height: 80vh;
        }
        .kanban-column-header { 
            font-weight: 700; font-size: 1rem; 
            padding: 12px; border-bottom: 2px solid transparent; 
            text-align: center; color: white;
            border-top-left-radius: 12px; 
            border-top-right-radius: 12px; 
        }
        
        /* Màu sắc cột (Style mới) */
        #POOL .kanban-column-header { background-color: var(--secondary); } 
        #URGENT .kanban-column-header { background-color: var(--danger); } 
        #WITHIN_WEEK .kanban-column-header { background-color: var(--warning); color: var(--text-dark); } 
        #COMPLETED .kanban-column-header { background-color: var(--success); } 
        #MONDAY .kanban-column-header, #TUESDAY .kanban-column-header, #WEDNESDAY .kanban-column-header,
        #THURSDAY .kanban-column-header, #FRIDAY .kanban-column-header, #SATURDAY .kanban-column-header {
            background-color: var(--primary);
        }

        .task-list { min-height: 100px; overflow-y: auto; flex-grow: 1; padding: 10px; }
        
        /* Style cho thẻ Card (delivery_card.html) */
        .delivery-card { 
            background-color: white; border-radius: 12px; 
            padding: 10px; margin-bottom: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border-left: 5px solid var(--primary); 
            font-size: 0.85rem; line-height: 1.4; 
            cursor: grab;
            transition: box-shadow 0.2s;
        }
        .delivery-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .delivery-card:active { cursor: grabbing; }
        
        .delivery-card.group-card {
            border-left-color: var(--success);
            background-color: #F0FFF9;
        }
        .delivery-card.no-drag { cursor: not-allowed; }
        .delivery-card.status-open { border-left-color: var(--secondary); }
        .delivery-card.status-dasoan { border-left-color: var(--warning); background-color: #FFF8E1; }
        .delivery-card.status-dagiao { border-left-color: var(--success); background-color: #F0FFF9; opacity: 0.8; }
        .delivery-card.overdue { border-left-color: var(--danger) !important; background-color: #FFF1F1; }
        
        .item-title { font-weight: 700; font-size: 0.9rem; color: var(--text-dark); }
        .item-customer { color: var(--primary); font-weight: 600; }
        .item-details { font-size: 0.8rem; color: var(--secondary); }
        
        /* Drag effect (Style mới) */
        .drag-over { background-color: var(--primary-light); border: 2px dashed var(--primary); }
        
        /* --- 4. TAB 2: THỰC THI (Style mới) --- */
        #dispatch-view .kanban-column-header { color: white; } /* Đảm bảo chữ trắng */
        
        /* TÙY CHỈNH QUAN TRỌNG: Cột co giãn full màn hình */
        .kanban-column.dispatch-column-kho {
            flex-basis: 25%; /* Cơ bản 25% */
            flex-grow: 1;    /* Cho phép giãn */
            flex-shrink: 1;  /* Cho phép co */
            width: auto;     /* Ghi đè width cứng */
            min-width: 250px; /* Đảm bảo không quá nhỏ */
        }

        #dispatch-view .form-control {
            border: none; background-color: white; border-radius: 16px;
            padding: 12px 15px; font-size: 0.95rem; color: var(--text-dark); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        #dispatch-view .delivery-card { cursor: pointer; }
        #dispatch-view .delivery-card.no-edit { cursor: not-allowed; }
        
        /* --- 5. MODALS (Style mới) --- */
        .modal-content { border-radius: var(--card-radius); border: none; }
        .modal-header { background-color: var(--primary-light); border-bottom: none; }
        .modal-header .modal-title { color: var(--primary); font-weight: 700; }
        .btn-status-dasoan { 
            background-color: var(--warning); color: var(--text-dark); 
            border: none; border-radius: 12px; font-weight: 600; 
        }
        .btn-status-dagiao { 
            background-color: var(--success); color: white;
            border: none; border-radius: 12px; font-weight: 600; 
        }
        .btn-secondary { 
            background-color: #f0f0f0; color: var(--secondary); 
            border: none; border-radius: 12px; font-weight: 600; 
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- HEADER (Style mới) -->
        <div class="page-header">
            <h1 class="page-title"><i class="fas fa-truck-loading me-2"></i> BẢNG ĐIỀU PHỐI GIAO VẬN</h1>
            <a href="{{ url_for('index') }}" class="btn-back"><i class="fas fa-arrow-left me-2"></i>Về Portal</a>
        </div>
        
        <!-- TABS (Style mới) -->
        <ul class="nav nav-tabs mb-3" id="deliveryTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="planner-tab" data-bs-toggle="tab" data-bs-target="#planner-view" type="button" role="tab">
                    <i class="fas fa-calendar-alt me-2"></i> 1. Lập Kế hoạch Tuần (Thư ký)
                </button>
            </li>
            {% if can_view_dispatch %} <li class="nav-item" role="presentation">
                <button class="nav-link" id="dispatch-tab" data-bs-toggle="tab" data-bs-target="#dispatch-view" type="button" role="tab">
                    <i class="fas fa-shipping-fast me-2"></i> 2. Thực thi Giao hàng (Kho)
                </button>
            </li>
            {% endif %}
        </ul>
        
        <!-- TAB CONTENT (HTML Giữ nguyên, CSS mới tự áp dụng) -->
        <div class="tab-content" id="deliveryTabsContent">
            
            <div class="tab-pane fade show active" id="planner-view" role="tabpanel">
                <div class="kanban-board-container" id="planner-board">
                    
                    <div class="kanban-column" id="POOL" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">
                            <i class="fas fa-inbox me-2"></i> BỂ CHỜ (POOL)
                        </div>
                        <div class="task-list" id="task-list-POOL">
                            <!-- JS Nạp thẻ vào đây -->
                        </div>
                    </div>
                    
                    <div class="kanban-column" id="URGENT" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">
                            <i class="fas fa-bolt me-2"></i> GIAO GẤP
                        </div>
                        <div class="task-list" id="task-list-URGENT"></div>
                    </div>
                    
                    <div class="kanban-column" id="WITHIN_WEEK" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">SẮP XẾP TRONG TUẦN</div>
                        <div class="task-list" id="task-list-WITHIN_WEEK"></div>
                    </div>
                    
                    <div class="kanban-column" id="MONDAY" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">THỨ 2</div>
                        <div class="task-list" id="task-list-MONDAY"></div>
                    </div>
                    <div class="kanban-column" id="TUESDAY" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">THỨ 3</div>
                        <div class="task-list" id="task-list-TUESDAY"></div>
                    </div>
                    <div class="kanban-column" id="WEDNESDAY" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">THỨ 4</div>
                        <div class="task-list" id="task-list-WEDNESDAY"></div>
                    </div>
                    <div class="kanban-column" id="THURSDAY" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">THỨ 5</div>
                        <div class="task-list" id="task-list-THURSDAY"></div>
                    </div>
                    <div class="kanban-column" id="FRIDAY" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">THỨ 6</div>
                        <div class="task-list" id="task-list-FRIDAY"></div>
                    </div>
                    <div class="kanban-column" id="SATURDAY" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <div class="kanban-column-header">THỨ 7</div>
                        <div class="task-list" id="task-list-SATURDAY"></div>
                    </div>
                    
                    <div class="kanban-column" id="COMPLETED" ondrop="false" ondragover="false"> 
                        <div class="kanban-column-header">
                            <i class="fas fa-check-circle me-2"></i> ĐÃ GIAO (7 NGÀY)
                        </div>
                        <div class="task-list" id="task-list-COMPLETED">
                            <!-- JS Nạp thẻ vào đây -->
                        </div>
                    </div>
                </div>
            </div>
            
            {% if can_view_dispatch %} 
            <div class="tab-pane fade" id="dispatch-view" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="text-dark fw-bold">Kế hoạch Giao hàng ({{ current_date_str }} - {{ current_weekday_str }})</h4>
                    <div class="col-md-4">
                        <input type="text" id="dispatchSearchInput" class="form-control" placeholder="Lọc nhanh theo Mã LXH, Tên KH, RefNo02...">
                    </div>
                </div>
                
                <div class="kanban-board-container" id="dispatch-board">
                
                    <div class="kanban-column dispatch-column-kho" id="col-hom-nay">
                        <div class="kanban-column-header bg-danger text-white">
                            <i class="fas fa-exclamation-circle me-2"></i> HÔM NAY PHẢI GIAO ({{ kho_hom_nay | length }})
                        </div>
                        <div class="task-list">
                            {% for item in kho_hom_nay %}
                                {% include 'delivery_card.html' %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="kanban-column dispatch-column-kho" id="col-sap-xep">
                        <div class="kanban-column-header" style="background-color: var(--warning); color: var(--text-dark);">
                            <i class="fas fa-random me-2"></i> SẮP XẾP TRONG TUẦN ({{ kho_sap_xep | length }})
                        </div>
                        <div class="task-list">
                            {% for item in kho_sap_xep %}
                                {% include 'delivery_card.html' %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="kanban-column dispatch-column-kho" id="col-trong-tuan">
                        <div class="kanban-column-header bg-primary text-white">
                            <i class="fas fa-calendar-day me-2"></i> TRONG TUẦN SẼ GIAO ({{ kho_trong_tuan | length }})
                        </div>
                        <div class="task-list">
                            {% for item in kho_trong_tuan %}
                                {% include 'delivery_card.html' %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="kanban-column dispatch-column-kho" id="col-da-giao">
                        <div class="kanban-column-header bg-success text-white">
                            <i class="fas fa-check-circle me-2"></i> ĐÃ GIAO (7 NGÀY) ({{ kho_da_giao | length }})
                        </div>
                        <div class="task-list">
                            {% for item in kho_da_giao %}
                                {% include 'delivery_card.html' %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %} 
        </div>
    </div>
    
    <!-- MODAL (Style mới) -->
    <div class="modal fade" id="confirmDeliveryModal" tabindex="-1" aria-labelledby="confirmDeliveryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeliveryModalLabel">Xác nhận Trạng thái Giao hàng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Lệnh Xuất Hàng: <strong id="modalVoucherNo" class="text-primary"></strong></h6>
                    <p>Khách hàng: <strong id="modalObjectName"></strong></p>
                    <input type="hidden" id="modalVoucherID" value="">
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Mã hàng</th>
                                    <th>Tên hàng</th>
                                    <th>Số lượng</th>
                                </tr>
                            </thead>
                            <tbody id="modalItemTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <div id="modal-action-buttons" {% if not can_edit_dispatch %}style="display: none;"{% endif %}> 
                        <button type="button" class="btn btn-status-dasoan" onclick="updateStatus('Da Soan')">
                            <i class="fas fa-box-open me-1"></i> Đã Soạn Hàng
                        </button>
                        <button type="button" class="btn btn-status-dagiao" onclick="updateStatus('Da Giao')">
                            <i class="fas fa-check-circle me-1"></i> Xác nhận ĐÃ GIAO
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<!-- ======================================================== -->
<!-- JAVASCRIPT (Đã cập nhật logic sort) -->
<!-- ======================================================== -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- DỮ LIỆU TỪ FLASK (CHO TAB 1) ---
    const groupedTasks = {{ grouped_tasks_json | tojson }};
    const ungroupedTasks = {{ ungrouped_tasks_json | tojson }}; // (Chứa phiếu 'Da Soan' + 'Da Giao')
    const todayStr = '{{ current_date_str }}';
    
    // --- BIẾN PHÂN QUYỀN ---
    const canEditPlanner = {{ can_edit_planner | tojson }};
    const canEditDispatch = {{ can_edit_dispatch | tojson }};
    
    // --- MODAL (Giữ nguyên) ---
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeliveryModal'));
    
    function openConfirmationModal(element) {
        if (!canEditDispatch && element.closest('#dispatch-view')) {
             return;
        }
        const voucherId = element.dataset.voucherId;
        const voucherNo = element.querySelector('.item-title').textContent.split('(')[0].trim();
        const objectName = element.querySelector('.item-customer').textContent;
        document.getElementById('modalVoucherID').value = voucherId;
        document.getElementById('modalVoucherNo').textContent = voucherNo;
        document.getElementById('modalObjectName').textContent = objectName;
        const itemTableBody = document.getElementById('modalItemTableBody');
        itemTableBody.innerHTML = '<tr><td colspan="3" class="text-center"><i class="fas fa-spinner fa-spin"></i> Đang tải...</td></tr>';
        
        fetch(`/api/delivery/get_items/${voucherId}`)
            .then(response => response.json())
            .then(data => {
                itemTableBody.innerHTML = ''; 
                if (data && data.length > 0) {
                    data.forEach(item => { itemTableBody.innerHTML += `<tr><td>${item.InventoryID}</td><td>${item.InventoryName}</td><td class="text-end">${item.ActualQuantity}</td></tr>`; });
                } else { itemTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Không tìm thấy chi tiết.</td></tr>'; }
            })
            .catch(e => { itemTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Lỗi: ${e.message}</td></tr>`; });
        confirmModal.show();
    }
    
    function updateStatus(newStatus) {
        if (!canEditDispatch) { alert('Bạn không có quyền thực hiện thao tác này.'); return; }
        const voucherId = document.getElementById('modalVoucherID').value;
        if (!voucherId) return;
        fetch('/api/delivery/set_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ voucher_id: voucherId, new_status: newStatus })
        })
        .then(response => response.json())
        .then(data => { if (data.success) { alert(`Đã cập nhật trạng thái: ${newStatus}`); confirmModal.hide(); location.reload(); } else { alert('Lỗi: ' + data.message); } })
        .catch(e => alert('Lỗi kết nối: ' + e.message));
    }

    // --- LOGIC KÉO THẢ (DRAG & DROP) (CHO TAB 1) ---
    function allowDrop(ev) { if (!canEditPlanner) return; ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
    document.querySelectorAll('#planner-board .kanban-column').forEach(col => { col.addEventListener('dragleave', (ev) => { ev.currentTarget.classList.remove('drag-over'); }); });

    function drag(ev) {
        if (!canEditPlanner) { ev.preventDefault(); return false; }
        ev.dataTransfer.setData("text/plain", ev.target.id);
        ev.dataTransfer.setData("voucher-id", ev.target.dataset.voucherId || "");
        ev.dataTransfer.setData("object-id", ev.target.dataset.objectId || "");
        ev.dataTransfer.setData("original-day", ev.target.dataset.originalDay || "POOL");
    }

    function drop(ev) {
        if (!canEditPlanner) return; ev.preventDefault(); ev.currentTarget.classList.remove('drag-over');
        const elementId = ev.dataTransfer.getData("text/plain");
        const voucherId = ev.dataTransfer.getData("voucher-id");
        const objectId = ev.dataTransfer.getData("object-id");
        const oldDay = ev.dataTransfer.getData("original-day");
        const targetColumn = ev.currentTarget;
        const newDay = targetColumn.id; 
        const draggedElement = document.getElementById(elementId);
        if (!draggedElement) return;
        savePlannedDay(voucherId, objectId, newDay, oldDay, draggedElement, targetColumn);
    }
    
    function savePlannedDay(voucherId, objectId, newDay, oldDay, element, targetColumn) {
        if (!canEditPlanner) return; 
        let payload = { new_day: newDay, old_day: oldDay };
        if (objectId) payload.object_id = objectId; else payload.voucher_id = voucherId;
        fetch('/api/delivery/set_day', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(response => response.json())
        .then(data => {
            if (data.success) { targetColumn.querySelector('.task-list').appendChild(element); element.dataset.originalDay = newDay; }
            else { alert('Lỗi khi lưu kế hoạch: ' + data.message); location.reload(); }
        }).catch(error => { alert('Lỗi kết nối API: ' + error.message); location.reload(); });
    }
    
    // --- HÀM TẠO THẺ (CARD) (CHO TAB 1) ---
    function formatCurrency(numStr) { const num = parseFloat(numStr || 0); return new Intl.NumberFormat('vi-VN').format(num); }

    function createDeliveryCard(item) {
        let status_class = `status-${item.DeliveryStatus.toLowerCase()}`;
        const item_date_str = item.EarliestRequestDate_str || '9999-12-31';
        const is_overdue = (item_date_str != '—' && item_date_str < todayStr) && (item.DeliveryStatus == 'Open');
        if (is_overdue) status_class += ' overdue';
        const draggable = canEditPlanner ? 'true' : 'false';
        const card_class = canEditPlanner ? '' : 'no-drag';
        const is_completed = item.DeliveryStatus == 'Da Giao';
        const plannedDateISO = item.Planned_Date_ISO || '9999-12-31';
        const actualDateISO = item.ActualDeliveryDate_ISO || '1900-01-01';

        // (YÊU CẦU) Hiển thị Ngày giao (Tab 1 và 2)
        let deliveryDateInfo = '';
        if (item.DeliveryStatus == 'Da Giao') {
             deliveryDateInfo = `<strong class"text-success" style="font-size: 0.85rem;"><i class="fas fa-check-circle me-1"></i> Đã Giao: ${item.ActualDeliveryDate_str}</strong><br>`;
        } else if (item.Planned_Day_Display) {
             deliveryDateInfo = `<strong class="text-primary" style="font-size: 0.85rem;"><i class="fas fa-calendar-check me-1"></i> Giao: ${item.Planned_Day_Display}</strong><br>`;
        }

        return `<div class="delivery-card ${status_class} ${card_class}" draggable="${is_completed ? 'false' : draggable}" ondragstart="drag(event)" 
                 id="lxh-${item.VoucherID}" data-voucher-id="${item.VoucherID}" data-original-day="${item.Planned_Day || 'POOL'}" 
                 data-planned-date="${plannedDateISO}" data-actual-delivery-date="${actualDateISO}">
                <div class="item-title">${item.VoucherNo} (${item.ItemCount} MH)</div>
                <div class="item-customer">${item.ObjectName}</div>
                <div class="item-details">
                    ${deliveryDateInfo}
                    Ngày LXH: ${item.VoucherDate_str} <br>
                    RefNo02: ${item.RefNo02 || '—'}
                    ${is_overdue ? `<br><strong class="text-danger">QUÁ HẠN (Y/C: ${item.EarliestRequestDate_str})</strong>` : ''}
                </div></div>`;
    }
    
    function createGroupCard(group) {
        let status_class = 'group-card'; 
        const item_date_str = group.EarliestRequestDate_str || '9999-12-31';
        const is_overdue = (item_date_str != '—' && item_date_str < todayStr);
        if (is_overdue) status_class += ' overdue';
        const draggable = canEditPlanner ? 'true' : 'false';
        const card_class = canEditPlanner ? '' : 'no-drag';
        const plannedDateISO = group.Planned_Date_ISO || '9999-12-31';

        let deliveryDateInfo = '';
        if (group.Planned_Day_Display) {
             deliveryDateInfo = `<strong class="text-primary" style="font-size: 0.85rem;"><i class="fas fa-calendar-check me-1"></i> Giao: ${group.Planned_Day_Display}</strong><br>`;
        }

        return `<div class="delivery-card ${status_class} ${card_class}" draggable="${draggable}" ondragstart="drag(event)" 
                 id="group-${group.ObjectID}-${group.Planned_Day}" data-object-id="${group.ObjectID}" data-original-day="${group.Planned_Day || 'POOL'}" data-planned-date="${plannedDateISO}">
                <div class="item-title">${group.ObjectName}</div>
                <div class="item-customer">(${group.LXH_Count} Lệnh Xuất Hàng)</div>
                <div class="item-details">
                    ${deliveryDateInfo}
                    Trạng thái: <strong>${group.Status_Summary}</strong><br>
                    Giá trị: ${formatCurrency(group.TotalValue)} <br>Y/C Giao sớm nhất: ${group.EarliestRequestDate_str} <br>
                    RefNo02: ${group.RefNo02_str || '—'}
                    ${is_overdue ? `<br><strong class="text-danger">CÓ PHIẾU QUÁ HẠN</strong>` : ''}
                </div></div>`;
    }

    // Nạp dữ liệu cho Tab 1
    function populatePlannerBoard() {
        document.querySelectorAll('#planner-board .task-list').forEach(list => { list.innerHTML = ''; });
        groupedTasks.forEach(group => {
            const plannedDay = group.Planned_Day || 'POOL'; 
            const column = document.getElementById(`task-list-${plannedDay}`);
            if (column) column.innerHTML += createGroupCard(group);
        });
        ungroupedTasks.forEach(item => {
            let plannedDay;
            if (item.DeliveryStatus == 'Da Giao') plannedDay = 'COMPLETED'; 
            else if (item.DeliveryStatus == 'Da Soan') plannedDay = item.Planned_Day || 'POOL';
            // Bỏ các phiếu 'Open' (vì đã gộp nhóm)
            
            if (plannedDay) {
                const column = document.getElementById(`task-list-${plannedDay}`);
                if (column) column.innerHTML += createDeliveryCard(item);
            }
        });
    }
    
    // Gán sự kiện cho Tab 2
    function populateDispatchBoard() {
        document.querySelectorAll('#dispatch-view .delivery-card').forEach(card => {
            card.addEventListener('click', function() { if (canEditDispatch) openConfirmationModal(this); });
            card.draggable = false; 
        });
    }

    // --- KHỞI CHẠY ---
    document.addEventListener('DOMContentLoaded', function() {
        populatePlannerBoard(); 
        populateDispatchBoard(); 
        
        $('#dispatchSearchInput').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('#dispatch-view .delivery-card').each(function() {
                if ($(this).text().toLowerCase().includes(searchTerm)) $(this).show(); else $(this).hide();
            });
        });

        // --- (YÊU CẦU MỚI) SẮP XẾP CÁC CỘT Ở TAB 2 ---
        function sortCardsInColumn(columnId, sortField, sortDir = 'asc') {
            const list = document.querySelector(`${columnId} .task-list`);
            if (!list) return;
            const cards = Array.from(list.querySelectorAll('.delivery-card'));
            
            cards.sort((a, b) => {
                const valA = a.dataset[sortField] || (sortDir === 'asc' ? '9999-12-31' : '1900-01-01');
                const valB = b.dataset[sortField] || (sortDir === 'asc' ? '9999-12-31' : '1900-01-01');
                
                if (sortDir === 'asc') {
                    return valA.localeCompare(valB); // ASC (Cũ -> Mới)
                } else {
                    return valB.localeCompare(valA); // DESC (Mới -> Cũ)
                }
            });
            
            cards.forEach(card => list.appendChild(card));
        }
        
        // Sort 3 cột chờ theo Ngày kế hoạch (Cũ lên trước)
        sortCardsInColumn('#col-hom-nay', 'plannedDate', 'asc');
        sortCardsInColumn('#col-sap-xep', 'plannedDate', 'asc');
        sortCardsInColumn('#col-trong-tuan', 'plannedDate', 'asc');
        
        // Sort cột Đã Giao theo Ngày thực tế (Mới nhất lên trước)
        sortCardsInColumn('#col-da-giao', 'actualDeliveryDate', 'desc');
    });
    
    // --- KHÓA IN ---
    document.addEventListener('keydown', function(e) { if ((e.ctrlKey || e.metaKey) && e.key === 'p') { e.preventDefault(); alert("Chức năng in đã bị khóa."); } }, true); 
    window.print = function() { alert("Chức năng in đã bị khóa."); };
    document.addEventListener('contextmenu', e => e.preventDefault()); 
</script>
</body>
</html>