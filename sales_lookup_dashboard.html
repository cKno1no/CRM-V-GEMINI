<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tra C·ª©u Th√¥ng Tin B√°n H√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* T√îNG M√ÄU V√Ä THI·∫æT K·∫æ ƒê∆Ø·ª¢C ƒê·ªíNG B·ªò H√ìA T·ª™ NH·∫¨P LI·ªÜU */
        body { background-color: #F8F9FA; color: #3C4043; font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1400px; margin-top: 30px; }
        .card-container { margin-bottom: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.1); padding: 15px; }
        
        /* HEADER V√Ä KHU V·ª∞C L·ªåC */
        h1 { font-weight: 700; color: #4285F4; border-bottom: 3px solid #4285F4; padding-bottom: 10px; margin-bottom: 25px; }
        .panel-heading { background-color: #3f90e9; color: white; padding: 10px 15px; margin: -15px -15px 15px -15px; border-top-left-radius: 8px; border-top-right-radius: 8px; font-size: 1.1em; font-weight: 600; }
        
        /* KHU V·ª∞C L·ªåC M√ÄU R√äU ƒê·∫¨M */
        #lookup-card .card-header { background-color: #346265 !important; color: white !important; font-size: 1.2rem; font-weight: 600; }
        .search-container { position: relative; }

        /* INPUT V√Ä DROPDOWN ƒê∆Ø·ª¢C THI·∫æT K·∫æ ƒê·∫∂C BI·ªÜT */
        .form-control-lg { height: 48px; }
        .search-results-dropdown { 
            width: 100%; 
            border-radius: 8px; 
            border: 1px solid #4285F4; /* Border xanh */
            outline: none;
            display: none;
            position: absolute;
            z-index: 1000;
            margin-top: 0px; 
        }
        .btn-lookup-custom { background-color: #3f90e9 !important; color: white; font-weight: 600; min-width: 100px; height: 48px; }
        
        /* B·∫¢NG */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th { background-color: #d6e8ff; color: #333; padding: 10px; text-align: left; border-bottom: 2px solid #3f90e9; font-weight: 600; }
        .data-table td { padding: 8px 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .data-table tbody tr:hover { background-color: #f8f9fa; }
        .admin-data-block { border-top: 2px dashed #007bff; padding-top: 15px; margin-top: 20px; }
        
        /* KHUNG HI·ªÇN TH·ªä ƒê√É CH·ªåN */
        .selected-display-box {
             background-color: #e3f2fd;
             border: 1px solid #90caf9;
             padding: 10px;
             border-radius: 4px;
             margin-top: 8px;
             font-size: 0.9rem;
             color: #1e88e5;
             font-weight: 500;
             min-height: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: #3f90e9;"><i class="bi bi-search"></i> Tra C·ª©u Th√¥ng Tin B√°n H√†ng</h1>

        <div class="card mb-4" id="lookup-card">
            <div class="card-header">Th√¥ng tin Tra c·ª©u</div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('sales_bp.sales_lookup_dashboard') }}">
                    <div class="row g-3 align-items-start">
                        
                        <div class="col-md-4 search-container">
                            <label class="form-label fw-bold text-dark">T√¨m theo M√£/T√™n M·∫∑t h√†ng</label>
                            <input type="text" id="inv_search_input" placeholder="G√µ M√£/T√™n M·∫∑t h√†ng..." class="form-control form-control-lg">
                            <small id="inv_status" class="form-text text-muted mb-1 d-block">Nh·∫≠p m√£/t√™n ƒë·ªÉ t√¨m ki·∫øm t·ª± ƒë·ªông (C√≥ th·ªÉ ch·ªçn nhi·ªÅu).</small>
                            <div id="inv_display_box" class="selected-display-box">{{ inventory_ids_display|default(inventory_ids)|default('') }}</div>
                            
                            <input type="hidden" name="inventory_ids" id="inv_ma_selected" value="{{ inventory_ids|default('') }}">
                            <input type="hidden" name="inventory_ids_display" id="inv_display_selected" value="{{ inventory_ids_display|default('') }}">
                            
                            <select id="inv_search_results" class="form-select search-results-dropdown" size="5" onchange="chonMatHang()" multiple></select>
                        </div>

                        <div class="col-md-4 search-container">
                            <label class="form-label fw-bold text-dark">T√¨m theo M√£/T√™n Kh√°ch h√†ng (T√πy ch·ªçn)</label>
                            <input type="text" id="kh_search_input" placeholder="G√µ M√£/T√™n Kh√°ch h√†ng..." class="form-control form-control-lg">
                            <small id="kh_status" class="form-text text-muted mb-1 d-block">Nh·∫≠p t√™n/m√£ ƒë·ªÉ t√¨m ki·∫øm.</small>
                            <div id="kh_display_box" class="selected-display-box">{{ object_id_display|default(object_id)|default('') }}</div>

                            <input type="hidden" name="object_id" id="kh_ma_selected" value="{{ object_id|default('') }}">
                            <input type="hidden" name="object_id_display" id="kh_display_selected" value="{{ object_id_display|default('') }}">

                            <select id="kh_search_results" class="form-select search-results-dropdown" size="5" onchange="chonKhachHang()"></select>
                        </div>
                        
                        <div class="col-md-4 d-flex align-items-center">
                            <button type="submit" class="btn btn-primary btn-lg btn-lookup-custom mt-3">üîç Tra c·ª©u</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        {% if results %}
            
            {% for item in results %}
            <div class="card-container">
                <div class="panel-heading">M·∫∑t h√†ng: {{ item.InventoryID }} - {{ item.InventoryName }}</div>
                
                <h4 style="margin-top: 0; color: #333;">1. T·ªìn kho v√† Gi√° Quy ƒë·ªãnh</h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="text-nowrap">T·ªìn kho (Ton)</th>
                            <th class="text-nowrap">Back Order (Con)</th>
                            <th class="text-nowrap">Gi√° B√°n Quy ƒë·ªãnh (SalePrice01)</th>
                            <th class="text-nowrap">Gi√° B√°n G·∫ßn nh·∫•t (H√≥a ƒë∆°n)</th>
                            <th class="text-nowrap">Gi√° Ch√†o G·∫ßn nh·∫•t (B√°o gi√°)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ item.Ton|int }}</td>
                            <td>{{ item.BackOrder|int }}</td>
                            <td>{{ "{:,.0f}".format(item.SalePrice01) }}</td>
                            <td>
                                {% if item.RecentSalePrice.SalePrice is string %}
                                    {{ item.RecentSalePrice.SalePrice }}
                                {% else %}
                                    {{ "{:,.0f}".format(item.RecentSalePrice.SalePrice) }} ({{ item.RecentSalePrice.InvoiceDate|default('N/A') }})
                                {% endif %}
                            </td>
                            <td>
                                {% if item.RecentQuotePrice.QuotePrice is string %}
                                    {{ item.RecentQuotePrice.QuotePrice }}
                                {% else %}
                                    {{ "{:,.0f}".format(item.RecentQuotePrice.QuotePrice) }} ({{ item.RecentQuotePrice.QuoteDate|default('N/A') }})
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>

                {% if is_admin %}
                <div class="admin-data-block">
                    <h4 style="color: #007bff;">[D·ªØ li·ªáu Admin] L·ªãch s·ª≠ Chi ti·∫øt</h4>

                    <div style="margin-top: 15px;">
                        <div class="panel-heading" style="background-color: #f7a030; margin: -15px; margin-bottom: 15px;">
                            ‚≠ê Top 5 Kh√°ch h√†ng c√≥ b√°o gi√° th√†nh c√¥ng (3 nƒÉm)
                        </div>
                        {% if item.Top5SuccessfulQuotes %}
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="text-nowrap">M√£ KH</th>
                                        <th>T√™n Kh√°ch h√†ng</th>
                                        <th>T·ªïng SL B√°o gi√°</th>
                                        <th>T·ªïng SL K·∫ø th·ª´a (DHB)</th>
                                        <th>ƒê∆°n gi√° TB Ch√†o</th>
                                        <th style="color: #832a00;">% GBQD</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for q in item.Top5SuccessfulQuotes %}
                                    <tr>
                                        <td>{{ q.ClientID }}</td>
                                        <td>{{ q.ClientName }}</td>
                                        <td>{{ q.TotalQuoteQuantity|int }}</td>
                                        <td style="font-weight: bold; color: #1e7e34;">{{ q.TotalSuccessQuantity|int }}</td>
                                        <td>{{ "{:,.0f}".format(q.AverageQuotePrice) }}</td>
                                        <td style="font-weight: bold; color: {% if q.PercentGBQD is string and q.PercentGBQD.startswith('-') %}#dc3545{% else %}#1e7e34{% endif %};">
                                            {{ q.PercentGBQD }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>Kh√¥ng c√≥ b√°o gi√° th√†nh c√¥ng n√†o trong 3 nƒÉm.</p>
                        {% endif %}
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <div class="panel-heading" style="background-color: #6c757d; margin: -15px; margin-bottom: 15px;">
                            üì¶ Top 10 Phi·∫øu Nh·∫≠p kho g·∫ßn nh·∫•t (V√†o kho Q4)
                        </div>
                        {% if item.Top10RecentReceipts %}
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>S·ªë Phi·∫øu</th>
                                        <th>Ng√†y Nh·∫≠p</th>
                                        <th>ƒê·ªëi t∆∞·ª£ng Nh·∫≠p</th>
                                        <th>SL Nh·∫≠p</th>
                                        <th>Gi√° Nh·∫≠p</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in item.Top10RecentReceipts %}
                                    <tr>
                                        <td class="text-nowrap">{{ r.VoucherNo }}</td>
                                        <td>{{ r.VoucherDate }}</td>
                                        <td>{{ r.CustomerName }} ({{ r.CustomerID }})</td>
                                        <td>{{ r.ReceiptQuantity|int }}</td>
                                        <td>{{ "{:,.0f}".format(r.ReceiptPrice) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>Kh√¥ng c√≥ phi·∫øu nh·∫≠p kho v√†o kho Q4 g·∫ßn ƒë√¢y.</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            
        {% elif request.method == 'POST' %}
            <p class="alert alert-warning">Kh√¥ng t√¨m th·∫•y m·∫∑t h√†ng n√†o ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán tra c·ª©u.</p>
        {% endif %}

    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    
    // --- KHAI B√ÅO BI·∫æN CHO MULTI-SELECT M·∫∂T H√ÄNG ---
    let selectedInvItems = {}; // { 'ID': 'Display Text' }
    
    // KH√îI PH·ª§C DANH S√ÅCH M·∫∂T H√ÄNG ƒê√É CH·ªåN V√ÄO JS OBJECT
    const invIdList = $('#inv_ma_selected').val().split(',');
    const invDisplayList = $('#inv_display_selected').val().split(',');
    
    if (invIdList.length > 0 && invIdList[0].trim() !== '') {
        invIdList.forEach((id, index) => {
            const trimmedId = id.trim();
            const displayName = invDisplayList[index] ? invDisplayList[index].trim() : trimmedId;
            selectedInvItems[trimmedId] = displayName;
        });
        // C·∫≠p nh·∫≠t √¥ hi·ªÉn th·ªã ban ƒë·∫ßu
        $('#inv_display_box').text(Object.values(selectedInvItems).join(', '));
    } else {
        $('#inv_display_box').text('Danh s√°ch r·ªóng');
    }
    
    // Kh√¥i ph·ª•c gi√° tr·ªã Kh√°ch h√†ng hi·ªÉn th·ªã
    if ($('#kh_display_selected').val()) {
         $('#kh_display_box').text($('#kh_display_selected').val());
         $('#kh_status').html('‚úÖ Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c ch·ªçn v√† x√°c nh·∫≠n.');
    }


    // H√†m debounce: Tr√¨ ho√£n vi·ªác th·ª±c thi h√†m
    function debounce(func, timeout = 300) {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }
    
    // H√†m c·∫≠p nh·∫≠t tr∆∞·ªùng ·∫©n
    function updateHiddenFields(idField, displayField, map) {
        const idList = Object.keys(map).join(',');
        const displayList = Object.values(map).join(', ');
        $(idField).val(idList);
        $(displayField).val(displayList);
    }
    
    // --- LOGIC T√åM KI·∫æM M·∫∂T H√ÄNG ---
    function timMatHang() {
        const term = $('#inv_search_input').val().trim();
        const statusMsg = $('#inv_status');
        const resultsDropdown = $('#inv_search_results');
        
        resultsDropdown.hide().empty();
        
        if (term.length < 2) {
            statusMsg.text('Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª±.');
            return;
        }
        
        statusMsg.text('ƒêang t√¨m ki·∫øm...');
        
        fetch(`/api/inventory/${term}`)
            .then(response => {
                if (!response.ok) throw new Error('L·ªói Server khi tra c·ª©u m·∫∑t h√†ng.');
                return response.json(); 
            })
            .then(data => {
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const isSelected = selectedInvItems[item.id] !== undefined ? 'selected' : '';
                        const option = `<option value="${item.id}" ${isSelected} data-text="${item.text}">${item.text}</option>`;
                        resultsDropdown.append(option);
                    });
                    
                    resultsDropdown.show();
                    resultsDropdown.attr('size', Math.min(data.length, 10)); 
                    statusMsg.text(`T√¨m th·∫•y ${data.length} k·∫øt qu·∫£. Vui l√≤ng ch·ªçn.`);
                } else {
                    statusMsg.text('Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.');
                }
            })
            .catch(error => {
                statusMsg.text(`L·ªói tra c·ª©u: ${error.message}`);
                console.error("Fetch Inventory Error:", error);
            });
    }

    // H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn t·ª´ dropdown M·∫∑t h√†ng (MULTI-SELECT LOGIC)
    window.chonMatHang = function() {
        const dropdown = $('#inv_search_results');
        const selectedOption = dropdown.find('option:selected');
        
        if (selectedOption.length) {
            selectedOption.each(function() {
                const id = $(this).val();
                const text = $(this).data('text');
                
                if (selectedInvItems[id]) {
                    // X√≥a
                    delete selectedInvItems[id];
                    $(this).removeAttr('selected');
                } else {
                    // Th√™m
                    selectedInvItems[id] = text;
                    $(this).attr('selected', 'selected');
                }
            });

            // C·∫¨P NH·∫¨T TR∆Ø·ªúNG ·∫®N V√Ä INPUT HI·ªÇN TH·ªä
            updateHiddenFields('#inv_ma_selected', '#inv_display_selected', selectedInvItems);
            $('#inv_display_box').text(Object.values(selectedInvItems).join(', '));
        }
    };
    
    // --- LOGIC T√åM KI·∫æM & CH·ªåN KH√ÅCH H√ÄNG (SINGLE SELECT) ---

    function timKhachHang() {
        const term = $('#kh_search_input').val().trim();
        const statusMsg = $('#kh_status');
        const resultsDropdown = $('#kh_search_results');
        
        resultsDropdown.hide().empty();
        
        if (term.length < 2) {
            statusMsg.text('Nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª±.');
            return;
        }

        statusMsg.text('ƒêang t√¨m ki·∫øm...');
        
        fetch(`/api/khachhang/${term}`)
            .then(response => {
                if (!response.ok) throw new Error('L·ªói Server khi tra c·ª©u kh√°ch h√†ng.');
                return response.json(); 
            })
            .then(data => {
                if (data && data.length > 0) {
                    data.forEach(kh => {
                        const option = `<option value="${kh.ID}" data-fullname="${kh.FullName}">${kh.FullName} (${kh.ID})</option>`;
                        resultsDropdown.append(option);
                    });
                    
                    resultsDropdown.show();
                    resultsDropdown.attr('size', Math.min(data.length, 5)); 
                    statusMsg.html(`T√¨m th·∫•y ${data.length} k·∫øt qu·∫£. Vui l√≤ng ch·ªçn.`);
                    
                } else {
                    statusMsg.text('Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o.');
                }
            })
            .catch(error => {
                statusMsg.text(`L·ªói tra c·ª©u: ${error.message}`);
                console.error("Fetch KH Error:", error);
            });
    }

    // H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng ch·ªçn t·ª´ dropdown Kh√°ch h√†ng (SINGLE SELECT LOGIC)
    window.chonKhachHang = function() {
        const dropdown = $('#kh_search_results');
        const selectedOption = dropdown.find('option:selected');
        
        if (selectedOption.length) {
            const id = selectedOption.val();
            const fullName = selectedOption.data('fullname');
            const displayText = fullName + ' (' + id + ')';
            
            // ·∫®n dropdown, ƒëi·ªÅn v√†o input
            dropdown.hide();
            $('#kh_ma_selected').val(id); // M√£ ID th·ª±c t·∫ø
            $('#kh_display_selected').val(displayText); // T√™n hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß (ƒê·ªÉ ph·ª•c h·ªìi)
            $('#kh_search_input').val(displayText); // √î input hi·ªÉn th·ªã
            $('#kh_display_box').text(displayText); // √î hi·ªÉn th·ªã ƒë√£ ch·ªçn
            $('#kh_status').html('‚úÖ Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c ch·ªçn v√† x√°c nh·∫≠n.');
        }
    };
    
    $('form').on('submit', function(e) {
    // 1. L∆ØU D·ªÆ LI·ªÜU ƒê√É CH·ªåN V√ÄO TR∆Ø·ªúNG ·∫®N (Logic n√†y ƒë√£ c√≥)
    
    // 2. X√ìA N·ªòI DUNG C·ª¶A √î INPUT HI·ªÇN TH·ªä 
    $('#inv_search_input').val(''); // X√≥a n·ªôi dung √¥ g√µ M√£ m·∫∑t h√†ng
    $('#kh_search_input').val(''); // X√≥a n·ªôi dung √¥ g√µ M√£ kh√°ch h√†ng
    
    // 3. X√ìA D·ªÆ LI·ªÜU T·∫†M TH·ªúI TRONG JS OBJECT
    // ƒê√¢y l√† n∆°i b·∫°n c·∫ßn l√†m s·∫°ch selectedInvItems ƒë·ªÉ chu·∫©n b·ªã cho l·∫ßn tra c·ª©u m·ªõi
    
    // NOTE: Ch√∫ng ta KH√îNG x√≥a c√°c tr∆∞·ªùng ·∫©n (`#inv_ma_selected`) v√¨ ƒë√≥ l√† d·ªØ li·ªáu ƒëang g·ª≠i ƒëi.
    // Ch√∫ng ta ch·ªâ x√≥a c√°c √¥ hi·ªÉn th·ªã (input) v√† reset JS state.
});
    // --- ƒêƒÇNG K√ù S·ª∞ KI·ªÜN CH√çNH ---
    $('#inv_search_input').on('input', debounce(timMatHang, 300));
    $('#kh_search_input').on('input', debounce(timKhachHang, 300));
    
    // NgƒÉn ch·∫∑n submit form khi nh·∫•n ENTER v√† x·ª≠ l√Ω focus
    $('#inv_search_input, #kh_search_input').on('keydown', function(e) {
         if (e.key === 'Enter') {
             e.preventDefault();
         }
    });

    $('#inv_search_input, #kh_search_input').on('focus', function() {
        if (this.id === 'inv_search_input' && Object.keys(selectedInvItems).length > 0) {
            // Khi focus v√†o √¥ m·∫∑t h√†ng ƒë√£ c√≥ l·ª±a ch·ªçn, hi·ªÉn th·ªã l·∫°i dropdown
            timMatHang(); 
        } else if (this.id === 'kh_search_input' && this.value.length > 0) {
            // Khi focus v√†o √¥ KH ƒë√£ c√≥ gi√° tr·ªã, t√¨m ki·∫øm l·∫°i
            timKhachHang();
        }
    });
    
    // X√ìA DROPDOWN KHI CLICK RA NGO√ÄI
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.search-container').length) {
            $('#kh_search_results').hide();
            $('#inv_search_results').hide();
        }
    });

});
</script>
</body>
</html>